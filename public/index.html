<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QUEST DETECTIVE - PERPLEXITY EDITION</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    body{font-family:Inter,sans-serif;margin:0;padding:0;background:#222;color:#e0e0e0;overflow:hidden;font-size:14px;}
    #map{height:100vh;width:100%;position:relative;z-index:1;}
    .quest-panel{position:absolute;top:15px;left:15px;background:rgba(18,22,33,.98);border:1px solid #333;width:360px;padding:20px;border-radius:12px;z-index:1000;box-shadow:0 0 30px rgba(0,0,0,.6);max-height:90vh;overflow-y:auto;}
    .quest-title{font-size:20px;font-weight:800;color:#00ff88;margin-bottom:15px;text-transform:uppercase;border-bottom:2px solid #00ff88;padding-bottom:10px;display:flex;justify-content:space-between;align-items:center;}
    .quest-label{font-size:11px;font-weight:700;color:#888;text-transform:uppercase;margin-bottom:5px;display:block;}
    .quest-input-group{margin-bottom:15px;background:#1a1e29;padding:10px;border-radius:8px;border:1px solid #333;}
    input[type="file"]{width:100%;font-size:11px;color:#ccc;border:none;background:transparent;}
    .api-input{width:100%;padding:8px;background:#000;border:1px solid #00ff88;color:#00ff88;font-family:monospace;border-radius:4px;box-sizing:border-box;margin-bottom:5px;font-size:11px;}
    .quest-search{width:100%;padding:10px;background:#111;border:1px solid #444;color:#fff;border-radius:6px;box-sizing:border-box;}
    .quest-search:focus{outline:none;border-color:#00ff88;}
    .quest-btn{width:100%;padding:10px;margin-top:5px;background:#111;border:1px solid #00ff88;color:#00ff88;font-weight:800;cursor:pointer;text-transform:uppercase;transition:.3s;border-radius:6px;}
    .quest-btn:hover{background:#00ff88;color:#000;}
    .btn-scan{border-color:#ff00cc;color:#ff00cc;}
    .btn-scan:hover{background:#ff00cc;color:#fff;}
    .mic-btn{background:transparent;border:1px solid #444;color:#aaa;width:30px;height:30px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.3s;}
    .mic-btn.active{border-color:#00ff88;color:#00ff88;box-shadow:0 0 10px rgba(0,255,136,.4);animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.1)}100%{transform:scale(1)}}
    #aiFeedback{font-size:11px;color:#aaa;margin-top:5px;min-height:15px;text-align:center;}
    .ai-response-box{background:rgba(0,255,136,.05);border:1px solid #00ff88;padding:10px;margin-top:10px;border-radius:6px;font-size:12px;line-height:1.5;color:#fff;display:none;}
    .stats-container{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:15px;}
    .stat-box{background:#111;border:1px solid #333;border-radius:6px;padding:8px;text-align:center;}
    .stat-val{font-size:16px;font-weight:800;color:#fff;}
    .stat-name{font-size:9px;color:#666;text-transform:uppercase;}
    .loading-bar{height:3px;background:#333;width:100%;display:none;margin-top:5px;}
    .loading-fill{height:100%;background:#00ff88;width:0;transition:width .3s;}
    .leaflet-popup-content-wrapper{background:rgba(18,22,33,.98);color:#eee;border:1px solid #444;border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.8);}
    .leaflet-popup-content{width:280px !important;margin:15px;}
    .leaflet-popup-tip{background:#1a1e29;}
    .popup-header{font-weight:900;color:#00ff88;font-size:15px;text-align:center;margin-bottom:12px;border-bottom:1px solid #444;padding-bottom:8px;}
    .popup-row{display:flex;justify-content:space-between;align-items:center;font-size:12px;margin-bottom:6px;border-bottom:1px dashed #333;padding-bottom:4px;}
    .popup-label{color:#888;font-weight:600;}
    .popup-value{font-weight:700;color:#fff;text-align:right;}
    .val-high{color:#00ff88;}
    .val-low{color:#ff3333;}
    .val-warn{color:#ffcc00;}
    ::-webkit-scrollbar{width:6px;}
    ::-webkit-scrollbar-track{background:#111;}
    ::-webkit-scrollbar-thumb{background:#333;border-radius:3px;}
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="quest-panel">
    <div class="quest-title">
      QUEST DETECTIVE AI
      <button class="mic-btn" id="micBtn" onclick="toggleVoice()" title="Microfon">üéô</button>
    </div>

    <div class="quest-input-group" style="border-color:#00ff88;">
      <span class="quest-label" style="color:#00ff88;">PERPLEXITY API KEY</span>
      <input type="password" id="apiKey" class="api-input" placeholder="pplx-xxxxxxxxxxxxxxxxxxxx"/>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">1. LOCKERE CSV</span>
      <input type="file" onchange="handleFileUpload(this,'lockers')"/>
      <div id="statusLockers" style="font-size:10px;color:#555;margin-top:2px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">2. VOLUME AWB CSV</span>
      <input type="file" onchange="handleFileUpload(this,'awb')"/>
      <div id="statusAWB" style="font-size:10px;color:#555;margin-top:2px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">3. POPULA»öIE CSV</span>
      <input type="file" onchange="handleFileUpload(this,'pop')"/>
      <div id="statusPop" style="font-size:10px;color:#555;margin-top:2px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">ASISTENT INTELIGENT</span>
      <input type="text" id="searchInput" class="quest-search" placeholder="Ex: AnalizeazƒÉ Baicului..." onkeyup="handleInput(event)"/>
      <div id="aiFeedback">Sistem gata.</div>
      <div id="aiResponse" class="ai-response-box"></div>
    </div>

    <button onclick="startAutoScanWrapper()" class="quest-btn btn-scan">AUTO-SCAN ZONƒÇ</button>
    <button onclick="toggleAddMode()" id="addModeBtn" class="quest-btn">ANALIZƒÇ PUNCTUALƒÇ</button>
    <button onclick="resetAll()" class="quest-btn" style="border-color:#ff3333;color:#ff3333;">RESET</button>

    <div class="stats-container">
      <div class="stat-box"><div class="stat-val" id="totalVal">0</div><div class="stat-name">Lockere</div></div>
      <div class="stat-box"><div class="stat-val" style="color:#ff0033;" id="criticVal">0</div><div class="stat-name">Critic</div></div>
      <div class="stat-box"><div class="stat-val" style="color:#ffae00;" id="warnVal">0</div><div class="stat-name">Aten»õie</div></div>
      <div class="stat-box"><div class="stat-val" style="color:#00ff88;" id="okVal">0</div><div class="stat-name">Optim</div></div>
    </div>

    <div class="loading-bar" id="loadBar"><div class="loading-fill" id="loadFill"></div></div>
  </div>

<script>
/* ===========================
   1) CONFIGURARE HARTƒÇ
=========================== */
const map = L.map('map', { zoomControl: false }).setView([46.00, 25.00], 7);
L.control.zoom({ position: 'topright' }).addTo(map);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', { attribution: 'CARTO' }).addTo(map);

/* ===========================
   2) VARIABILE / CONSTANTE
=========================== */
let data = { lockers: [], awbJL: {}, awbJLM: {}, popJL: {} };
let detectedMonths = [];
let addMode = false;

const ANCHORS = ['kaufland','lidl','carrefour','auchan','mega','profi','mall','plaza','piata','residence','complex','gara','universitate','spital','market'];
const MONTHS = { ianuarie:0,februarie:1,martie:2,aprilie:3,mai:4,iunie:5,iulie:6,august:7,septembrie:8,octombrie:9,noiembrie:10,decembrie:11 };

const statusColors = {
  'Critic Urgent': '#d60000',
  'Critic Standard': '#e67e22',
  'Aten»õie': '#f1c40f',
  'Standard': '#27ae60'
};

const layers = {
  'Critic Urgent': L.layerGroup().addTo(map),
  'Critic Standard': L.layerGroup().addTo(map),
  'Aten»õie': L.layerGroup().addTo(map),
  'Standard': L.layerGroup().addTo(map),
  'Propuneri': L.layerGroup().addTo(map)
};

/* ===========================
   3) UTILS (CSV / NORMALIZƒÇRI)
=========================== */
function splitCSV(str){
  const res = [];
  let curr = '';
  let inQt = false;
  for(let i=0;i<str.length;i++){
    const c = str[i];
    if(c === '"'){ inQt = !inQt; continue; }
    if(c === ',' && !inQt){ res.push(curr.trim()); curr = ''; continue; }
    curr += c;
  }
  res.push(curr.trim());
  return res;
}

function norm(s){
  return s ? String(s).toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9 ]/g,' ')
    .replace(/\s+/g,' ')
    .trim() : '';
}

/* Cheie jude»õ canonicƒÉ, cu handling Bucure»ôti/Ilfov + sectoare */
function canonJudet(rawJudet, rawLocalitate=''){
  const j = norm(rawJudet);
  const loc = norm(rawLocalitate);

  // Bucure»ôti: Nominatim poate √Æntoarce "Bucure»ôti", "Municipiul Bucure»ôti", "Sector 1" etc.
  const looksLikeBuc = j.includes('bucuresti') || j.includes('bucharest') || loc.includes('sector ');
  const looksLikeIlf = j.includes('ilfov');

  // DacƒÉ fi»ôierul tƒÉu are "Bucuresti Ilfov" ca jude»õ agregat, cheia canonicƒÉ trebuie sƒÉ fie exact aia.
  if(looksLikeBuc || looksLikeIlf) return 'bucuresti ilfov';

  return j;
}

function makeJLKey(judetRaw, localitateRaw){
  const j = canonJudet(judetRaw, localitateRaw);
  const l = norm(localitateRaw);
  if(!j || !l) return '';
  return `${j}||${l}`;
}

function parseIntSafe(x){
  if(x === null || x === undefined) return NaN;
  const t = String(x).replace(/"/g,'').trim().replace(/,/g,'').replace(/\./g,'');
  const n = parseInt(t, 10);
  return isNaN(n) ? NaN : n;
}

/* ===========================
   4) UPLOAD HANDLER
=========================== */
function handleFileUpload(input, type){
  const file = input.files[0];
  if(!file) return;

  const r = new FileReader();
  r.onload = e => {
    const t = e.target.result;
    if(type === 'lockers') processLockers(t);
    if(type === 'awb') processAWB(t);
    if(type === 'pop') processPop(t);

    input.parentElement.style.borderColor = '#00ff88';
    document.getElementById('status' + type.charAt(0).toUpperCase() + type.slice(1)).innerText = '√éncƒÉrcat';
    speak('Fi»ôierul ' + type + ' a fost procesat.');
  };
  r.readAsText(file);
}

/* ===========================
   5) LOCKERS CSV
=========================== */
function processLockers(csv){
  Object.values(layers).forEach(g => g.clearLayers());
  data.lockers = [];
  const stats = {'Critic Urgent':0,'Critic Standard':0,'Aten»õie':0,'Standard':0};

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2) return;

  const h = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());

  detectedMonths = [];
  h.forEach((col, idx) => {
    const m = col.match(/([a-zA-Z]+)\s+(\d{4})/);
    if(m && !col.toLowerCase().includes('inactiv')){
      const mon = m[1].toLowerCase();
      const yr = parseInt(m[2],10);
      if(MONTHS.hasOwnProperty(mon)){
        detectedMonths.push({ name: col, idx, val: yr*12 + MONTHS[mon] });
      }
    }
  });
  detectedMonths.sort((a,b)=>a.val-b.val);

  const idxNov25 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2025') && !x.toLowerCase().includes('inactiv'));
  const idxNov24 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2024') && !x.toLowerCase().includes('inactiv'));

  const idx = {
    nume: h.indexOf('Locker Nume'),
    lat: h.indexOf('Latitudine'),
    lng: h.indexOf('Longitudine'),
    install: h.indexOf('Data instalare'),
    cap: h.indexOf('Capacitate locker'),
    addr: h.indexOf('Adresa'),
    model: h.indexOf('Model'),
    city: h.indexOf('Locker Oras'),
    inactiv: h.findIndex(x => x.toLowerCase().includes('inactiv'))
  };

  const getVal = (row,i) => i>-1 ? (row[i] ?? '').replace(/"/g,'').trim() : '';

  lines.slice(1).forEach(l => {
    const row = splitCSV(l);
    if(row.length < h.length) return;

    const lat = parseFloat(getVal(row, idx.lat));
    const lng = parseFloat(getVal(row, idx.lng));
    if(isNaN(lat) || isNaN(lng)) return;

    // Istoric (medie)
    let historyValues = [];
    detectedMonths.forEach(m => {
      const vStr = getVal(row, m.idx).replace(',', '.');
      const v = parseFloat(vStr);
      if(!isNaN(v)){
        historyValues.push(v > 1.5 && v <= 100 ? v : (v <= 1.5 ? v*100 : v));
      }
    });

    let sumHist = 0, countHist = 0;
    historyValues.forEach(v => { if(v>0){ sumHist += v; countHist++; } });
    const avgHist = countHist > 0 ? (sumHist / countHist) : 0;

    // Load nov
    let loadNov25 = 0, loadNov24 = 0;
    if(idxNov25>-1){
      const v = parseFloat(getVal(row, idxNov25).replace(',','.'));
      if(!isNaN(v)) loadNov25 = (v > 1.5 && v <= 100) ? v : (v <= 1.5 ? v*100 : v);
    }
    if(idxNov24>-1){
      const v = parseFloat(getVal(row, idxNov24).replace(',','.'));
      if(!isNaN(v)) loadNov24 = (v > 1.5 && v <= 100) ? v : (v <= 1.5 ? v*100 : v);
    }

    let trendStr = 'Stabil';
    if(loadNov25 > loadNov24 + 5) trendStr = 'Peste medie';
    else if(loadNov25 < loadNov24 - 5) trendStr = 'Sub medie';

    const daysOff = parseIntSafe(getVal(row, idx.inactiv)) || 0;
    const cleanInst = getVal(row, idx.install).split(' ')[0];

    let status = 'Standard';
    if(loadNov25 >= 95 || daysOff > 5) status = 'Critic Urgent';
    else if(loadNov25 >= 85) status = 'Critic Standard';
    else if(loadNov25 >= 75) status = 'Aten»õie';

    stats[status]++;

    const locker = {
      nume: getVal(row, idx.nume),
      lat, lng,
      loadNov25, loadNov24,
      avgHist,
      trend: trendStr,
      install: cleanInst,
      cap: getVal(row, idx.cap),
      model: getVal(row, idx.model),
      addr: getVal(row, idx.addr),
      city: getVal(row, idx.city),
      daysOff
    };
    data.lockers.push(locker);

    const m = L.circleMarker([lat,lng], {
      radius: 7,
      fillColor: statusColors[status],
      color: '#000',
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    });

    const popupContent = `
      <div class="popup-header">${locker.nume}</div>
      <div class="popup-row"><span class="popup-label">Loca»õie</span><span class="popup-value">${locker.city}</span></div>
      <div class="popup-row"><span class="popup-label">AdresƒÉ</span><span class="popup-value" style="font-size:10px;max-width:150px;">${locker.addr}</span></div>
      <div class="popup-row"><span class="popup-label">√éncƒÉrcare Nov 2025</span><span class="popup-value ${locker.loadNov25>=90?'val-low':'val-high'}">${locker.loadNov25.toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">Nov 2024</span><span class="popup-value">${locker.loadNov24.toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">Trend</span><span class="popup-value">${locker.trend}</span></div>
      <div class="popup-row"><span class="popup-label">Medie istoric</span><span class="popup-value">${locker.avgHist.toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">Capacitate</span><span class="popup-value">${locker.cap}</span></div>
      <div class="popup-row"><span class="popup-label">Inactivare</span><span class="popup-value">${locker.daysOff} zile</span></div>
      <div class="popup-row"><span class="popup-label">Instalare</span><span class="popup-value">${locker.install}</span></div>
      <div class="popup-row"><span class="popup-label">Model</span><span class="popup-value">${locker.model}</span></div>
    `;
    m.bindPopup(popupContent);
    layers[status].addLayer(m);
  });

  document.getElementById('totalVal').innerText = data.lockers.length;
  document.getElementById('criticVal').innerText = stats['Critic Urgent'];
  document.getElementById('warnVal').innerText = stats['Aten»õie'];
  document.getElementById('okVal').innerText = stats['Standard'];
  document.getElementById('statusLockers').innerText = `Actualizat: ${data.lockers.length} unitƒÉ»õi`;
}

/* ===========================
   6) AWB CSV (jude»õ + localitate)
=========================== */
function processAWB(csv){
  data.awbJL = {};
  data.awbJLM = {};

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){ document.getElementById('statusAWB').innerText = 'AWB: fi»ôier gol'; return; }

  const header = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const hNorm = header.map(norm);

  const idxMonth = hNorm.findIndex(x => x === 'month' || x.includes('month'));
  const idxJudet = hNorm.findIndex(x => x.includes('judet') && x.includes('destinatar'));
  const idxLoc   = hNorm.findIndex(x => x.includes('localitate') && x.includes('destinatar'));
  const idxTot   = hNorm.findIndex(x => x.includes('nr') && x.includes('total') && x.includes('awb'));

  if(idxJudet < 0 || idxLoc < 0 || idxTot < 0){
    document.getElementById('statusAWB').innerText = 'AWB: header neidentificat';
    return;
  }

  let ok = 0;
  for(const l of lines.slice(1)){
    const row = splitCSV(l);

    const monthRaw = idxMonth >= 0 ? (row[idxMonth] ?? '') : '';
    const judetRaw = (row[idxJudet] ?? '');
    const locRaw   = (row[idxLoc] ?? '');
    const totRaw   = (row[idxTot] ?? '');

    const month = String(monthRaw).replace(/"/g,'').trim(); // ex: "11"
    const judet = String(judetRaw).replace(/"/g,'').trim();
    const loc   = String(locRaw).replace(/"/g,'').trim();
    if(!judet || !loc) continue;

    const awb = parseIntSafe(totRaw);
    if(isNaN(awb) || awb < 0) continue;

    const jlKey = makeJLKey(judet, loc);
    if(!jlKey) continue;

    data.awbJL[jlKey] = (data.awbJL[jlKey] || 0) + awb;

    if(month){
      const mKey = norm(month);
      const jlmKey = `${mKey}||${jlKey}`;
      data.awbJLM[jlmKey] = (data.awbJLM[jlmKey] || 0) + awb;
    }
    ok++;
  }

  document.getElementById('statusAWB').innerText = `AWB OK: ${ok} r√¢nduri`;
}

/* ===========================
   7) POPULA»öIE CSV (jude»õ + localitate)
   AcceptƒÉ:
   - fie header: Judet,Localitate,Populatie
   - fie formatul "lipit" (ca √Æn exemplul tƒÉu), pe linie
=========================== */
function processPop(csv){
  data.popJL = {};

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){ document.getElementById('statusPop').innerText = 'POP: fi»ôier gol'; return; }

  const first = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const fNorm = first.map(norm);

  const hasHeader = fNorm.includes('judet') && (fNorm.includes('localitate') || fNorm.includes('localitatea')) && fNorm.join(' ').includes('pop');

  let ok = 0;

  if(hasHeader){
    const idxJ = fNorm.findIndex(x => x === 'judet' || x.includes('judet'));
    const idxL = fNorm.findIndex(x => x === 'localitate' || x.includes('localit'));
    const idxP = fNorm.findIndex(x => x.includes('pop'));

    for(const l of lines.slice(1)){
      const row = splitCSV(l);
      const judet = (row[idxJ] ?? '').replace(/"/g,'').trim();
      const loc   = (row[idxL] ?? '').replace(/"/g,'').trim();
      const pop   = parseIntSafe(row[idxP] ?? '');
      if(!judet || !loc || isNaN(pop)) continue;

      const key = makeJLKey(judet, loc);
      if(!key) continue;
      data.popJL[key] = Math.max(data.popJL[key] || 0, pop);
      ok++;
    }
  } else {
    // Fallback pentru fi»ôierul ‚Äúlipit‚Äù: JudetLocalitatePopulatie (cu spa»õii √Æn localitate)
    // Heuristic: primul token = jude»õ (ALBA, ARAD...), ultimul token numeric = popula»õie, restul = localitate.
    for(const l of lines.slice(1)){
      const line = l.replace(/"/g,'').trim();
      if(!line) continue;

      const parts = line.split(/\s+/);
      if(parts.length < 3) continue;

      const pop = parseIntSafe(parts[parts.length - 1]);
      if(isNaN(pop)) continue;

      const judet = parts[0];
      const loc = parts.slice(1, parts.length - 1).join(' ');
      const key = makeJLKey(judet, loc);
      if(!key) continue;

      data.popJL[key] = Math.max(data.popJL[key] || 0, pop);
      ok++;
    }
  }

  document.getElementById('statusPop').innerText = `POP OK: ${ok} r√¢nduri`;
}

/* ===========================
   8) LOOKUPS (AWB/POP)
=========================== */
function getAwbFor(judetName, localitateName){
  const key = makeJLKey(judetName, localitateName);
  return key && data.awbJL[key] ? data.awbJL[key] : 0;
}

function getPopFor(judetName, localitateName){
  const key = makeJLKey(judetName, localitateName);
  return key && data.popJL[key] ? data.popJL[key] : 0;
}

/* ===========================
   9) ANALIZƒÇ LOCALƒÇ (cu jude»õ)
=========================== */
function getDist(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const a = Math.sin((lat2-lat1)*Math.PI/360)**2 +
            Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
            Math.sin((lon2-lon1)*Math.PI/360)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function analyzeLocalData(lat, lng, cityName, judetName){
  const pop = judetName ? getPopFor(judetName, cityName) : 0;
  const awb = judetName ? getAwbFor(judetName, cityName) : 0;

  const neighbors = [];
  const anchors = [];

  data.lockers.forEach(l => {
    const d = getDist(lat, lng, l.lat, l.lng);
    if(d <= 500){
      neighbors.push({ name: l.nume, load: l.loadNov25, dist: d });
      const n = (l.nume || '').toLowerCase();
      ANCHORS.forEach(tag => { if(n.includes(tag) && !anchors.includes(tag)) anchors.push(tag); });
    }
  });

  return { pop, awb, neighbors, anchors, city: cityName, judet: judetName || '' };
}

/* ===========================
   10) PERPLEXITY API
=========================== */
async function askPerplexity(question, contextData=null){
  const apiKey = document.getElementById('apiKey').value.trim();
  if(!apiKey){ alert('Te rog introdu cheia API Perplexity (pplx-....)'); return; }

  const responseBox = document.getElementById('aiResponse');
  responseBox.style.display = 'block';
  responseBox.innerHTML = '<i>Perplexity analizeazƒÉ datele...</i>';

  let systemPrompt = 'E»ôti un expert logistic senior pentru re»õeaua easybox. Scopul tƒÉu este sƒÉ analizezi oportunitatea de expansiune sau optimizare. RƒÉspunde √Æn limba rom√¢nƒÉ, concis »ôi bazat strict pe date.';
  if(contextData){
    systemPrompt += `\nDATE REALE PENTRU LOCA»öIA: ${contextData.city} (${contextData.judet})`
      + `\n- Popula»õie estimatƒÉ: ${contextData.pop}`
      + `\n- Volum comenzi AWB: ${contextData.awb}`
      + `\n- Lockere existente √Æn 500m: ${JSON.stringify(contextData.neighbors)}`
      + `\n- Ancore comerciale apropiate: ${(contextData.anchors || []).join(', ')}`;
  }

  const messages = [
    { role: 'system', content: systemPrompt },
    { role: 'user', content: question }
  ];

  try{
    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method: 'POST',
      headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'sonar-pro',
        messages
      })
    });

    const json = await response.json();
    if(json.error) throw new Error(json.error.message);

    const rawText = json.choices[0].message.content;
    responseBox.innerHTML = marked.parse(rawText);

    const cleanText = rawText.replace(/\n/g,' ').split('.').slice(0,2).join('. ');
    speak(cleanText);
  } catch(e){
    console.error(e);
    responseBox.innerText = 'Eroare API Perplexity: ' + e.message;
    speak('A apƒÉrut o eroare la conectarea cu Perplexity.');
  }
}

/* ===========================
   11) VOICE
=========================== */
const synth = window.speechSynthesis;
let recognition = null;
let isListening = false;

function speak(text){
  if(!text) return;
  if(synth.speaking) synth.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ro-RO';
  synth.speak(utter);
  document.getElementById('aiFeedback').innerText = text;
}

function toggleVoice(){
  if(!('webkitSpeechRecognition' in window)){
    alert('NecesitƒÉ Chrome/Edge.');
    return;
  }
  if(isListening){ recognition.stop(); return; }

  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ro-RO';
  recognition.onstart = () => { isListening = true; document.getElementById('micBtn').classList.add('active'); };
  recognition.onend = () => { isListening = false; document.getElementById('micBtn').classList.remove('active'); };
  recognition.onresult = e => {
    const q = e.results[0][0].transcript;
    document.getElementById('searchInput').value = q;
    handleInput({ key: 'Enter', target: { value: q } }, true);
  };
  recognition.start();
}

function handleInput(e, fromVoice=false){
  if(e.key !== 'Enter' && !fromVoice) return;
  const q = document.getElementById('searchInput').value;
  if(q.toLowerCase().includes('scan')){
    const city = q.replace(/scaneaza|scaneazƒÉ|orasul|ora»ôul/gi,'').trim();
    runAutoScanWrapper(city);
  } else {
    askPerplexity(q);
  }
}

/* ===========================
   12) AUTO-SCAN / ADD MODE
=========================== */
async function runAutoScanWrapper(city){
  if(!city || city.length < 3) return;

  speak('Analizez ' + city + '...');
  document.getElementById('loadBar').style.display = 'block';

  try{
    const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=' + encodeURIComponent(city));
    const d = await r.json();
    if(!d.length){ speak('Loca»õie necunoscutƒÉ.'); document.getElementById('loadBar').style.display = 'none'; return; }

    const b = d[0].boundingbox;
    map.fitBounds([[b[0], b[2]], [b[1], b[3]]]);

    const centerLat = (parseFloat(b[0]) + parseFloat(b[1])) / 2;
    const centerLng = (parseFloat(b[2]) + parseFloat(b[3])) / 2;

    // Ca sƒÉ ob»õinem jude»õul (»ôi sƒÉ corelƒÉm corect AWB/POP), facem reverse pe centru:
    const rr = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=' + centerLat + '&lon=' + centerLng);
    const rd = await rr.json();
    const addr = rd.address || {};
    const locName = addr.city || addr.town || addr.village || city;
    const judName = addr.county || addr.state || addr.region || '';

    const context = analyzeLocalData(centerLat, centerLng, locName, judName);
    await askPerplexity('Raport de oportunitate pentru ' + locName + '?', context);

    document.getElementById('loadBar').style.display = 'none';
  } catch(e){
    console.error(e);
    document.getElementById('loadBar').style.display = 'none';
  }
}

function toggleAddMode(){
  addMode = !addMode;
  const btn = document.getElementById('addModeBtn');
  if(addMode){
    btn.innerText = 'STOP';
    btn.style.borderColor = '#ff3333';
  } else {
    btn.innerText = 'ANALIZƒÇ PUNCTUALƒÇ';
    btn.style.borderColor = '#00ff88';
  }
}

map.on('click', async e => {
  if(!addMode) return;

  let city = 'Loca»õie';
  let judet = '';

  try{
    const r = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=' + e.latlng.lat + '&lon=' + e.latlng.lng);
    const d = await r.json();
    const a = d.address || {};

    city = a.city || a.town || a.village || a.suburb || a.neighbourhood || city;
    judet = a.county || a.state || a.region || '';

    // DacƒÉ e sector, pƒÉstreazƒÉ city="Bucuresti" ca sƒÉ nimere»ôti r√¢ndurile agregate mai u»ôor
    if(norm(city).includes('sector')) city = 'Bucuresti';
  } catch(err){}

  const context = analyzeLocalData(e.latlng.lat, e.latlng.lng, city, judet);

  L.circleMarker(e.latlng, { radius: 10, color:'#fff', fillColor:'#ff00cc', fillOpacity:1 }).addTo(map);
  askPerplexity('AnalizeazƒÉ poten»õialul unui locker aici (' + city + ', ' + judet + '): ' + e.latlng.lat + ', ' + e.latlng.lng, context);
});

/* ===========================
   13) RESET
=========================== */
function resetAll(){
  Object.values(layers).forEach(l => l.clearLayers());
  document.getElementById('aiResponse').style.display = 'none';
  speak('Resetat.');
}
</script>
</body>
</html>
