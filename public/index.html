<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QUEST DETECTIVE - EXPANSIUNE (v2.1)</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{
      --bg:#222; --panel:rgba(18,22,33,.98); --panel2:#1a1e29;
      --border:#333; --text:#e0e0e0; --muted:#888;
      --accent:#00ff88; --danger:#ff3333; --pink:#ff00cc;
      --warn:#f1c40f;
    }
    body{font-family:Inter,system-ui,sans-serif;margin:0;padding:0;background:var(--bg);color:var(--text);overflow:hidden;font-size:14px;}
    #map{height:100vh;width:100%;position:relative;z-index:1;}

    .quest-panel{
      position:absolute;top:15px;left:15px;background:var(--panel);border:1px solid var(--border);
      width:420px;padding:14px;border-radius:12px;z-index:1000;box-shadow:0 0 30px rgba(0,0,0,.6);
      max-height:90vh;overflow-y:auto;
    }
    .quest-panel.collapsed{max-height:56px !important; overflow:hidden !important;}

    .quest-title{
      font-size:16px;font-weight:900;color:var(--accent);margin-bottom:10px;text-transform:uppercase;
      border-bottom:2px solid var(--accent);padding-bottom:10px;display:flex;justify-content:space-between;align-items:center;gap:8px;
    }
    .quest-title span{flex:1}
    .mic-btn{
      background:transparent;border:1px solid #444;color:#aaa;width:30px;height:30px;border-radius:50%;
      cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;flex:0 0 auto;
    }
    .mic-btn.active{border-color:var(--accent);color:var(--accent);box-shadow:0 0 10px rgba(0,255,136,.4);animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}

    .quest-input-group{margin-bottom:10px;background:var(--panel2);padding:10px;border-radius:10px;border:1px solid var(--border);}
    .quest-label{font-size:11px;font-weight:800;color:var(--muted);text-transform:uppercase;margin-bottom:6px;display:block;}
    input[type="file"]{width:100%;font-size:11px;color:#ccc;border:none;background:transparent;}

    .quest-search{width:100%;padding:10px;background:#111;border:1px solid #444;color:#fff;border-radius:8px;box-sizing:border-box;}
    .quest-search:focus{outline:none;border-color:var(--accent);}

    .quest-btn{
      width:100%;padding:10px;margin-top:6px;background:#111;border:1px solid var(--accent);color:var(--accent);
      font-weight:900;cursor:pointer;text-transform:uppercase;transition:.2s;border-radius:10px;
    }
    .quest-btn:hover{background:var(--accent);color:#000;}
    .btn-scan{border-color:var(--pink);color:var(--pink);}
    .btn-scan:hover{background:var(--pink);color:#fff;}
    .btn-muted{border-color:#444;color:#aaa;}
    .btn-muted:hover{background:#222;color:#fff;border-color:#666;}
    .btn-danger{border-color:var(--danger);color:var(--danger);}
    .btn-danger:hover{background:var(--danger);color:#fff;}
    .btn-red{border-color:var(--danger);color:var(--danger);}
    .btn-red:hover{background:var(--danger);color:#fff;}

    .mini-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
    .mini-grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;}
    .mini-field{background:#111;border:1px solid #333;border-radius:10px;padding:8px;}
    .mini-field input{width:100%;background:#0d0d0d;border:1px solid #444;color:#fff;border-radius:8px;padding:8px;box-sizing:border-box;}
    .mini-field input:focus{outline:none;border-color:var(--accent);}
    .mini-hint{font-size:11px;color:#9aa0a6;line-height:1.35;margin-top:6px;}

    .ai-response-box{
      background:rgba(0,255,136,.05);border:1px solid var(--accent);padding:10px;margin-top:10px;border-radius:10px;
      font-size:12px;line-height:1.45;color:#fff;display:none;
    }
    #aiFeedback{font-size:11px;color:#aaa;margin-top:6px;min-height:15px;text-align:center;}

    .stats-container{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
    .stat-box{background:#111;border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center;}
    .stat-val{font-size:16px;font-weight:900;color:#fff;}
    .stat-name{font-size:9px;color:#666;text-transform:uppercase;}

    .loading-bar{height:3px;background:#333;width:100%;display:none;margin-top:6px;border-radius:3px;overflow:hidden;}
    .loading-fill{height:100%;background:var(--accent);width:0;transition:width .3s;}

    .leaflet-popup-content-wrapper{background:rgba(18,22,33,.98);color:#eee;border:1px solid #444;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.8);}
    .leaflet-popup-content{width:320px !important;margin:14px;}
    .leaflet-popup-tip{background:#1a1e29;}

    .popup-header{font-weight:900;color:var(--accent);font-size:14px;text-align:center;margin-bottom:10px;border-bottom:1px solid #444;padding-bottom:8px;}
    .popup-row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;font-size:12px;margin-bottom:6px;border-bottom:1px dashed #333;padding-bottom:5px;}
    .popup-label{color:#9aa0a6;font-weight:700;min-width:150px;}
    .popup-value{font-weight:700;color:#fff;text-align:right;flex:1;word-break:break-word;}

    .badge-red{
      display:inline-block;padding:6px 10px;border-radius:10px;
      background:rgba(255,51,51,.12);border:1px solid var(--danger);
      color:#fff;font-weight:900;font-size:12px;text-transform:uppercase;
    }

    @media (max-width: 720px){
      .quest-panel{left:10px;right:10px;top:auto;bottom:10px;width:auto;max-height:52vh;padding:12px;border-radius:14px;backdrop-filter: blur(6px);}
      .leaflet-popup-content{ width: 240px !important; margin: 12px; }
      .popup-label{ min-width: 110px; }
      .leaflet-control-zoom a{ width: 38px; height: 38px; line-height: 38px; }
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="quest-panel">
    <div class="quest-title">
      <span>QUEST DETECTIVE v2.1</span>
      <button id="micBtn" class="mic-btn" onclick="toggleVoice()" title="Microfon">üé§</button>
      <button class="mic-btn" id="panelToggleBtn" onclick="togglePanel()" title="Ascunde/AratƒÉ">‚ñ¥</button>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">BUILD / DATA STATUS</span>
      <div id="buildInfo" style="font-size:12px;color:#ccc;line-height:1.35;">Ini»õializare...</div>
      <div class="mini-hint">Recomandare: trimite acest bloc √Æn PPT pentru ‚Äúaudit trail‚Äù.</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">PERPLEXITY API KEY</span>
      <div style="font-size:12px;color:#aaa;margin-bottom:6px;">Cheia este cititƒÉ automat din <code>config.js</code>.</div>
      <div id="keyStatus" style="font-size:12px;color:#ccc;">Verificare cheie...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">1. LOCKERE (CSV)</span>
      <input type="file" name="lockersFile" onchange="handleFileUpload(this,'lockers')">
      <div id="statusLockers" style="font-size:12px;color:#aaa;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">2. VOLUME AWB (CSV)</span>
      <input type="file" name="awbFile" onchange="handleFileUpload(this,'awb')">
      <div id="statusAWB" style="font-size:12px;color:#aaa;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">3. POPULA»öIE (CSV)</span>
      <input type="file" name="popFile" onchange="handleFileUpload(this,'pop')">
      <div id="statusPop" style="font-size:12px;color:#aaa;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">FILTRARE RAPIDƒÇ</span>
      <div class="mini-grid3">
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Load min (Nov25)</div>
          <input id="fltMinLoad" type="number" min="0" max="150" step="1" value="0" oninput="applyFilters()">
        </div>
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Doar Critic</div>
          <input id="fltOnlyCritical" type="checkbox" onchange="applyFilters()">
          <div class="mini-hint">Urgent + Standard</div>
        </div>
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Instalat &lt;12 luni</div>
          <input id="fltOnlyNew" type="checkbox" onchange="applyFilters()">
          <div class="mini-hint">Pe Data instalare</div>
        </div>
      </div>
      <button class="quest-btn btn-muted" onclick="resetFilters()">Reset filtre</button>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">RULES (CONFIGURABIL)</span>
      <div class="mini-grid">
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Aten»õie ‚â•</div>
          <input id="rWarn" type="number" min="0" max="150" step="1" value="75" oninput="saveRulesFromUI()">
        </div>
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Critic Std ‚â•</div>
          <input id="rCritStd" type="number" min="0" max="150" step="1" value="85" oninput="saveRulesFromUI()">
        </div>
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Critic Urgent ‚â•</div>
          <input id="rCritUrg" type="number" min="0" max="150" step="1" value="95" oninput="saveRulesFromUI()">
        </div>
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Override avg (500m) ‚â•</div>
          <input id="rOverrideAvg" type="number" min="0" max="150" step="1" value="90" oninput="saveRulesFromUI()">
        </div>
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Override max (500m) ‚â•</div>
          <input id="rOverrideMax" type="number" min="0" max="200" step="1" value="100" oninput="saveRulesFromUI()">
        </div>
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Override over95 (500m) ‚â•</div>
          <input id="rOverrideOver95" type="number" min="0" max="50" step="1" value="1" oninput="saveRulesFromUI()">
        </div>
      </div>
      <div class="mini-hint">Regulile sunt salvate local (localStorage) »ôi aplicate la clasificƒÉri + override raport.</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">ZONA ISTORICƒÇ (SCREENING)</span>
      <div class="mini-grid">
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">Overpass ON</div>
          <input id="hzOverpassOn" type="checkbox" checked>
          <div class="mini-hint">RazƒÉ 150m + cache 6 luni</div>
        </div>
        <div class="mini-field">
          <div style="font-size:10px;color:#888;font-weight:800;text-transform:uppercase;margin-bottom:6px;">AI confirm</div>
          <input id="hzAiOn" type="checkbox" checked>
          <div class="mini-hint">RuleazƒÉ doar dacƒÉ Overpass are hit</div>
        </div>
      </div>
      <button class="quest-btn btn-muted" onclick="clearHistoricCache()">Reset cache (istoric)</button>
      <div id="hzStatus" style="font-size:11px;color:#aaa;margin-top:6px;">Status: idle</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">CƒÇUTARE LOCKER / ADRESƒÇ</span>
      <input type="text" id="lockerSearch" class="quest-search"
             placeholder="Ex: Jolie Ville / Muncii 23 / nume locker"
             onkeyup="searchLockerUI(event)">
      <div id="lockerSearchStatus" style="font-size:11px;color:#888;margin-top:6px;"></div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">ASISTENT INTELIGENT</span>
      <input type="text" id="searchInput" class="quest-search" placeholder="Ex: AnalizeazƒÉ Baicului..." onkeyup="handleInput(event)">
      <div id="aiFeedback">Sistem gata.</div>

      <div class="loading-bar" id="loadBar"><div class="loading-fill" id="loadFill"></div></div>

      <button class="quest-btn btn-scan" onclick="startAutoScan()">AUTO-SCAN ZONƒÇ</button>
      <button class="quest-btn" id="addModeBtn" onclick="toggleAddMode()">ANALIZƒÇ PUNCTUALƒÇ</button>
      <button class="quest-btn btn-danger" onclick="resetAll()">RESET</button>

      <button onclick="exportLastReport()" id="exportBtn" class="quest-btn" style="display:none;border-color:var(--accent);color:var(--accent);">
        EXPORT RAPORT (TXT)
      </button>
      <button onclick="exportEventLogCsv()" id="exportLogBtn" class="quest-btn btn-muted" style="display:none;">
        EXPORT LOG (CSV)
      </button>

      <div class="stats-container">
        <div class="stat-box"><div class="stat-val" id="totalVal">0</div><div class="stat-name">Lockere</div></div>
        <div class="stat-box"><div class="stat-val" id="criticVal">0</div><div class="stat-name">Critic U</div></div>
        <div class="stat-box"><div class="stat-val" id="warnVal">0</div><div class="stat-name">Aten»õie</div></div>
        <div class="stat-box"><div class="stat-val" id="okVal">0</div><div class="stat-name">Standard</div></div>
      </div>

      <div class="ai-response-box" id="aiResponse"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="./config.js"></script>

  <script>
/* ======================= VERSION / BUILD ======================= */
const APP_VERSION = 'v2.1';
const BUILD_TS = new Date().toISOString();

/* ======================= RULES (config) ======================= */
const DEFAULT_RULES = {
  warn: 75,
  critStd: 85,
  critUrg: 95,
  overrideAvg500: 90,
  overrideMax500: 100,
  overrideOver95_500: 1
};
function loadRules(){
  try{
    const raw = localStorage.getItem('RULES_V2');
    if(!raw) return { ...DEFAULT_RULES };
    const o = JSON.parse(raw);
    return { ...DEFAULT_RULES, ...o };
  }catch(e){ return { ...DEFAULT_RULES }; }
}
let RULES = loadRules();

function rulesToUI(){
  const set = (id,v)=>{ const el=document.getElementById(id); if(el) el.value = v; };
  set('rWarn', RULES.warn);
  set('rCritStd', RULES.critStd);
  set('rCritUrg', RULES.critUrg);
  set('rOverrideAvg', RULES.overrideAvg500);
  set('rOverrideMax', RULES.overrideMax500);
  set('rOverrideOver95', RULES.overrideOver95_500);
}
function saveRulesFromUI(){
  const num = (id, fallback) => {
    const el = document.getElementById(id);
    const v = el ? parseFloat(el.value) : fallback;
    return Number.isFinite(v) ? v : fallback;
  };
  RULES.warn = num('rWarn', DEFAULT_RULES.warn);
  RULES.critStd = num('rCritStd', DEFAULT_RULES.critStd);
  RULES.critUrg = num('rCritUrg', DEFAULT_RULES.critUrg);
  RULES.overrideAvg500 = num('rOverrideAvg', DEFAULT_RULES.overrideAvg500);
  RULES.overrideMax500 = num('rOverrideMax', DEFAULT_RULES.overrideMax500);
  RULES.overrideOver95_500 = num('rOverrideOver95', DEFAULT_RULES.overrideOver95_500);

  localStorage.setItem('RULES_V2', JSON.stringify(RULES));
  if((data.lockers||[]).length) rebuildLayersFromData();
}

/* ======================= KEY CHECK ======================= */
(function(){
  const el = document.getElementById('keyStatus');
  const k = (window.PPLX_API_KEY || '').trim();
  if(!el) return;
  if(k && k.startsWith('pplx-')) el.innerText = 'Cheie detectatƒÉ (config.js).';
  else el.innerText = 'Cheie lipsƒÉ/invalidƒÉ √Æn config.js.';
})();

/* ======================= MAP INIT ======================= */
const baseLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', { attribution:'CARTO' });
const baseSat   = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Esri' });

const map = L.map('map', {
  zoomControl:false,
  layers:[baseLight],
  preferCanvas: true
}).setView([46.00, 25.00], 7);
L.control.zoom({ position:'topright' }).addTo(map);

/* ======================= DATA ======================= */
let data = { lockers: [], awbJL: {}, awbJLM: {}, popJL: {} };
let detectedMonths = [];
let addMode = false;

const ANCHORS = ['kaufland','lidl','carrefour','auchan','mega','profi','mall','plaza','piata','residence','complex','gara','universitate','spital','market'];
const MONTHS = { ianuarie:0,februarie:1,martie:2,aprilie:3,mai:4,iunie:5,iulie:6,august:7,septembrie:8,octombrie:9,noiembrie:10,decembrie:11 };

const statusColors = {
  'Critic Urgent':'#d60000',
  'Critic Standard':'#e67e22',
  'Aten»õie':'#f1c40f',
  'Standard':'#27ae60'
};

const layers = {
  'Critic Urgent': L.layerGroup(),
  'Critic Standard': L.layerGroup(),
  'Aten»õie': L.layerGroup(),
  'Standard': L.layerGroup(),
  'Propuneri': L.layerGroup(),
  'Impact 200m': L.layerGroup(),
  'Impact 500m': L.layerGroup(),
  'ZONA ISTORICƒÇ': L.layerGroup()
};
Object.values(layers).forEach(g=>g.addTo(map));

L.control.layers(
  { 'Light': baseLight, 'Satelit': baseSat },
  {
    'Critic Urgent': layers['Critic Urgent'],
    'Critic Standard': layers['Critic Standard'],
    'Aten»õie': layers['Aten»õie'],
    'Standard': layers['Standard'],
    'Propuneri': layers['Propuneri'],
    'Impact 200m': layers['Impact 200m'],
    'Impact 500m': layers['Impact 500m'],
    'ZONA ISTORICƒÇ': layers['ZONA ISTORICƒÇ']
  },
  { collapsed:true }
).addTo(map);

let lockerMarkers = []; // { marker, locker }

/* ======================= PANEL TOGGLE ======================= */
function togglePanel(){
  const panel = document.querySelector('.quest-panel');
  const btn = document.getElementById('panelToggleBtn');
  if(!panel || !btn) return;
  panel.classList.toggle('collapsed');
  btn.textContent = panel.classList.contains('collapsed') ? '‚ñæ' : '‚ñ¥';
}
window.addEventListener('load', () => {
  rulesToUI();
  if(window.innerWidth <= 720){
    const panel = document.querySelector('.quest-panel');
    const btn = document.getElementById('panelToggleBtn');
    if(panel && btn){ panel.classList.add('collapsed'); btn.textContent='‚ñæ'; }
  }
});

/* ======================= UTILS ======================= */
function splitCSV(line){
  const s = String(line || '');
  const comma = (s.match(/,/g) || []).length;
  const semi = (s.match(/;/g) || []).length;
  const sep = semi > comma ? ';' : ',';
  const res = [];
  let curr = '';
  let inQt = false;
  for(let i=0;i<s.length;i++){
    const c = s[i];
    if(c === '"'){ inQt = !inQt; continue; }
    if(c === sep && !inQt){ res.push(curr.trim()); curr=''; continue; }
    curr += c;
  }
  res.push(curr.trim());
  return res;
}
function norm(s){
  return s ? String(s).toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9 ]/g,' ')
    .replace(/\s+/g,' ')
    .trim() : '';
}
function parseIntSafe(x){
  if(x === null || x === undefined) return NaN;
  const t = String(x).replace(/"/g,'').trim().replace(/,/g,'').replace(/\./g,'');
  const n = parseInt(t, 10);
  return isNaN(n) ? NaN : n;
}
function parseLoadPercent(raw){
  if(raw === null || raw === undefined) return NaN;
  let s = String(raw).replace(/"/g,'').trim();
  if(!s) return NaN;
  s = s.replace('%','').trim();
  s = s.replace(/\s+/g,'');
  if(s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
  if(s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');
  const v = parseFloat(s);
  if(isNaN(v)) return NaN;
  if(v >= 0 && v <= 1.5) return v * 100;
  if(v > 1.5 && v <= 250) return v;
  return NaN;
}
function canonJudet(rawJudet, rawLocalitate=''){
  const j = norm(rawJudet);
  const loc = norm(rawLocalitate);
  const looksLikeBuc = j.includes('bucuresti') || j.includes('bucharest') || loc.includes('sector ');
  const looksLikeIlf = j.includes('ilfov');
  if(looksLikeBuc || looksLikeIlf) return 'bucuresti ilfov';
  return j;
}
function makeJLKey(judetRaw, localitateRaw){
  const j = canonJudet(judetRaw, localitateRaw);
  const l = norm(localitateRaw);
  if(!j || !l) return '';
  return `${j}||${l}`;
}
function getDist(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const a =
    Math.sin((lat2-lat1)*Math.PI/360)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) *
    Math.sin((lon2-lon1)*Math.PI/360)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}
function ymdToDate(raw){
  if(!raw) return null;
  let s = String(raw).trim();
  s = s.replace(/['"]/g, '').replace(/,+$/g, '').trim();
  if(!s) return null;
  let m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:[ T](\d{2}):(\d{2})(?::(\d{2}))?)?$/);
  if(m){
    const y=+m[1], mo=+m[2], d=+m[3];
    const hh=m[4]?+m[4]:0, mm=m[5]?+m[5]:0, ss=m[6]?+m[6]:0;
    return new Date(y, mo-1, d, hh, mm, ss);
  }
  return null;
}
function monthsAgo(d){
  if(!d) return Infinity;
  const now = new Date();
  return (now.getFullYear()-d.getFullYear())*12 + (now.getMonth()-d.getMonth());
}
function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }
function roundCoordKey(lat, lng, decimals=4){
  const f = Math.pow(10, decimals);
  return `${Math.round(lat*f)/f},${Math.round(lng*f)/f}`;
}

/* ======================= DATA QUALITY ======================= */
let DATA_QUALITY = {
  lockers: { ok:false, issues:[], loadedAt:null, rows:0, invalidCoords:0, invalidInstallDates:0, missingColumns:[] },
  awb: { ok:false, issues:[], loadedAt:null, rows:0, keys:0, missingColumns:[] },
  pop: { ok:false, issues:[], loadedAt:null, rows:0, keys:0, missingColumns:[] }
};

function updateBuildInfo(){
  const el = document.getElementById('buildInfo');
  if(!el) return;
  const k = (window.PPLX_API_KEY||'').trim().startsWith('pplx-') ? 'OK' : 'LIPSƒÇ';
  const model = window.PPLX_MODEL || 'sonar-pro';

  const LQ = DATA_QUALITY.lockers;
  const AQ = DATA_QUALITY.awb;
  const PQ = DATA_QUALITY.pop;

  el.innerHTML = `
    <div><b>App</b>: ${APP_VERSION} ‚Ä¢ Build: ${BUILD_TS}</div>
    <div><b>AI</b>: model=${model} ‚Ä¢ key=${k}</div>
    <div style="margin-top:6px;"><b>Data</b>:
      Lockere=${LQ.rows} (coords invalide=${LQ.invalidCoords}, date instalare invalide=${LQ.invalidInstallDates})
      ‚Ä¢ AWB keys=${AQ.keys}
      ‚Ä¢ POP keys=${PQ.keys}
    </div>
    <div style="margin-top:6px;color:#9aa0a6;">
      Rules: warn‚â•${RULES.warn}, critStd‚â•${RULES.critStd}, critUrg‚â•${RULES.critUrg},
      override500(avg‚â•${RULES.overrideAvg500} OR max‚â•${RULES.overrideMax500} OR over95‚â•${RULES.overrideOver95_500})
    </div>
  `;
}

/* ======================= FILTERS ======================= */
function getFilterState(){
  const minLoad = parseFloat(document.getElementById('fltMinLoad')?.value || '0') || 0;
  const onlyCritical = !!document.getElementById('fltOnlyCritical')?.checked;
  const onlyNew = !!document.getElementById('fltOnlyNew')?.checked;
  return { minLoad, onlyCritical, onlyNew };
}
function resetFilters(){
  const a = document.getElementById('fltMinLoad'); if(a) a.value = 0;
  const b = document.getElementById('fltOnlyCritical'); if(b) b.checked = false;
  const c = document.getElementById('fltOnlyNew'); if(c) c.checked = false;
  applyFilters();
}
function applyFilters(){
  const f = getFilterState();
  let shown = 0;
  for(const x of lockerMarkers){
    const l = x.locker;
    const status = l.status;
    const isCritical = (status === 'Critic Urgent' || status === 'Critic Standard');
    const isNew = (l.installMonthsAgo ?? Infinity) <= 12;
    const ok = (l.loadNov25 ?? 0) >= f.minLoad &&
      (!f.onlyCritical || isCritical) &&
      (!f.onlyNew || isNew);

    if(ok){
      if(!layers[status].hasLayer(x.marker)) layers[status].addLayer(x.marker);
      shown++;
    } else {
      Object.keys(statusColors).forEach(s=>{
        if(layers[s].hasLayer(x.marker)) layers[s].removeLayer(x.marker);
      });
    }
  }
  const st = document.getElementById('statusLockers');
  if(st) st.innerText = `Lockere afi»ôate: ${shown}/${lockerMarkers.length}`;
}

/* ======================= CLASSIFICATION ======================= */
function classifyLocker(loadNov25, daysOff){
  const p = (loadNov25 || 0);
  const off = (daysOff || 0);
  if(p >= RULES.critUrg || off > 5) return 'Critic Urgent';
  if(p >= RULES.critStd) return 'Critic Standard';
  if(p >= RULES.warn) return 'Aten»õie';
  return 'Standard';
}

/* ======================= LAYERS REBUILD ======================= */
function rebuildLayersFromData(){
  // Nu »ôtergem ZONA ISTORICƒÇ / Propuneri / Impact c√¢nd re√Æncarci lockerele? -> pƒÉstrƒÉm doar lockerele.
  ['Critic Urgent','Critic Standard','Aten»õie','Standard'].forEach(k => layers[k].clearLayers());
  lockerMarkers = [];

  let stats = {'Critic Urgent':0,'Critic Standard':0,'Aten»õie':0,'Standard':0};

  for(const locker of (data.lockers||[])){
    const status = classifyLocker(locker.loadNov25, locker.daysOff);
    locker.status = status;
    stats[status]++;

    const marker = L.circleMarker([locker.lat, locker.lng], {
      radius: 7,
      fillColor: statusColors[status],
      color:'#000', weight:1, opacity:1, fillOpacity:0.85,
      renderer: L.canvas()
    });

    const trendIcon = locker.trend === 'Peste medie' ? 'üìà' : (locker.trend === 'Sub medie' ? 'üìâ' : '‚û°Ô∏è');
    const monthsText = `${locker.monthsWithData || 0}/12`;

    const popupContent = `
      <div class="popup-header">${locker.nume || '-'}</div>
      <div class="popup-row"><span class="popup-label">üìç Loca»õie:</span><span class="popup-value">${locker.city || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">üì¨ AdresƒÉ:</span><span class="popup-value">${locker.addr || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">üìä √éncƒÉrcare Nov 2025:</span><span class="popup-value">${(locker.loadNov25 || 0).toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">‚èÆÔ∏è Nov 2024:</span><span class="popup-value">${(locker.loadNov24 || 0).toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">üìà Trend:</span><span class="popup-value">${trendIcon} ${locker.trend || 'Stabil'}</span></div>
      <div class="popup-row"><span class="popup-label">‚öñÔ∏è Medie IstoricƒÉ:</span><span class="popup-value">${(locker.avgHist || 0).toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">üóìÔ∏è Luni ultim an:</span><span class="popup-value">${monthsText}</span></div>
      <div class="popup-row"><span class="popup-label">üÜï Instalare &lt;12 luni:</span><span class="popup-value">${(locker.installMonthsAgo ?? Infinity) <= 12 ? 'DA' : 'NU'}</span></div>
      <div class="popup-row"><span class="popup-label">üì¶ Capacitate:</span><span class="popup-value">${locker.cap || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">‚è±Ô∏è Inactivare:</span><span class="popup-value">${locker.daysOff || 0} zile</span></div>
      <div class="popup-row"><span class="popup-label">üìÖ Instalare:</span><span class="popup-value">${locker.install || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">üîß Model:</span><span class="popup-value">${locker.model || '-'}</span></div>
    `;
    marker.bindPopup(popupContent);

    layers[status].addLayer(marker);
    lockerMarkers.push({ marker, locker });
  }

  document.getElementById('totalVal').innerText = data.lockers.length;
  document.getElementById('criticVal').innerText = stats['Critic Urgent'];
  document.getElementById('warnVal').innerText = stats['Aten»õie'];
  document.getElementById('okVal').innerText = stats['Standard'];

  updateBuildInfo();
  applyFilters();
}

/* ======================= FILE UPLOAD ======================= */
function handleFileUpload(input, type){
  const file = input.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = e => {
    const t = e.target.result;
    if(type === 'lockers') processLockers(t);
    if(type === 'awb') processAWB(t);
    if(type === 'pop') processPop(t);
    speak('Fi»ôierul ' + type + ' a fost procesat.');
  };
  r.readAsText(file);
}

/* ======================= LOCKERS CSV ======================= */
function processLockers(csv){
  data.lockers = [];
  detectedMonths = [];

  const Q = { ok:true, issues:[], loadedAt:new Date().toISOString(), rows:0, invalidCoords:0, invalidInstallDates:0, missingColumns:[] };

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){
    Q.ok = false; Q.issues.push('Fi»ôier lockere gol sau invalid.');
    DATA_QUALITY.lockers = Q; updateBuildInfo();
    return;
  }

  const h = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const hN = h.map(norm);

  const idx = {
    nume: h.indexOf('Locker Nume'),
    lat: h.indexOf('Latitudine'),
    lng: h.indexOf('Longitudine'),
    install: h.indexOf('Data instalare'),
    cap: h.indexOf('Capacitate locker'),
    addr: h.indexOf('Adresa'),
    model: h.indexOf('Model'),
    city: h.indexOf('Locker Oras'),
    inactiv: hN.findIndex(x => x.includes('inactiv'))
  };

  h.forEach((col, idxCol) => {
    const m = col.match(/([a-zA-Z]+)\s+(\d{4})/);
    if(m && !col.toLowerCase().includes('inactiv')){
      const mon = m[1].toLowerCase();
      const yr = parseInt(m[2],10);
      if(MONTHS.hasOwnProperty(mon)){
        detectedMonths.push({ name: col, idx: idxCol, val: yr*12 + MONTHS[mon] });
      }
    }
  });
  detectedMonths.sort((a,b)=>a.val-b.val);

  const idxNov25 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2025') && !x.toLowerCase().includes('inactiv'));
  const idxNov24 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2024') && !x.toLowerCase().includes('inactiv'));

  const required = [
    ['Locker Nume', idx.nume],
    ['Latitudine', idx.lat],
    ['Longitudine', idx.lng],
    ['Data instalare', idx.install],
    ['Noiembrie 2025', idxNov25],
    ['Noiembrie 2024', idxNov24]
  ];
  for(const [name, idv] of required){
    if(idv < 0) Q.missingColumns.push(name);
  }
  if(Q.missingColumns.length){
    Q.issues.push('Coloane lipsƒÉ: ' + Q.missingColumns.join(', '));
  }

  const getVal = (row,i) => i>-1 ? (row[i] ?? '').replace(/"/g,'').trim() : '';

  for(const l of lines.slice(1)){
    const row = splitCSV(l);
    if(row.length < h.length) continue;

    const lat = parseFloat(getVal(row, idx.lat));
    const lng = parseFloat(getVal(row, idx.lng));
    if(isNaN(lat) || isNaN(lng)){
      Q.invalidCoords++;
      continue;
    }

    let historyValues = [];
    let monthsWithData = 0;
    detectedMonths.forEach(m => {
      const p = parseLoadPercent(getVal(row, m.idx));
      if(!isNaN(p)){ historyValues.push(p); monthsWithData++; }
    });
    let avgHist = historyValues.length ? historyValues.reduce((a,b)=>a+b,0) / historyValues.length : 0;

    let loadNov25 = 0, loadNov24 = 0;
    if(idxNov25 > -1){
      const p = parseLoadPercent(getVal(row, idxNov25));
      loadNov25 = isNaN(p) ? 0 : p;
    }
    if(idxNov24 > -1){
      const p = parseLoadPercent(getVal(row, idxNov24));
      loadNov24 = isNaN(p) ? 0 : p;
    }

    let trendStr = 'Stabil';
    if(loadNov25 > loadNov24 + 5) trendStr = 'Peste medie';
    else if(loadNov25 < loadNov24 - 5) trendStr = 'Sub medie';

    const daysOff = parseIntSafe(getVal(row, idx.inactiv)) || 0;

    const instRaw = getVal(row, idx.install);
    const installDate = ymdToDate(instRaw);
    if(!installDate) Q.invalidInstallDates++;
    const installMonthsAgo = monthsAgo(installDate);

    const locker = {
      nume: getVal(row, idx.nume),
      lat, lng,
      loadNov25, loadNov24,
      avgHist,
      trend: trendStr,
      monthsWithData,
      install: instRaw,
      installMonthsAgo,
      cap: getVal(row, idx.cap),
      model: getVal(row, idx.model),
      addr: getVal(row, idx.addr),
      city: getVal(row, idx.city),
      daysOff
    };
    data.lockers.push(locker);
    Q.rows++;
  }

  DATA_QUALITY.lockers = Q;
  document.getElementById('statusLockers').innerText =
    `√éncƒÉrcat: ${Q.rows} lockere ‚Ä¢ coord invalide=${Q.invalidCoords} ‚Ä¢ instalƒÉri invalide=${Q.invalidInstallDates}`;

  rebuildLayersFromData();
}

/* ======================= AWB CSV ======================= */
function processAWB(csv){
  data.awbJL = {};
  data.awbJLM = {};
  const Q = { ok:true, issues:[], loadedAt:new Date().toISOString(), rows:0, keys:0, missingColumns:[] };

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){
    Q.ok = false; Q.issues.push('Fi»ôier AWB gol/invalid.');
    DATA_QUALITY.awb = Q; updateBuildInfo();
    document.getElementById('statusAWB').innerText = 'AWB: fi»ôier gol';
    return;
  }

  const header = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const hNorm = header.map(norm);

  const idxMonth = hNorm.findIndex(x => x === 'month' || x.includes('month'));
  const idxJudet = hNorm.findIndex(x => x.includes('judet') && x.includes('destinatar'));
  const idxLoc   = hNorm.findIndex(x => x.includes('localitate') && x.includes('destinatar'));
  const idxTot   = hNorm.findIndex(x => x.includes('nr') && x.includes('total') && x.includes('awb'));

  if(idxJudet < 0) Q.missingColumns.push('Judet destinatar');
  if(idxLoc < 0) Q.missingColumns.push('Localitate destinatar');
  if(idxTot < 0) Q.missingColumns.push('Nr total AWB');

  if(Q.missingColumns.length){
    Q.ok = false;
    Q.issues.push('Header neidentificat (coloane lipsƒÉ).');
    DATA_QUALITY.awb = Q; updateBuildInfo();
    document.getElementById('statusAWB').innerText = 'AWB: header neidentificat';
    return;
  }

  let ok = 0;
  for(const l of lines.slice(1)){
    const row = splitCSV(l);

    const monthRaw = idxMonth >= 0 ? (row[idxMonth] ?? '') : '';
    const judetRaw = (row[idxJudet] ?? '');
    const locRaw   = (row[idxLoc] ?? '');
    const totRaw   = (row[idxTot] ?? '');

    const month = String(monthRaw).replace(/"/g,'').trim();
    const judet = String(judetRaw).replace(/"/g,'').trim();
    const loc   = String(locRaw).replace(/"/g,'').trim();
    if(!judet || !loc) continue;

    const awb = parseIntSafe(totRaw);
    if(isNaN(awb) || awb < 0) continue;

    const jlKey = makeJLKey(judet, loc);
    if(!jlKey) continue;

    data.awbJL[jlKey] = (data.awbJL[jlKey] || 0) + awb;

    if(month){
      const mKey = norm(month);
      const jlmKey = `${mKey}||${jlKey}`;
      data.awbJLM[jlmKey] = (data.awbJLM[jlmKey] || 0) + awb;
    }
    ok++;
  }

  Q.rows = ok;
  Q.keys = Object.keys(data.awbJL||{}).length;
  DATA_QUALITY.awb = Q;

  document.getElementById('statusAWB').innerText = `AWB OK: ${Q.rows} r√¢nduri ‚Ä¢ chei unice ${Q.keys}`;
  updateBuildInfo();
}

/* ======================= POP CSV ======================= */
function processPop(csv){
  data.popJL = {};
  const Q = { ok:true, issues:[], loadedAt:new Date().toISOString(), rows:0, keys:0, missingColumns:[] };

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){
    Q.ok = false; Q.issues.push('Fi»ôier POP gol/invalid.');
    DATA_QUALITY.pop = Q; updateBuildInfo();
    document.getElementById('statusPop').innerText = 'POP: fi»ôier gol';
    return;
  }

  const first = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const fNorm = first.map(norm);

  const hasHeader =
    fNorm.includes('judet') &&
    (fNorm.includes('localitate') || fNorm.includes('localitatea')) &&
    fNorm.join(' ').includes('pop');

  let ok = 0;

  if(hasHeader){
    const idxJ = fNorm.findIndex(x => x === 'judet' || x.includes('judet'));
    const idxL = fNorm.findIndex(x => x === 'localitate' || x.includes('localit'));
    const idxP = fNorm.findIndex(x => x.includes('pop'));

    for(const l of lines.slice(1)){
      const row = splitCSV(l);
      const judet = (row[idxJ] ?? '').replace(/"/g,'').trim();
      const loc   = (row[idxL] ?? '').replace(/"/g,'').trim();
      const pop   = parseIntSafe(row[idxP] ?? '');
      if(!judet || !loc || isNaN(pop)) continue;

      const key = makeJLKey(judet, loc);
      if(!key) continue;

      data.popJL[key] = Math.max(data.popJL[key] || 0, pop);
      ok++;
    }
  } else {
    Q.ok = false;
    Q.issues.push('Format POP fƒÉrƒÉ header: recomand header standard (judet, localitate, pop).');
    for(const l of lines.slice(1)){
      const line = l.replace(/"/g,'').trim();
      if(!line) continue;
      const parts = line.split(/\s+/);
      if(parts.length < 3) continue;

      const pop = parseIntSafe(parts[parts.length - 1]);
      if(isNaN(pop)) continue;

      const judet = parts[0];
      const loc = parts.slice(1, parts.length - 1).join(' ');
      const key = makeJLKey(judet, loc);
      if(!key) continue;

      data.popJL[key] = Math.max(data.popJL[key] || 0, pop);
      ok++;
    }
  }

  Q.rows = ok;
  Q.keys = Object.keys(data.popJL||{}).length;
  DATA_QUALITY.pop = Q;

  document.getElementById('statusPop').innerText = `POP OK: ${Q.rows} r√¢nduri ‚Ä¢ chei unice ${Q.keys}`;
  updateBuildInfo();
}

/* ======================= AUTOLOAD FROM /data ======================= */
async function loadAllCSVs(){
  const setStatus = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; };

  try{
    setStatus('statusLockers', 'Se √ÆncarcƒÉ automat...');
    const lockersText = await (await fetch('./data/date_lockere_actualizat.csv', { cache:'no-store' })).text();
    processLockers(lockersText);
    setStatus('statusLockers', '√éncƒÉrcat automat (date_lockere_actualizat.csv)');
  } catch(e){
    console.error('Autoload lockers error:', e);
    setStatus('statusLockers', 'Eroare autoload: date_lockere_actualizat.csv');
  }

  try{
    setStatus('statusAWB', 'Se √ÆncarcƒÉ automat...');
    const awbText = await (await fetch('./data/cercuri.csv', { cache:'no-store' })).text();
    processAWB(awbText);
    setStatus('statusAWB', '√éncƒÉrcat automat (cercuri.csv)');
  } catch(e){
    console.error('Autoload awb error:', e);
    setStatus('statusAWB', 'Eroare autoload: cercuri.csv');
  }

  try{
    setStatus('statusPop', 'Se √ÆncarcƒÉ automat...');
    const popText = await (await fetch('./data/populatie_2021.csv', { cache:'no-store' })).text();
    processPop(popText);
    setStatus('statusPop', '√éncƒÉrcat automat (populatie_2021.csv)');
  } catch(e){
    console.error('Autoload pop error:', e);
    setStatus('statusPop', 'Eroare autoload: populatie_2021.csv');
  }

  updateBuildInfo();
}
window.addEventListener('load', loadAllCSVs);

/* ======================= SEARCH / FOCUS ======================= */
function searchLockers(query){
  const q = norm(query);
  if(!q) return [];
  const scored = lockerMarkers.map(x => {
    const name = norm(x.locker.nume || '');
    const addr = norm(x.locker.addr || '');
    const city = norm(x.locker.city || '');
    let score = 0;
    if(name.includes(q)) score += 3;
    if(addr.includes(q)) score += 2;
    if(city.includes(q)) score += 1;
    return { ...x, score };
  }).filter(x => x.score > 0);

  scored.sort((a,b)=>b.score-a.score);
  return scored.slice(0, 10);
}
function focusLocker(result){
  const { marker } = result;
  map.setView(marker.getLatLng(), 17, { animate:true });
  marker.openPopup();
}
function searchLockerUI(e){
  if(e.key !== 'Enter') return;
  const q = document.getElementById('lockerSearch').value;
  const hits = searchLockers(q);
  const st = document.getElementById('lockerSearchStatus');
  if(!hits.length){ st.innerText = 'Niciun rezultat.'; return; }

  if(!searchLockerUI._idx || searchLockerUI._lastQ !== norm(q)){
    searchLockerUI._idx = 0;
    searchLockerUI._lastQ = norm(q);
  } else {
    searchLockerUI._idx = (searchLockerUI._idx + 1) % hits.length;
  }
  st.innerText = `GƒÉsite ${hits.length}. Rezultat ${searchLockerUI._idx+1}/${hits.length}. (Enter pentru urmƒÉtorul)`;
  focusLocker(hits[searchLockerUI._idx]);
}

/* ======================= IMPACT CIRCLES ======================= */
function drawImpactCircles(latlng){
  layers['Impact 200m'].clearLayers();
  layers['Impact 500m'].clearLayers();
  const c200 = L.circle(latlng, { radius: 200, color: '#00ff88', weight: 2, fillColor: '#00ff88', fillOpacity: 0.08 });
  const c500 = L.circle(latlng, { radius: 500, color: '#ff00cc', weight: 2, fillColor: '#ff00cc', fillOpacity: 0.06 });
  layers['Impact 200m'].addLayer(c200);
  layers['Impact 500m'].addLayer(c500);
}
function getImpactLists(lat, lng){
  const list200 = [];
  const list500 = [];
  for(const l of (data.lockers || [])){
    const d = getDist(lat, lng, l.lat, l.lng);
    if(d <= 200) list200.push({ locker:l, dist:d });
    if(d <= 500) list500.push({ locker:l, dist:d });
  }
  list200.sort((a,b)=>a.dist-b.dist);
  list500.sort((a,b)=>a.dist-b.dist);
  const min10 = arr => arr.filter(x => x.dist >= 10);
  return { r200: min10(list200), r500: min10(list500) };
}
function getLocalAwbPop(cityName, judetName){
  const key = makeJLKey(judetName || '', cityName || '');
  const awb = (data.awbJL && key) ? (data.awbJL[key] || 0) : 0;
  const pop = (data.popJL && key) ? (data.popJL[key] || 0) : 0;
  return { key, awb, pop };
}
function analyzeLocalData(lat, lng, cityName, judetName){
  const local = getLocalAwbPop(cityName, judetName);
  const impactLists = getImpactLists(lat, lng);

  function enrichImpact(arr){
    const rows = arr.map(x => {
      const l = x.locker;
      const delta = (l.loadNov25 || 0) - (l.loadNov24 || 0);
      return {
        name: l.nume || '',
        dist: x.dist,
        loadNov25: +(l.loadNov25 || 0).toFixed(1),
        loadNov24: +(l.loadNov24 || 0).toFixed(1),
        delta: +delta.toFixed(1),
        avgHist: +(l.avgHist || 0).toFixed(1),
        monthsWithData: l.monthsWithData || 0,
        installs12: (l.installMonthsAgo || Infinity) <= 12,
        daysOff: l.daysOff || 0
      };
    });

    const count = rows.length;
    const avgLoad = count ? rows.reduce((s,r)=>s+r.loadNov25,0)/count : 0;
    const avgDelta = count ? rows.reduce((s,r)=>s+r.delta,0)/count : 0;
    const avgHist = count ? rows.reduce((s,r)=>s+r.avgHist,0)/count : 0;

    const maxLoad = count ? Math.max(...rows.map(r => r.loadNov25)) : 0;
    const over95 = rows.filter(r => r.loadNov25 >= RULES.critUrg).length;
    const over100 = rows.filter(r => r.loadNov25 >= 100).length;

    const pos = rows.filter(r => r.delta > 0).length;
    const neg = rows.filter(r => r.delta < 0).length;
    const installs12 = rows.filter(r => r.installs12).length;

    return {
      count,
      avgLoad: +avgLoad.toFixed(1),
      avgDelta: +avgDelta.toFixed(1),
      avgHist: +avgHist.toFixed(1),
      maxLoad: +maxLoad.toFixed(1),
      over95,
      over100,
      posDeltas: pos,
      negDeltas: neg,
      installs12,
      rows
    };
  }

  const impact200 = enrichImpact(impactLists.r200);
  const impact500 = enrichImpact(impactLists.r500);

  const anchors = [];
  (impact500.rows || []).forEach(x=>{
    const n = (x.name||'').toLowerCase();
    ANCHORS.forEach(tag => { if(n.includes(tag) && !anchors.includes(tag)) anchors.push(tag); });
  });

  return { city: cityName, judet: judetName || '', awbLocal: local.awb, popLocal: local.pop, keyJL: local.key, anchors, impact200, impact500 };
}

/* ======================= DEGREVARE (determinist) ======================= */
function computeDecongestion(contextData){
  const r200 = contextData?.impact200?.rows || [];
  const r500 = contextData?.impact500?.rows || [];
  function calc(arr, radius, maxPp){
    const p = 2;
    const items = arr.map(x => {
      const dist = Math.max(10, x.dist || radius);
      const z = Math.max(0, 1 - (dist / radius));
      const distFactor = Math.pow(z, p);
      const loadFactor = Math.max(0, (x.loadNov25 || 0) - 70);
      const w = loadFactor * distFactor;
      return { ...x, w };
    });
    const W = items.reduce((s,i)=>s+i.w,0) || 1;
    const out = items.map(i => {
      const delta = -(maxPp * (i.w / W));
      const after = Math.max(0, (i.loadNov25 || 0) + delta);
      return { nume: i.name, dist_m: i.dist, before_pct: +(i.loadNov25||0).toFixed(1), after_pct: +after.toFixed(1), delta_pct: +delta.toFixed(1) };
    });
    out.sort((a,b)=>a.dist_m-b.dist_m);
    return out.slice(0, 6);
  }
  return { list200: calc(r200, 200, 12), list500: calc(r500, 500, 6) };
}
function selectDecongestionList(contextData){
  const c200 = contextData?.impact200?.count || 0;
  const chosenRadius = (c200 >= 2) ? 200 : 500;
  const decong = computeDecongestion(contextData);
  const chosenList = (chosenRadius === 200) ? decong.list200 : decong.list500;
  return { chosenRadius, chosenList };
}

/* ======================= DETERMINISTIC SCORE ======================= */
function computeDeterministicScore(context){
  const m = context?.impact500;
  if(!m) return { score: 0, parts:{}, explain:[], severity:'N/A' };

  const avg = m.avgLoad || 0;
  const max = m.maxLoad || 0;
  const over95 = m.over95 || 0;

  const sAvg = clamp((avg - 60) * 2.5, 0, 100);
  const sMax = clamp((max - 80) * 5.0, 0, 100);
  const sOver = clamp(over95 * 35, 0, 100);

  const score = 0.55*sAvg + 0.25*sMax + 0.20*sOver;

  const override =
    (m.over95 || 0) >= RULES.overrideOver95_500 ||
    (m.maxLoad || 0) >= RULES.overrideMax500 ||
    (m.avgLoad || 0) >= RULES.overrideAvg500;

  const severity = override ? 'URGENT' : (score >= 60 ? 'RIDICAT' : (score >= 35 ? 'MODERAT' : 'SCƒÇZUT'));

  const explain = [
    `Impact 500m: ${m.count} lockere, avgLoad=${avg}%, maxLoad=${max}%, over95=${over95}.`,
    `Scor determinist: avg(${sAvg.toFixed(0)})√ó55% + max(${sMax.toFixed(0)})√ó25% + over95(${sOver.toFixed(0)})√ó20% = ${score.toFixed(1)}/100.`,
    override ? `Override critic activ (rules 500m).` : `Override critic inactiv.`
  ];

  return { score: +score.toFixed(1), parts:{ sAvg:+sAvg.toFixed(1), sMax:+sMax.toFixed(1), sOver:+sOver.toFixed(1), override }, explain, severity };
}

/* ======================= EVENT LOG ======================= */
function loadEventLog(){
  try{
    const raw = localStorage.getItem('EVENT_LOG_V2');
    if(!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  }catch(e){ return []; }
}
function saveEventLog(arr){
  localStorage.setItem('EVENT_LOG_V2', JSON.stringify(arr.slice(-500)));
}
let EVENT_LOG = loadEventLog();
function addEventLog(entry){
  EVENT_LOG.push({ ts:new Date().toISOString(), ...entry });
  saveEventLog(EVENT_LOG);
  const btn = document.getElementById('exportLogBtn');
  if(btn) btn.style.display = EVENT_LOG.length ? 'block' : 'none';
}
function exportEventLogCsv(){
  if(!EVENT_LOG.length) return;
  const cols = ['ts','type','city','judet','lat','lng','severity','detScore','note'];
  const esc = (v)=> `"${String(v ?? '').replace(/"/g,'""')}"`;
  const lines = [cols.join(',')];
  for(const e of EVENT_LOG){
    lines.push(cols.map(c => esc(e[c])).join(','));
  }
  const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `event_log_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ======================= ZONA ISTORICƒÇ (cache + Overpass + AI) ======================= */
const HZ_RADIUS_M = 150;
const HZ_TTL_MS = 183 * 24 * 3600 * 1000; // ~6 luni
const HZ_CACHE_KEY = 'HZ_CACHE_V1';

let HZ_MEM_CACHE = new Map(); // key -> {ts, data}
let HZ_LAST_REQ_TS = 0;

function hzUiStatus(t){
  const el = document.getElementById('hzStatus');
  if(el) el.innerText = 'Status: ' + t;
}
function hzEnabledOverpass(){ return !!document.getElementById('hzOverpassOn')?.checked; }
function hzEnabledAI(){ return !!document.getElementById('hzAiOn')?.checked; }

function loadHzCache(){
  try{
    const raw = localStorage.getItem(HZ_CACHE_KEY);
    if(!raw) return {};
    const o = JSON.parse(raw);
    return (o && typeof o === 'object') ? o : {};
  }catch(e){ return {}; }
}
function saveHzCache(cacheObj){
  // limitare: pƒÉstrƒÉm max 2000 intrƒÉri (cele mai recente)
  const entries = Object.entries(cacheObj);
  entries.sort((a,b)=>(b[1]?.ts||0)-(a[1]?.ts||0));
  const trimmed = entries.slice(0, 2000);
  const out = {};
  for(const [k,v] of trimmed) out[k]=v;
  localStorage.setItem(HZ_CACHE_KEY, JSON.stringify(out));
}
function clearHistoricCache(){
  localStorage.removeItem(HZ_CACHE_KEY);
  HZ_MEM_CACHE = new Map();
  hzUiStatus('cache reset');
}

function hzCacheGet(key){
  if(HZ_MEM_CACHE.has(key)) return HZ_MEM_CACHE.get(key);

  const store = loadHzCache();
  const v = store[key];
  if(v && v.ts && (Date.now()-v.ts) <= HZ_TTL_MS){
    HZ_MEM_CACHE.set(key, v);
    return v;
  }
  return null;
}
function hzCacheSet(key, data){
  const v = { ts: Date.now(), data };
  HZ_MEM_CACHE.set(key, v);
  const store = loadHzCache();
  store[key] = v;
  saveHzCache(store);
}

async function overpassQuery(q){
  const url = 'https://overpass-api.de/api/interpreter';
  const r = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
    body: 'data=' + encodeURIComponent(q)
  });
  if(!r.ok) throw new Error('Overpass HTTP ' + r.status);
  return await r.json();
}

function hzSummarizeElements(osmJson, limit=6){
  const els = (osmJson && osmJson.elements) ? osmJson.elements : [];
  return els.slice(0, limit).map(e => ({
    type: e.type,
    id: e.id,
    name: e.tags?.name || '',
    historic: e.tags?.historic || '',
    heritage: e.tags?.heritage || '',
    boundary: e.tags?.boundary || '',
    protect_class: e.tags?.protect_class || '',
    protection_title: e.tags?.protection_title || ''
  }));
}

async function historicScreeningOverpass(lat, lng){
  // Throttle simplu ca sƒÉ nu ‚Äú√Ænghe»õe‚Äù UI »ôi sƒÉ nu abuzeze Overpass (care are limitƒÉri/timeout). 
  const now = Date.now();
  const wait = Math.max(0, 1200 - (now - HZ_LAST_REQ_TS));
  if(wait) await new Promise(r=>setTimeout(r, wait));
  HZ_LAST_REQ_TS = Date.now();

  const radius = HZ_RADIUS_M;

  const q =
`[out:json][timeout:25];
(
  node(around:${radius},${lat},${lng})["heritage"];
  way(around:${radius},${lat},${lng})["heritage"];
  relation(around:${radius},${lat},${lng})["heritage"];

  node(around:${radius},${lat},${lng})["historic"];
  way(around:${radius},${lat},${lng})["historic"];
  relation(around:${radius},${lat},${lng})["historic"];

  node(around:${radius},${lat},${lng})["boundary"="protected_area"];
  way(around:${radius},${lat},${lng})["boundary"="protected_area"];
  relation(around:${radius},${lat},${lng})["boundary"="protected_area"];
);
out tags;`;

  const json = await overpassQuery(q);
  const els = (json.elements || []);

  const hasHeritage = els.some(e => e.tags && e.tags.heritage);
  const hasHistoric = els.some(e => e.tags && e.tags.historic);
  const hasProt = els.some(e => e.tags && e.tags.boundary === 'protected_area');

  const confidence = (hasHeritage || hasProt) ? 'HIGH' : (hasHistoric ? 'MEDIUM' : 'LOW');

  return {
    radius_m: radius,
    hits: els.length,
    hasHistoric,
    hasHeritage,
    hasProtectedArea: hasProt,
    confidence,
    samples: hzSummarizeElements(json),
    source: 'OSM Overpass'
  };
}

function hzRenderBadgeHtml(overpassRes, aiRes){
  const flags = [];
  if(overpassRes?.hasProtectedArea) flags.push('protected_area');
  if(overpassRes?.hasHeritage) flags.push('heritage');
  if(overpassRes?.hasHistoric) flags.push('historic');

  const aiLine = aiRes ? `AI: ${aiRes.verdict || 'n/a'} ‚Ä¢ Links: ${(aiRes.links||[]).length}` : 'AI: (not run)';
  return `
<div style="margin-bottom:10px;">
  <span class="badge-red">ZONA ISTORICƒÇ</span>
  <div style="font-size:12px;color:#ddd;margin-top:8px;line-height:1.35;">
    RazƒÉ: ${HZ_RADIUS_M}m ‚Ä¢ Flags: ${flags.join(', ') || 'n/a'} ‚Ä¢ Confidence: ${overpassRes?.confidence || 'n/a'}<br/>
    ${aiLine}<br/>
    SursƒÉ screening: ${overpassRes?.source || 'n/a'}
  </div>
</div>`;
}

function hzMarkOnMap(lat, lng, overpassRes){
  const reason = [
    overpassRes?.hasProtectedArea ? 'protected_area' : null,
    overpassRes?.hasHeritage ? 'heritage' : null,
    overpassRes?.hasHistoric ? 'historic' : null
  ].filter(Boolean).join(', ');

  const c = L.circle([lat,lng], { radius: HZ_RADIUS_M, color:'#ff3333', weight:2, fillColor:'#ff3333', fillOpacity:0.07 });
  layers['ZONA ISTORICƒÇ'].addLayer(c);

  const m = L.circleMarker([lat,lng], { radius: 10, color:'#fff', weight:1, fillColor:'#ff3333', fillOpacity:1, renderer: L.canvas() });
  m.bindPopup(`<div class="popup-header" style="color:#ff3333">ZONA ISTORICƒÇ</div>
    <div style="font-size:12px;line-height:1.35;">
      Screening: ${reason || 'hit-uri'} (150m) ‚Ä¢ Confidence: ${overpassRes?.confidence || 'n/a'}<br/>
      SursƒÉ: ${overpassRes?.source || 'n/a'}
    </div>`);
  layers['ZONA ISTORICƒÇ'].addLayer(m);
}

async function checkHistoricZone(lat, lng, contextLabel=''){
  if(!hzEnabledOverpass()){
    return { skipped:true, note:'Overpass OFF' };
  }

  const key = roundCoordKey(lat, lng, 4);
  const cached = hzCacheGet(key);
  if(cached){
    hzUiStatus(`cache hit (${contextLabel || key})`);
    return { ...cached.data, _cache:'HIT', _key:key };
  }

  hzUiStatus(`verific Overpass (${contextLabel || key})...`);
  try{
    const res = await historicScreeningOverpass(lat, lng);
    hzCacheSet(key, res);
    hzUiStatus(`Overpass OK (${res.hits} hit-uri)`);
    return { ...res, _cache:'MISS', _key:key };
  } catch(e){
    hzUiStatus('Overpass error');
    return { error: String(e.message || e), source:'OSM Overpass', hits:0, _key:key };
  }
}

/* ======================= AI web check (JSON) ======================= */
async function askPerplexityHistoricCheck(lat, lng, city='', judet=''){
  const apiKey = (window.PPLX_API_KEY || '').trim();
  if(!apiKey || !apiKey.startsWith('pplx-')) return { error:'no_api_key' };

  const response_format = {
    type: "json_schema",
    json_schema: {
      schema: {
        type: "object",
        additionalProperties: false,
        properties: {
          verdict: { type: "string", enum: ["found","not_found","uncertain"] },
          summary: { type: "string" },
          links: {
            type: "array",
            items: {
              type: "object",
              additionalProperties: false,
              properties: {
                title: { type: "string" },
                url: { type: "string" },
                snippet: { type: "string" }
              },
              required: ["title","url","snippet"]
            }
          }
        },
        required: ["verdict","summary","links"]
      }
    }
  };

  const systemPrompt =
`E»ôti un auditor de conformitate pentru amplasare (Romania).
Task: verificƒÉ dacƒÉ loca»õia (lat/lng + ora»ô) se aflƒÉ √Æntr-o zonƒÉ protejatƒÉ construitƒÉ/istoricƒÉ stabilitƒÉ local sau √Æn proximitatea unui monument istoric (Ministerul Culturii/INP).
RƒÉspunde STRICT √Æn JSON (schema).
Reguli:
- ReturneazƒÉ DOAR linkuri publice, cu URL complet.
- DacƒÉ nu gƒÉse»ôti surse credibile, verdict="uncertain" (nu inventa).
- Snippet max ~200 caractere, citat/parafrazƒÉ foarte scurtƒÉ.
- DacƒÉ gƒÉse»ôti surse oficiale (primƒÉrie, minister, INP), prioritizeazƒÉ-le.`;

  const userPayload =
`Coordonate: ${lat}, ${lng}
Loca»õie: ${city} (${judet})
Cerin»õƒÉ: identificƒÉ men»õiuni despre zonƒÉ protejatƒÉ/zonƒÉ construitƒÉ protejatƒÉ/zonƒÉ istoricƒÉ/monument istoric √Æn proximitate (~150m).
ReturneazƒÉ 2-5 linkuri dacƒÉ existƒÉ.`;

  const messages = [
    { role:'system', content: systemPrompt },
    { role:'user', content: userPayload }
  ];

  try{
    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method:'POST',
      headers:{ 'Authorization':'Bearer ' + apiKey, 'Content-Type':'application/json' },
      body: JSON.stringify({
        model: (window.PPLX_MODEL || 'sonar-pro'),
        messages,
        response_format
      })
    });
    const json = await response.json();
    if(json.error) throw new Error(json.error.message || 'Eroare API');
    const rawText = json?.choices?.[0]?.message?.content || '';
    return JSON.parse(rawText);
  } catch(e){
    return { verdict:'uncertain', summary:'AI check failed: ' + String(e.message || e), links:[] };
  }
}

/* ======================= REPORT EXPORT ======================= */
let LAST_REPORT_TXT = '';
let LAST_REPORT_NAME = 'raport_easybox.txt';
let LAST_CONTEXT_SNAPSHOT = null;

function formatHistoricSectionTxt(hz){
  if(!hz) return '';
  const lines = [];
  lines.push('CONFORMITATE ‚Äì ZONA ISTORICƒÇ (SCREENING)');
  if(hz.skipped) { lines.push(`- Skipped: ${hz.note||''}`); return lines.join('\n'); }
  if(hz.error) { lines.push(`- Eroare screening: ${hz.error}`); return lines.join('\n'); }
  lines.push(`- RazƒÉ: ${HZ_RADIUS_M}m`);
  lines.push(`- Overpass: hits=${hz.overpass?.hits ?? hz.hits ?? 0}, confidence=${hz.overpass?.confidence ?? hz.confidence ?? 'n/a'}`);
  lines.push(`- Flag-uri: protected_area=${!!(hz.overpass?.hasProtectedArea ?? hz.hasProtectedArea)}, heritage=${!!(hz.overpass?.hasHeritage ?? hz.hasHeritage)}, historic=${!!(hz.overpass?.hasHistoric ?? hz.hasHistoric)}`);
  if(hz.ai){
    lines.push(`- AI verdict: ${hz.ai.verdict} ‚Ä¢ ${hz.ai.summary}`);
    const links = Array.isArray(hz.ai.links) ? hz.ai.links : [];
    links.slice(0,5).forEach((l,i)=>{
      lines.push(`  [${i+1}] ${l.title} ‚Äì ${l.url}`);
    });
  } else {
    lines.push('- AI: not run');
  }
  lines.push('Limitare: screening pe baze publice; necesitƒÉ confirmare oficialƒÉ dacƒÉ impacteazƒÉ decizia finalƒÉ.');
  return lines.join('\n');
}

function formatReportTxt(r){
  const lines = [];
  lines.push('HARTA EXPANSIUNE EASYBOX ‚Äì RAPORT');
  lines.push(`Build: ${APP_VERSION} @ ${BUILD_TS}`);
  lines.push(`Rules: warn‚â•${RULES.warn}, critStd‚â•${RULES.critStd}, critUrg‚â•${RULES.critUrg}, override500(avg‚â•${RULES.overrideAvg500} OR max‚â•${RULES.overrideMax500} OR over95‚â•${RULES.overrideOver95_500})`);
  lines.push('');

  if(LAST_CONTEXT_SNAPSHOT?.historic){
    lines.push(formatHistoricSectionTxt(LAST_CONTEXT_SNAPSHOT.historic));
    lines.push('');
  }

  if(r.zona) lines.push(`ZonƒÉ: ${r.zona}`);
  lines.push(`Scor final: ${Number(r.score_final ?? 0).toFixed(1)}/100`);
  lines.push(`Factor lockere: ${Number(r.factor_lockere ?? 0).toFixed(1)}/100`);
  lines.push(`Factor popula»õie: ${Number(r.factor_populatie ?? 0).toFixed(1)}/100`);
  lines.push('');

  lines.push(`Impact 500m: lockere=${r.lockere_500m ?? 0}, avgLoad=${Number(r.avg_load_500m ?? 0).toFixed(1)}%, maxLoad=${r.max_load_500m ?? 'n/a'}, over95=${r.over95_500m ?? 'n/a'}`);
  if(r.avg_load_istoric_500m !== null && r.avg_load_istoric_500m !== undefined) lines.push(`Istoric 500m: avgHist=${Number(r.avg_load_istoric_500m).toFixed(1)}%`);
  if(r.instalari_ultimul_an_500m !== null && r.instalari_ultimul_an_500m !== undefined) lines.push(`InstalƒÉri <12 luni (500m): ${r.instalari_ultimul_an_500m}`);
  lines.push(`Trend 500m: ${r.trend_zona_500m || '-'}`);
  lines.push('');

  lines.push(`Recomandare: ${String(r.recomandare_text || '').toUpperCase()}`);
  lines.push(`Scor AI (validare/explica»õie): ${Math.round(r.scor_ai ?? 0)}/100`);
  if(r.utilizare_estimata_pct !== null && r.utilizare_estimata_pct !== undefined) lines.push(`Utilizare estimatƒÉ: ${r.utilizare_estimata_pct}%`);
  if(typeof r.cerere_indusa_probabila === 'boolean') lines.push(`Cerere indusƒÉ probabilƒÉ: ${r.cerere_indusa_probabila ? 'DA' : 'NU'}`);
  lines.push('');

  if(r.degrevare_text) lines.push(`Degrevare: ${r.degrevare_text}`);
  lines.push(`Lockere degrevate (raza ${r.degrevare_raza_m || 500}m):`);
  const list = Array.isArray(r.lockere_degrevate) ? r.lockere_degrevate : [];
  const show = list.slice(0, 6);
  for(const x of show){
    lines.push(`- ${x.nume || '-'} (${x.dist_m ?? '-'}m): ${x.before_pct ?? '-'}% ‚Üí ${x.after_pct ?? '-'}% (${x.delta_pct ?? '-'}pp)`);
  }
  if(list.length > show.length) lines.push(`... »ôi √ÆncƒÉ ${list.length - show.length} lockere`);
  lines.push('');

  if(LAST_CONTEXT_SNAPSHOT?.detScore){
    lines.push('EXPLAIN (determinist):');
    LAST_CONTEXT_SNAPSHOT.detScore.explain.forEach(s=>lines.push('- ' + s));
    lines.push('');
  }

  if(LAST_CONTEXT_SNAPSHOT?.dataQuality){
    lines.push('DATA QUALITY:');
    lines.push(JSON.stringify(LAST_CONTEXT_SNAPSHOT.dataQuality, null, 2));
    lines.push('');
  }

  if(r.note) lines.push(`NOTE: ${r.note}`);

  return lines.join('\n');
}

function renderReportToHtml(r){
  const txt = formatReportTxt(r);
  const safe = txt.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return `<pre style="white-space:pre-wrap;margin:0;font-family:Inter,system-ui;font-size:12px;line-height:1.35;">${safe}</pre>`;
}
function exportLastReport(){
  if(!LAST_REPORT_TXT) return;
  const blob = new Blob([LAST_REPORT_TXT], { type:'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = LAST_REPORT_NAME || 'raport_easybox.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ======================= PERPLEXITY (MAIN REPORT) ======================= */
async function askPerplexity(question, contextData=null){
  const apiKey = (window.PPLX_API_KEY || '').trim();
  if(!apiKey || !apiKey.startsWith('pplx-')){
    alert('Cheie Perplexity lipsƒÉ/invalidƒÉ. VerificƒÉ config.js (window.PPLX_API_KEY).');
    return;
  }

  const responseBox = document.getElementById('aiResponse');
  responseBox.style.display = 'block';
  responseBox.innerHTML = '<i>Perplexity analizeazƒÉ datele...</i>';
  document.getElementById('exportBtn').style.display = 'none';

  const response_format = {
    type: "json_schema",
    json_schema: {
      schema: {
        type: "object",
        additionalProperties: false,
        properties: {
          score_final: { type: "number" },
          factor_lockere: { type: "number" },
          factor_populatie: { type: "number" },
          zona: { type: "string" },
          lockere_500m: { type: "integer" },
          avg_load_500m: { type: "number" },
          max_load_500m: { type: ["number","null"] },
          over95_500m: { type: ["integer","null"] },
          avg_load_istoric_500m: { type: ["number","null"] },
          instalari_ultimul_an_500m: { type: ["integer","null"] },
          cerere_indusa_probabila: { type: ["boolean","null"] },
          recomandare_text: { type: "string" },
          scor_ai: { type: "number" },
          utilizare_estimata_pct: { type: ["number","null"] },
          trend_zona_500m: { type: "string" },
          degrevare_text: { type: ["string","null"] },
          degrevare_raza_m: { type: ["integer","null"] },
          lockere_degrevate: {
            type: "array",
            items: {
              type: "object",
              additionalProperties: false,
              properties: {
                nume: { type: "string" },
                dist_m: { type: "integer" },
                before_pct: { type: "number" },
                after_pct: { type: "number" },
                delta_pct: { type: "number" }
              },
              required: ["nume","dist_m","before_pct","after_pct","delta_pct"]
            }
          },
          note: { type: ["string","null"] }
        },
        required: [
          "score_final","factor_lockere","factor_populatie",
          "zona","lockere_500m","avg_load_500m",
          "recomandare_text","scor_ai","trend_zona_500m",
          "lockere_degrevate"
        ]
      }
    }
  };

  // deterministic snapshot
  const detScore = contextData ? computeDeterministicScore(contextData) : null;

  // dataset grounding
  const nat = {
    totalLockers: (data.lockers||[]).length,
    awb_keys: Object.keys(data.awbJL||{}).length,
    pop_keys: Object.keys(data.popJL||{}).length
  };

  const topLockers = (data.lockers||[])
    .slice()
    .sort((a,b)=>(b.loadNov25||0)-(a.loadNov25||0))
    .slice(0, 60)
    .map(l => ({
      nume:l.nume, oras:l.city, adresa:l.addr,
      lat:l.lat, lng:l.lng,
      loadNov25:+(l.loadNov25||0).toFixed(1),
      loadNov24:+(l.loadNov24||0).toFixed(1),
      avgHist:+(l.avgHist||0).toFixed(1),
      trend:l.trend,
      daysOff:l.daysOff||0,
      installMonthsAgo:l.installMonthsAgo
    }));

  let systemPrompt =
`E»ôti un expert logistic senior pentru re»õeaua easybox.
RƒÉspunde STRICT √Æn JSON (schema impusƒÉ). FƒÉrƒÉ text √Æn afara JSON.
Nu folosi browsing/web; folose»ôte doar datele primite.

IMPORTANT: decizia de severitate este deterministƒÉ (scor + override). AI trebuie sƒÉ EXPLICE, nu sƒÉ contrazicƒÉ.

Rules:
- warn‚â•${RULES.warn}, critStd‚â•${RULES.critStd}, critUrg‚â•${RULES.critUrg}
- override500: avg‚â•${RULES.overrideAvg500} OR max‚â•${RULES.overrideMax500} OR over95‚â•${RULES.overrideOver95_500}

Override critic: dacƒÉ override500 e activ, recomandare_text nu poate fi ‚ÄúPOTEN»öIAL MODERAT‚Äù sau mai jos.`;

  let userPayload = question + `

DATASET SUMMARY: ${JSON.stringify(nat)}
TOP_LOCKERS_SAMPLE: ${JSON.stringify(topLockers)}
DATA_QUALITY: ${JSON.stringify(DATA_QUALITY)}`;

  if(contextData){
    const decongPack = selectDecongestionList(contextData);
    userPayload += `

CONTEXT LOCAL:
zona=${contextData.city} (${contextData.judet})
AWB local=${contextData.awbLocal}, POP local=${contextData.popLocal}, JLKey=${contextData.keyJL}
Impact500=${JSON.stringify(contextData.impact500)}
Impact200=${JSON.stringify(contextData.impact200)}

DETSCORE (ground truth): ${JSON.stringify(detScore)}

DEGREVARE (determinist):
- raza=${decongPack.chosenRadius}
- lockere_degrevate=${JSON.stringify(decongPack.chosenList)}

CERIN»öE OUTPUT:
- lockere_500m = impact500.count
- avg_load_500m = impact500.avgLoad
- max_load_500m = impact500.maxLoad
- over95_500m = impact500.over95
- avg_load_istoric_500m = impact500.avgHist
- instalari_ultimul_an_500m = impact500.installs12
- degrevare_raza_m = raza deterministƒÉ
- lockere_degrevate = lista deterministƒÉ (exact)`;
  } else {
    userPayload += `\nNOTE: lipsƒÉ context local (necesitƒÉ click pe hartƒÉ).`;
  }

  const messages = [
    { role:'system', content: systemPrompt },
    { role:'user', content: userPayload }
  ];

  try{
    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method:'POST',
      headers:{ 'Authorization':'Bearer ' + apiKey, 'Content-Type':'application/json' },
      body: JSON.stringify({
        model: (window.PPLX_MODEL || 'sonar-pro'),
        messages,
        response_format
      })
    });

    const json = await response.json();
    if(json.error) throw new Error(json.error.message || 'Eroare API');

    const rawText = json?.choices?.[0]?.message?.content || '';
    let obj = null;
    try{ obj = JSON.parse(rawText); }
    catch(parseErr){
      responseBox.innerHTML = marked.parse(rawText || '(FƒÉrƒÉ rƒÉspuns)');
      return;
    }

    LAST_CONTEXT_SNAPSHOT = {
      detScore,
      rules: { ...RULES },
      dataQuality: DATA_QUALITY,
      dataset: nat,
      historic: LAST_CONTEXT_SNAPSHOT?.historic || null
    };

    responseBox.innerHTML = renderReportToHtml(obj);
    LAST_REPORT_TXT = formatReportTxt(obj);
    LAST_REPORT_NAME = `raport_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
    document.getElementById('exportBtn').style.display = 'block';

    if(contextData){
      addEventLog({
        type: 'analysis',
        city: contextData.city,
        judet: contextData.judet,
        lat: contextData._lat,
        lng: contextData._lng,
        severity: detScore?.severity,
        detScore: detScore?.score,
        note: obj?.recomandare_text
      });
    }

    speak(`Severitate: ${detScore?.severity || 'N/A'}. Recomandare: ${obj.recomandare_text}.`);
  } catch(e){
    console.error(e);
    responseBox.innerText = 'Eroare API Perplexity: ' + (e.message || String(e));
    speak('A apƒÉrut o eroare la conectarea cu Perplexity.');
  }
}

/* ======================= VOICE ======================= */
const synth = window.speechSynthesis;
let recognition = null;
let isListening = false;

function speak(text){
  if(!text) return;
  if(synth.speaking) synth.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ro-RO';
  synth.speak(utter);
  document.getElementById('aiFeedback').innerText = text;
}
function toggleVoice(){
  if(!('webkitSpeechRecognition' in window)){
    alert('NecesitƒÉ Chrome/Edge.');
    return;
  }
  if(isListening){ recognition.stop(); return; }
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ro-RO';
  recognition.onstart = () => { isListening=true; document.getElementById('micBtn').classList.add('active'); };
  recognition.onend = () => { isListening=false; document.getElementById('micBtn').classList.remove('active'); };
  recognition.onresult = e => {
    const q = e.results[0][0].transcript;
    document.getElementById('searchInput').value = q;
    handleInput({ key:'Enter' }, true);
  };
  recognition.start();
}
function handleInput(e, fromVoice=false){
  if(e.key !== 'Enter' && !fromVoice) return;
  const q = document.getElementById('searchInput').value.trim();
  if(!q) return;
  if(q.toLowerCase().includes('scan')){
    const city = q.replace(/scaneaza|scaneazƒÉ|orasul|ora»ôul/gi,'').trim();
    startAutoScan(city);
  } else {
    askPerplexity(q);
  }
}

/* ======================= AUTO-SCAN ======================= */
async function startAutoScan(cityFromParam=null){
  let city = cityFromParam;
  if(!city){ city = prompt('Introdu localitatea / zona pentru scan:'); if(!city) return; }

  speak('Analizez ' + city + '...');
  const loadBar = document.getElementById('loadBar');
  const loadFill = document.getElementById('loadFill');
  loadBar.style.display = 'block';
  loadFill.style.width = '25%';

  try{
    const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=' + encodeURIComponent(city));
    const d = await r.json();
    if(!d.length){ speak('Loca»õie necunoscutƒÉ.'); loadBar.style.display = 'none'; return; }

    loadFill.style.width = '55%';
    const b = d[0].boundingbox;
    map.fitBounds([[b[0], b[2]],[b[1], b[3]]]);

    const centerLat = (parseFloat(b[0]) + parseFloat(b[1])) / 2;
    const centerLng = (parseFloat(b[2]) + parseFloat(b[3])) / 2;
    const center = L.latLng(centerLat, centerLng);

    drawImpactCircles(center);
    layers['Propuneri'].addLayer(L.circleMarker(center, { radius: 10, color:'#fff', fillColor:'#ff00cc', fillOpacity:1, renderer: L.canvas() }));

    const rr = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=' + centerLat + '&lon=' + centerLng);
    const rd = await rr.json();
    const addr = rd.address || {};
    const locName = addr.city || addr.town || addr.village || city;
    const judName = addr.county || addr.state || addr.region || '';

    loadFill.style.width = '75%';
    const context = analyzeLocalData(centerLat, centerLng, locName, judName);
    context._lat = centerLat; context._lng = centerLng;

    // === ZONA ISTORICƒÇ: screening (Overpass), AI confirm doar dacƒÉ Overpass are hit ===
    let hzPack = null;
    const overpassRes = await checkHistoricZone(centerLat, centerLng, 'auto-scan');
    if(!overpassRes?.skipped && !overpassRes?.error && (overpassRes?.hits || 0) > 0){
      hzMarkOnMap(centerLat, centerLng, overpassRes);
      let aiRes = null;
      if(hzEnabledAI()){
        hzUiStatus('AI confirm (auto-scan)...');
        aiRes = await askPerplexityHistoricCheck(centerLat, centerLng, locName, judName);
        hzUiStatus('AI confirm done');
      }
      hzPack = { overpass: overpassRes, ai: aiRes };
      LAST_CONTEXT_SNAPSHOT = { ...(LAST_CONTEXT_SNAPSHOT||{}), historic: hzPack };

      // HARD BLOCK: nu instalƒÉm dacƒÉ screening detecteazƒÉ
      const box = document.getElementById('aiResponse');
      box.style.display = 'block';
      box.innerHTML = hzRenderBadgeHtml(overpassRes, aiRes) + `<pre style="white-space:pre-wrap;margin:0;font-family:Inter,system-ui;font-size:12px;line-height:1.35;">
PoliticƒÉ: nu se fac instalƒÉri √Æn zone protejate/istorice sau l√¢ngƒÉ monumente.
Acest rezultat este screening automat; necesitƒÉ confirmare oficialƒÉ dacƒÉ e cazul.
</pre>`;
      speak('Aten»õie. ZonƒÉ istoricƒÉ detectatƒÉ. Instalarea este blocatƒÉ.');
      document.getElementById('exportBtn').style.display = 'block';
      LAST_REPORT_TXT = formatReportTxt({ score_final:0,factor_lockere:0,factor_populatie:0,zona:locName,lockere_500m:context.impact500.count,avg_load_500m:context.impact500.avgLoad,recomandare_text:'NU INSTALA ‚Äì ZONA ISTORICA',scor_ai:0,trend_zona_500m:'-',lockere_degrevate:[] });
      LAST_REPORT_NAME = `raport_ZONA_ISTORICA_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;

      loadFill.style.width = '100%';
      setTimeout(()=>{ loadBar.style.display='none'; loadFill.style.width='0%'; }, 300);
      return;
    } else {
      // stocƒÉm »ôi rezultatul negativ (audit), dar fƒÉrƒÉ block
      LAST_CONTEXT_SNAPSHOT = { ...(LAST_CONTEXT_SNAPSHOT||{}), historic: { overpass: overpassRes, ai: null } };
    }

    loadFill.style.width = '85%';
    await askPerplexity('Raport de oportunitate pentru zona simulatƒÉ: ' + locName + '?', context);

    loadFill.style.width = '100%';
    setTimeout(()=>{ loadBar.style.display='none'; loadFill.style.width='0%'; }, 300);
  } catch(e){
    console.error(e);
    loadBar.style.display = 'none';
  }
}

/* ======================= ADD MODE (click analysis) ======================= */
function toggleAddMode(){
  addMode = !addMode;
  const btn = document.getElementById('addModeBtn');
  if(addMode){
    btn.innerText = 'STOP ANALIZƒÇ';
    btn.classList.add('btn-danger');
  } else {
    btn.innerText = 'ANALIZƒÇ PUNCTUALƒÇ';
    btn.classList.remove('btn-danger');
  }
}

map.on('click', async (e) => {
  if(!addMode) return;

  drawImpactCircles(e.latlng);
  layers['Propuneri'].addLayer(L.circleMarker(e.latlng, { radius: 10, color:'#fff', fillColor:'#ff00cc', fillOpacity:1, renderer: L.canvas() }));

  let city = 'Loca»õie';
  let judet = '';
  try{
    const r = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=' + e.latlng.lat + '&lon=' + e.latlng.lng);
    const d = await r.json();
    const a = d.address || {};
    city = a.city || a.town || a.village || a.suburb || a.neighbourhood || city;
    judet = a.county || a.state || a.region || '';
    if(norm(city).includes('sector')) city = 'Bucuresti';
  }catch(err){}

  const context = analyzeLocalData(e.latlng.lat, e.latlng.lng, city, judet);
  context._lat = e.latlng.lat; context._lng = e.latlng.lng;

  // === ZONA ISTORICƒÇ flow ===
  const overpassRes = await checkHistoricZone(context._lat, context._lng, 'click');
  if(!overpassRes?.skipped && !overpassRes?.error && (overpassRes?.hits || 0) > 0){
    hzMarkOnMap(context._lat, context._lng, overpassRes);
    let aiRes = null;
    if(hzEnabledAI()){
      hzUiStatus('AI confirm (click)...');
      aiRes = await askPerplexityHistoricCheck(context._lat, context._lng, city, judet);
      hzUiStatus('AI confirm done');
    }
    const hzPack = { overpass: overpassRes, ai: aiRes };
    LAST_CONTEXT_SNAPSHOT = { ...(LAST_CONTEXT_SNAPSHOT||{}), historic: hzPack };

    const box = document.getElementById('aiResponse');
    box.style.display = 'block';
    box.innerHTML = hzRenderBadgeHtml(overpassRes, aiRes) + `<pre style="white-space:pre-wrap;margin:0;font-family:Inter,system-ui;font-size:12px;line-height:1.35;">
PoliticƒÉ: nu se fac instalƒÉri √Æn zone protejate/istorice sau l√¢ngƒÉ monumente.
Acest rezultat este screening automat; necesitƒÉ confirmare oficialƒÉ dacƒÉ e cazul.
</pre>`;
    speak('Aten»õie. ZonƒÉ istoricƒÉ detectatƒÉ. Instalarea este blocatƒÉ.');

    document.getElementById('exportBtn').style.display = 'block';
    LAST_REPORT_TXT = formatReportTxt({ score_final:0,factor_lockere:0,factor_populatie:0,zona:city,lockere_500m:context.impact500.count,avg_load_500m:context.impact500.avgLoad,recomandare_text:'NU INSTALA ‚Äì ZONA ISTORICA',scor_ai:0,trend_zona_500m:'-',lockere_degrevate:[] });
    LAST_REPORT_NAME = `raport_ZONA_ISTORICA_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;

    addEventLog({ type:'historic_block', city, judet, lat:context._lat, lng:context._lng, severity:'BLOCK', detScore:null, note:'ZONA ISTORICA' });
    return;
  } else {
    LAST_CONTEXT_SNAPSHOT = { ...(LAST_CONTEXT_SNAPSHOT||{}), historic: { overpass: overpassRes, ai: null } };
  }

  await askPerplexity(`AnalizeazƒÉ poten»õialul unui locker aici: ${city} (${judet})`, context);
});

/* ======================= RESET ======================= */
function resetAll(){
  Object.values(layers).forEach(l => l.clearLayers());
  data = { lockers: [], awbJL: {}, awbJLM: {}, popJL: {} };
  detectedMonths = [];
  lockerMarkers = [];
  LAST_REPORT_TXT = '';
  LAST_CONTEXT_SNAPSHOT = null;

  document.getElementById('aiResponse').style.display = 'none';
  document.getElementById('statusLockers').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('statusAWB').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('statusPop').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('lockerSearchStatus').innerText = '';
  document.getElementById('totalVal').innerText = '0';
  document.getElementById('criticVal').innerText = '0';
  document.getElementById('warnVal').innerText = '0';
  document.getElementById('okVal').innerText = '0';
  document.getElementById('exportBtn').style.display = 'none';

  speak('Resetat.');
  updateBuildInfo();
}

/* init */
updateBuildInfo();
document.getElementById('exportLogBtn').style.display = EVENT_LOG.length ? 'block' : 'none';
  </script>
</body>
</html>
