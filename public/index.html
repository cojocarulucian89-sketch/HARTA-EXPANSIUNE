<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HARTA EXPANSIUNE</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    body { font-family: Inter, sans-serif; margin:0; padding:0; background:#222; color:#e0e0e0; overflow:hidden; font-size:14px; }
    #map { height:100vh; width:100%; position:relative; z-index:1; }

    .quest-panel {
      position:absolute; top:15px; left:15px;
      background:rgba(18,22,33,0.98);
      border:1px solid #333;
      width:360px; padding:20px; border-radius:12px;
      z-index:1000; box-shadow:0 0 30px rgba(0,0,0,0.6);
      max-height:90vh; overflow-y:auto;
    }
    .quest-title {
      font-size:20px; font-weight:800; color:#00ff88; margin-bottom:15px;
      text-transform:uppercase; border-bottom:2px solid #00ff88; padding-bottom:10px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .quest-label { font-size:11px; font-weight:700; color:#888; text-transform:uppercase; margin-bottom:5px; display:block; }
    .quest-input-group { margin-bottom:15px; background:#1a1e29; padding:10px; border-radius:8px; border:1px solid #333; }
    input[type="file"] { width:100%; font-size:11px; color:#ccc; border:none; background:transparent; }

    .api-input {
      width:100%; padding:8px; background:#000; border:1px solid #00ff88; color:#00ff88;
      font-family:monospace; border-radius:4px; box-sizing:border-box; margin-bottom:5px; font-size:11px;
    }
    .quest-search {
      width:100%; padding:10px; background:#111; border:1px solid #444; color:#fff;
      border-radius:6px; box-sizing:border-box;
    }
    .quest-search:focus { outline:none; border-color:#00ff88; }

    .quest-btn {
      width:100%; padding:10px; margin-top:5px; background:#111; border:1px solid #00ff88; color:#00ff88;
      font-weight:800; cursor:pointer; text-transform:uppercase; transition:0.3s; border-radius:6px;
    }
    .quest-btn:hover { background:#00ff88; color:#000; }
    .btn-scan { border-color:#ff00cc; color:#ff00cc; }
    .btn-scan:hover { background:#ff00cc; color:#fff; }

    .mic-btn {
      background:transparent; border:1px solid #444; color:#aaa;
      width:30px; height:30px; border-radius:50%; cursor:pointer;
      display:flex; align-items:center; justify-content:center; transition:0.3s;
    }
    .mic-btn.active {
      border-color:#00ff88; color:#00ff88; box-shadow:0 0 10px rgba(0,255,136,0.4);
      animation:pulse 1.5s infinite;
    }
    @keyframes pulse { 0%{transform:scale(1)} 50%{transform:scale(1.1)} 100%{transform:scale(1)} }

    #aiFeedback { font-size:11px; color:#aaa; margin-top:5px; min-height:15px; text-align:center; }
    .ai-response-box {
      background:rgba(0,255,136,0.05); border:1px solid #00ff88; padding:10px; margin-top:10px;
      border-radius:6px; font-size:12px; line-height:1.5; color:#fff; display:none;
    }

    .stats-container { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:15px; }
    .stat-box { background:#111; border:1px solid #333; border-radius:6px; padding:8px; text-align:center; }
    .stat-val { font-size:16px; font-weight:800; color:#fff; }
    .stat-name { font-size:9px; color:#666; text-transform:uppercase; }

    .leaflet-popup-content-wrapper { background:rgba(18,22,33,0.98); color:#eee; border:1px solid #444; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.8); }
    .leaflet-popup-content { width:320px !important; margin:15px; }
    .leaflet-popup-tip { background:#1a1e29; }

    .popup-header {
      font-weight:900; color:#00ff88; font-size:15px; text-align:center;
      margin-bottom:12px; border-bottom:1px solid #444; padding-bottom:8px;
      text-transform:none;
    }
    .popup-row {
      display:flex; justify-content:space-between; align-items:flex-start;
      font-size:12px; margin-bottom:6px; border-bottom:1px dashed #333; padding-bottom:4px; gap:10px;
    }
    .popup-label {
      color:#bbb; font-weight:700; white-space:nowrap; min-width:140px;
    }
    .popup-value {
      font-weight:700; color:#fff; text-align:right;
    }
    .val-high { color:#00ff88; }
    .val-low { color:#ff3333; }
    .val-warn { color:#ffcc00; }

    .loading-bar { height:3px; background:#333; width:100%; display:none; margin-top:5px; }
    .loading-fill { height:100%; background:#00ff88; width:0; transition:width 0.3s; }
    ::-webkit-scrollbar { width:6px; }
    ::-webkit-scrollbar-track { background:#111; }
    ::-webkit-scrollbar-thumb { background:#333; border-radius:3px; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="quest-panel">
    <div class="quest-title">
      HARTA EXPANSIUNE
      <button class="mic-btn" id="micBtn" onclick="toggleVoice()" title="Microfon">üé§</button>
    </div>

    <div class="quest-input-group" style="border-color:#00ff88;">
      <span class="quest-label" style="color:#00ff88;">PERPLEXITY API KEY</span>
      <input type="password" id="apiKey" class="api-input" placeholder="pplx-xxxxxxxxxxxxxxxxxxxx"/>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">1. LOCKERE CSV</span>
      <input type="file" onchange="handleFileUpload(this,'lockers')"/>
      <div id="statusLockers" style="font-size:10px; color:#555; margin-top:2px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">2. VOLUME AWB CSV (op»õional)</span>
      <input type="file" onchange="handleFileUpload(this,'awb')"/>
      <div id="statusAWB" style="font-size:10px; color:#555; margin-top:2px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group" style="border-color:#00ff88;">
      <span class="quest-label">3. POPULA»öIE (CSV)</span>
      <input type="file" onchange="handleFileUpload(this,'pop')"/>
      <div id="statusPop" style="font-size:10px; color:#555; margin-top:2px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group" style="border-color:#00ff88;">
      <span class="quest-label">4. CERCURI (CSV) ‚Äì AWB pe localitate</span>
      <input type="file" onchange="handleFileUpload(this,'cercuri')"/>
      <div id="statusCercuri" style="font-size:10px; color:#555; margin-top:2px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <button onclick="clearIndexedDBCache()" class="quest-btn" style="border-color:#aaa;color:#aaa;">CLEAR CACHE (INDEXEDDB)</button>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">ASISTENT INTELIGENT</span>
      <input type="text" id="searchInput" class="quest-search" placeholder="Ex: AnalizeazƒÉ Baicului..." onkeyup="handleInput(event)"/>
      <div id="aiFeedback">Sistem gata.</div>
      <div id="aiResponse" class="ai-response-box"></div>
    </div>

    <button onclick="startAutoScanWrapper()" class="quest-btn btn-scan">AUTO-SCAN ZONƒÇ</button>
    <button onclick="toggleAddMode()" id="addModeBtn" class="quest-btn">ANALIZƒÇ PUNCTUALƒÇ</button>
    <button onclick="resetAll()" class="quest-btn" style="border-color:#ff3333;color:#ff3333;">RESET</button>

    <div class="stats-container">
      <div class="stat-box"><div class="stat-val" id="totalVal">0</div><div class="stat-name">Lockere</div></div>
      <div class="stat-box"><div class="stat-val" style="color:#ff0033" id="criticVal">0</div><div class="stat-name">Critic</div></div>
      <div class="stat-box"><div class="stat-val" style="color:#ffae00" id="warnVal">0</div><div class="stat-name">Aten»õie</div></div>
      <div class="stat-box"><div class="stat-val" style="color:#00ff88" id="okVal">0</div><div class="stat-name">OK</div></div>
    </div>

    <div class="loading-bar" id="loadBar"><div class="loading-fill" id="loadFill"></div></div>
  </div>

<script>
/* ------------------ 1) HARTƒÇ + STRATURI ------------------ */
const map = L.map('map', { zoomControl:false }).setView([46.00, 25.00], 7);
L.control.zoom({ position:'topright' }).addTo(map);

const baseLight = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
  { attribution:'¬© CARTO' }
);
const baseSat = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution:'Tiles ¬© Esri' }
);
baseLight.addTo(map);

const statusColors = {
  'Critic Urgent':'#d60000',
  'Critic Standard':'#e67e22',
  'Aten»õie':'#f1c40f',
  'Standard':'#27ae60'
};

const layers = {
  'Critic Urgent': L.layerGroup().addTo(map),
  'Critic Standard': L.layerGroup().addTo(map),
  'Aten»õie': L.layerGroup().addTo(map),
  'Standard': L.layerGroup().addTo(map),
  'Propuneri': L.layerGroup().addTo(map),
  'Simulare': L.layerGroup().addTo(map)
};

L.control.layers(
  { "Light": baseLight, "Satelit": baseSat },
  layers,
  { collapsed:false, position:'topright' }
).addTo(map);

/* ------------------ 2) DATE + UTILS ------------------ */
let data = { lockers:[], awb:{}, pop:{}, cercuri:[] };
let addMode = false;
let detectedMonths = [];

const ANCHORS = ['kaufland','lidl','carrefour','auchan','mega','profi','mall','plaza','piata','residence','complex','gara','universitate','spital','market'];
const MONTHS = { ianuarie:0,februarie:1,martie:2,aprilie:3,mai:4,iunie:5,iulie:6,august:7,septembrie:8,octombrie:9,noiembrie:10,decembrie:11 };

function splitCSV(str){
  const res=[]; let curr=""; let inQt=false;
  for (let c of str){
    if (c === '"') inQt = !inQt;
    else if (c === ',' && !inQt){ res.push(curr.trim()); curr=""; }
    else curr += c;
  }
  res.push(curr.trim());
  return res;
}
function norm(s){
  return (s||"")
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9 ]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}
function toNumMaybe(x){
  if (x==null) return NaN;
  let s = String(x).replace(/"/g,'').trim();
  if (!s) return NaN;
  s = s.replace(/\./g,'').replace(/,/g,'.');
  const v = parseFloat(s);
  return isNaN(v) ? NaN : v;
}
function getDist(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const a = Math.sin((lat2-lat1)*Math.PI/360)**2 +
            Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) *
            Math.sin((lon2-lon1)*Math.PI/360)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}
function htmlEscape(s){
  return String(s ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function parseISODateLoose(s){
  if(!s) return null;
  const t = String(s).trim().split(' ')[0];
  const m = t.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  const d = new Date(Number(m[1]), Number(m[2]) - 1, Number(m[3]));
  return isNaN(d.getTime()) ? null : d;
}
function extractSectorNumber(sectorText){
  const s = norm(sectorText);
  const m = s.match(/sector(ul)?\s*(\d)/);
  return m ? Number(m[2]) : null;
}

/* --- POPUP FORMAT HELPERS --- */
function fmtPct(x){
  const v = Number(x);
  return isFinite(v) ? v.toFixed(1) + '%' : '-';
}
function fmtNum1(x){
  const v = Number(x);
  return isFinite(v) ? v.toFixed(1) : (String(x ?? '-'));
}
function fmtDate(x){
  const s = String(x ?? '').trim();
  return s ? s : '-';
}
function trendWithIcon(trend){
  const t = String(trend || '').toLowerCase();
  if (t.includes('peste')) return 'üìà Peste medie';
  if (t.includes('sub')) return 'üìâ Sub medie';
  return '‚ûñ Stabil';
}
function loadClass(load){
  const v = Number(load);
  if (!isFinite(v)) return '';
  if (v >= 90) return 'val-high';
  if (v >= 75) return 'val-warn';
  return 'val-low';
}

/* ------------------ 3) CACHE (IndexedDB) ------------------ */
async function clearIndexedDBCache(){
  try{
    if (!indexedDB.databases) { alert("Browserul nu suportƒÉ indexedDB.databases()"); return; }
    const dbs = await indexedDB.databases();
    await Promise.all(dbs.map(db => new Promise(res=>{
      if (!db.name) return res();
      const req = indexedDB.deleteDatabase(db.name);
      req.onsuccess = req.onerror = req.onblocked = () => res();
    })));
    alert("Cache IndexedDB »ôters. Re√ÆncarcƒÉ pagina.");
  }catch(e){
    alert("Eroare la »ôtergere cache: " + e.message);
  }
}

/* ------------------ 4) UPLOAD CSV ------------------ */
function handleFileUpload(input, type){
  const file = input.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = e => {
    const t = e.target.result;
    if(type==='lockers') processLockers(t);
    if(type==='awb') processAWB(t);
    if(type==='pop') processPop(t);
    if(type==='cercuri') processCercuri(t);

    input.parentElement.style.borderColor = '#00ff88';

    const statusMap = { lockers:'statusLockers', awb:'statusAWB', pop:'statusPop', cercuri:'statusCercuri' };
    const el = document.getElementById(statusMap[type]);
    if (el) el.innerText = '√éncƒÉrcat';

    speak('Fi»ôierul ' + type + ' a fost procesat.');
  };
  r.readAsText(file);
}

/* ------------------ 5) LOCKERE CSV ------------------ */
function processLockers(csv){
  Object.values(layers).forEach(g => g.clearLayers());
  data.lockers = [];
  detectedMonths = [];

  const stats = { 'Critic Urgent':0, 'Critic Standard':0, 'Aten»õie':0, 'Standard':0 };
  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2) return;

  const h = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());

  h.forEach((col, idx) => {
    const m = col.match(/([A-Za-zƒÉ√¢√Æ»ô»õƒÇ√Ç√é»ò»ö]+)\s+(\d{4})/);
    if(m && !col.toLowerCase().includes('inactiv')){
      const mon = norm(m[1]);
      const yr = parseInt(m[2],10);
      for (const k in MONTHS){
        if(mon.includes(norm(k))){
          detectedMonths.push({ name: col, idx, val: yr*12 + MONTHS[k] });
          break;
        }
      }
    }
  });
  detectedMonths.sort((a,b)=>a.val-b.val);

  const idx = {
    nume: h.indexOf('Locker Nume'),
    lat: h.indexOf('Latitudine'),
    lng: h.indexOf('Longitudine'),
    install: h.indexOf('Data instalare'),
    cap: h.indexOf('Capacitate locker'),
    addr: h.indexOf('Adresa'),
    model: h.indexOf('Model'),
    city: h.indexOf('Locker Oras'),
    inactiv: h.findIndex(x => x.toLowerCase().includes('inactiv'))
  };

  const idxNov25 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2025') && !x.toLowerCase().includes('inactiv'));
  const idxNov24 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2024') && !x.toLowerCase().includes('inactiv'));

  function getVal(row, i){ return i>-1 ? (row[i] ?? '').replace(/"/g,'').trim() : ''; }

  lines.slice(1).forEach(l=>{
    const row = splitCSV(l);
    if(row.length < 5) return;

    const lat = parseFloat(getVal(row, idx.lat).replace(',','.'));
    const lng = parseFloat(getVal(row, idx.lng).replace(',','.'));
    if(isNaN(lat) || isNaN(lng)) return;

    const historyValues = [];
    detectedMonths.forEach(m=>{
      let v = toNumMaybe(getVal(row, m.idx));
      if(!isNaN(v)){
        if (v > 0 && v <= 1.5) v = v*100;
        historyValues.push(v);
      }
    });
    let sum=0, cnt=0;
    historyValues.forEach(v=>{ if(v>0){ sum+=v; cnt++; } });
    const avgHist = cnt ? sum/cnt : 0;

    let loadNov25 = 0, loadNov24 = 0;
    if(idxNov25>-1){ let v=toNumMaybe(getVal(row, idxNov25)); if(!isNaN(v)){ if(v>0&&v<=1.5) v*=100; loadNov25=v; } }
    if(idxNov24>-1){ let v=toNumMaybe(getVal(row, idxNov24)); if(!isNaN(v)){ if(v>0&&v<=1.5) v*=100; loadNov24=v; } }

    let trendStr = 'Stabil';
    if(loadNov25 - loadNov24 > 5) trendStr = 'Peste medie';
    else if(loadNov25 - loadNov24 < -5) trendStr = 'Sub medie';

    let daysOff = parseInt(getVal(row, idx.inactiv) || '0', 10);
    if(isNaN(daysOff)) daysOff = 0;

    let status = 'Standard';
    if(loadNov25 >= 95 && daysOff >= 5) status = 'Critic Urgent';
    else if(loadNov25 >= 85) status = 'Critic Standard';
    else if(loadNov25 >= 75) status = 'Aten»õie';

    stats[status]++;

    const locker = {
      nume: getVal(row, idx.nume),
      lat, lng,
      loadNov25, loadNov24, avgHist,
      trend: trendStr,
      install: (getVal(row, idx.install).split(' ')[0] || ''),
      cap: getVal(row, idx.cap),
      model: getVal(row, idx.model),
      addr: getVal(row, idx.addr),
      city: getVal(row, idx.city),
      daysOff
    };
    data.lockers.push(locker);

    const m = L.circleMarker([lat,lng], {
      radius:7, fillColor:statusColors[status], color:'#000', weight:1, opacity:1, fillOpacity:0.85
    });

    /* --- POPUP NOU (FORMATUL CERUT) --- */
    const popupContent = `
      <div class="popup-header">${htmlEscape(locker.nume || 'easybox')}</div>

      <div class="popup-row"><span class="popup-label">üìç Loca»õie</span><span class="popup-value">${htmlEscape(locker.city || '-')}</span></div>
      <div class="popup-row"><span class="popup-label">üì¨ AdresƒÉ</span><span class="popup-value" style="font-size:10px; max-width:170px;">${htmlEscape(locker.addr || '-')}</span></div>

      <div class="popup-row"><span class="popup-label">üìä √éncƒÉrcare Nov 2025</span><span class="popup-value ${loadClass(locker.loadNov25)}">${fmtPct(locker.loadNov25)}</span></div>
      <div class="popup-row"><span class="popup-label">‚èÆÔ∏è Nov 2024</span><span class="popup-value">${fmtPct(locker.loadNov24)}</span></div>

      <div class="popup-row"><span class="popup-label">üìà Trend</span><span class="popup-value">${htmlEscape(trendWithIcon(locker.trend))}</span></div>
      <div class="popup-row"><span class="popup-label">‚öñÔ∏è Medie IstoricƒÉ</span><span class="popup-value">${fmtPct(locker.avgHist)}</span></div>

      <div class="popup-row"><span class="popup-label">üì¶ Capacitate</span><span class="popup-value">${htmlEscape(fmtNum1(locker.cap))}</span></div>
      <div class="popup-row"><span class="popup-label">‚è±Ô∏è Inactivare</span><span class="popup-value">${htmlEscape(locker.daysOff)} zile</span></div>
      <div class="popup-row"><span class="popup-label">üìÖ Instalare</span><span class="popup-value">${htmlEscape(fmtDate(locker.install))}</span></div>

      <div class="popup-row" style="border-bottom:none; padding-bottom:0; margin-bottom:0;">
        <span class="popup-label">üîß Model</span><span class="popup-value">${htmlEscape(locker.model || '-')}</span>
      </div>
    `;

    m.bindPopup(popupContent, { maxWidth: 360 }); // op»õional: limiteazƒÉ lƒÉ»õimea popup [web:120]
    layers[status].addLayer(m);
  });

  document.getElementById('totalVal').innerText = data.lockers.length;
  document.getElementById('criticVal').innerText = stats['Critic Urgent'] + stats['Critic Standard'];
  document.getElementById('warnVal').innerText = stats['Aten»õie'];
  document.getElementById('okVal').innerText = stats['Standard'];
  document.getElementById('statusLockers').innerText = `Actualizat: ${data.lockers.length} lockere`;
}

/* ------------------ 6) AWB CSV (op»õional) ------------------ */
function processAWB(csv){
  data.awb = {};
  const lines = csv.split(/\r?\n/).filter(x=>x.trim().length);
  lines.forEach(l=>{
    const c = splitCSV(l);
    const volIdx = c.findIndex(x=>String(x).toLowerCase().includes('nr total'));
    const cityIdx = c.findIndex(x=>String(x).toLowerCase().includes('localitate'));
    if(c.length>=2 && volIdx>-1 && cityIdx>-1){
      let volStr = String(c[volIdx]).replace(/"/g,'');
      if(volStr.includes(',')) volStr = volStr.replace(/,/g,'');
      const vol = parseInt(volStr,10);
      const city = c[cityIdx];
      if(city && !isNaN(vol)){
        const k = norm(city);
        data.awb[k] = (data.awb[k] || 0) + vol;
      }
    }
  });
  document.getElementById('statusAWB').innerText = 'Volume OK';
}

/* ------------------ 7) POP CSV ------------------ */
function processPop(csv){
  data.pop = {};
  const lines = csv.split(/\r?\n/).filter(x=>x.trim().length);
  lines.forEach(l=>{
    const c = splitCSV(l);
    let pop=0, city="";
    c.forEach(x=>{
      const n = parseInt(String(x).replace(/\./g,'').replace(/"/g,''),10);
      if(!isNaN(n) && n>100 && n<30000000) pop = n;
      if(String(x).length>2 && !/\d/.test(String(x))) city = x;
    });
    if(city){
      data.pop[norm(city)] = pop;
    }
  });
  document.getElementById('statusPop').innerText = 'Popula»õie OK';
}

/* ------------------ 8) CERCURI CSV (AWB per localitate) ------------------ */
function processCercuri(csv){
  // √Æl lƒÉsƒÉm neschimbat acum; revii tu cu fi»ôierul ok
  data.cercuri = [];
  document.getElementById('statusCercuri').innerText = 'Cercuri √ÆncƒÉrcat (validare pending)';
}

/* ------------------ 9) KPI localitate (date_lockere) ------------------ */
function getCityLockerCount(cityName){
  const key = norm(cityName);
  if(!key) return 0;
  return data.lockers.filter(l => norm(l.city) === key).length;
}
function lastYearKPIsForCity(cityName){
  const key = norm(cityName);
  const now = new Date();
  const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
  const inCity = data.lockers.filter(l => norm(l.city) === key);
  const installedLastYear = inCity.filter(l => {
    const d = parseISODateLoose(l.install);
    return d && d >= oneYearAgo;
  });
  const avgLoadLastYear = installedLastYear.length
    ? installedLastYear.reduce((s,l)=>s + (Number(l.avgHist)||0), 0) / installedLastYear.length
    : 0;
  const positiveSignal = (installedLastYear.length > 0 && avgLoadLastYear > 45);
  const negativeSignal = (installedLastYear.length === 0 || avgLoadLastYear <= 45);

  return {
    city: cityName,
    cityLockerCount: inCity.length,
    installedLastYearCount: installedLastYear.length,
    avgLoadInstalledLastYear: avgLoadLastYear,
    positiveSignal,
    negativeSignal
  };
}
function summarizeCercuriFor(judetName, localitateName){
  const j = norm(judetName);
  const loc = norm(localitateName);
  if(!j || !loc) return { total:0, byMonth:{}, rowsCount:0 };

  const rows = data.cercuri.filter(r => norm(r.judet)===j && norm(r.localitate)===loc);
  const byMonth = {};
  let total = 0;
  rows.forEach(r=>{
    const m = String(r.month).trim() || 'NA';
    byMonth[m] = (byMonth[m] || 0) + (r.totalAwb || 0);
    total += (r.totalAwb || 0);
  });
  return { total, byMonth, rowsCount: rows.length };
}

/* ------------------ 10) ANALIZE LOCALE (context AI) ------------------ */
function analyzeLocalData(lat, lng, cityName){
  const cityKey = norm(cityName);
  let pop = 0, awb = 0;
  for(const k in data.pop){ if(cityKey.includes(k)) pop = Math.max(pop, data.pop[k]); }
  for(const k in data.awb){ if(cityKey.includes(k)) awb = Math.max(awb, data.awb[k]); }

  const neighbors = [];
  const anchors = [];
  data.lockers.forEach(l=>{
    const d = getDist(lat,lng,l.lat,l.lng);
    if(d <= 500){
      neighbors.push({ name:l.nume, load:l.loadNov25, dist:d, city:l.city, install:l.install, avgHist:l.avgHist });
    }
    const n = (l.nume||'').toLowerCase();
    ANCHORS.forEach(tag=>{
      if(n.includes(tag) && !anchors.includes(tag)) anchors.push(tag);
    });
  });
  neighbors.sort((a,b)=>a.dist-b.dist);

  const kpis = lastYearKPIsForCity(cityName);
  return { pop, awb, neighbors, anchors, city: cityName, kpis };
}

/* ------------------ 11) SIMULARE (doar addMode) ------------------ */
function simulatePoint(lat, lng, meta){
  layers['Simulare'].clearLayers();

  const p = L.circleMarker([lat,lng], {
    radius:9, color:'#000', weight:1,
    fillColor:'#00ff88', fillOpacity:1
  }).addTo(layers['Simulare']);

  L.circle([lat,lng], { radius:200, color:'#00ff88', weight:2, fillOpacity:0.05 }).addTo(layers['Simulare']);
  L.circle([lat,lng], { radius:500, color:'#ff00cc', weight:2, fillOpacity:0.04 }).addTo(layers['Simulare']);

  const distList = (data.lockers||[])
    .map(l => ({ ...l, d: getDist(lat,lng,l.lat,l.lng) }))
    .sort((a,b)=>a.d-b.d);

  const within200 = distList.filter(x=>x.d<=200);
  const within500 = distList.filter(x=>x.d<=500);
  const nearest = distList.slice(0, 10);

  const nearestHtml = nearest.map(x => `
    <div class="popup-row">
      <span class="popup-label">${x.d} m</span>
      <span class="popup-value" style="max-width:190px; font-size:11px;">
        ${htmlEscape(x.nume||'Locker')}<br/>
        <span style="color:#aaa; font-weight:600;">${htmlEscape(x.city||'-')} ‚Ä¢ avg:${Number(x.avgHist||0).toFixed(1)}% ‚Ä¢ Nov25:${Number(x.loadNov25||0).toFixed(1)}%</span>
      </span>
    </div>
  `).join("");

  const judet = meta?.judet || "";
  const city = meta?.city || "Loca»õie";
  const sector = meta?.sector || "";

  const lockerCountCity = getCityLockerCount(city);
  const kpis = lastYearKPIsForCity(city);

  const cer = summarizeCercuriFor(judet, city);
  const cerMonths = Object.keys(cer.byMonth).sort((a,b)=>a.localeCompare(b)).slice(0, 6);
  const cerMonthsHtml = cerMonths.map(m => `
    <div class="popup-row"><span class="popup-label">AWB ${htmlEscape(m)}</span><span class="popup-value">${(cer.byMonth[m]||0).toLocaleString('ro-RO')}</span></div>
  `).join("");

  const monitorFlag = kpis.positiveSignal ? "POZITIV" : "NEGATIV";

  const html = `
    <div class="popup-header">Loca»õie simulatƒÉ</div>
    <div class="popup-row"><span class="popup-label">Coordonate</span><span class="popup-value">${lat.toFixed(5)}, ${lng.toFixed(5)}</span></div>
    <div class="popup-row"><span class="popup-label">Localitate</span><span class="popup-value">${htmlEscape(city)}</span></div>
    <div class="popup-row"><span class="popup-label">Jude»õ</span><span class="popup-value">${htmlEscape(judet || '-')}</span></div>
    <div class="popup-row"><span class="popup-label">Sector</span><span class="popup-value">${htmlEscape(sector || '-')}</span></div>

    <div class="popup-row"><span class="popup-label">Lockere (localitate)</span><span class="popup-value">${lockerCountCity}</span></div>
    <div class="popup-row"><span class="popup-label">Instalate ultimul an</span><span class="popup-value">${kpis.installedLastYearCount}</span></div>
    <div class="popup-row"><span class="popup-label">Avg load (ultimul an)</span><span class="popup-value">${kpis.avgLoadInstalledLastYear.toFixed(1)}%</span></div>
    <div class="popup-row"><span class="popup-label">Monitorizare</span><span class="popup-value ${kpis.positiveSignal?'val-high':'val-low'}">${monitorFlag}</span></div>

    <div class="popup-row"><span class="popup-label">Lockere ‚â§200m</span><span class="popup-value">${within200.length}</span></div>
    <div class="popup-row"><span class="popup-label">Lockere ‚â§500m</span><span class="popup-value">${within500.length}</span></div>

    <div class="popup-row"><span class="popup-label">AWB (cercuri.csv)</span><span class="popup-value">${cer.total ? cer.total.toLocaleString('ro-RO') : '-'}</span></div>
    ${cerMonthsHtml || ''}

    <div style="margin-top:10px; font-size:11px; color:#aaa;">Cele mai apropiate (top 10):</div>
    ${nearestHtml || "<div style='margin-top:6px; color:#aaa;'>Nu existƒÉ lockere √Æn dataset.</div>"}
  `;

  p.bindPopup(html).openPopup();
  return { within200, within500, nearest };
}

/* ------------------ 12) Reverse geocode (city/jude»õ/sector) ------------------ */
async function reverseMeta(lat, lng){
  const meta = { city:"Loca»õie", judet:"", sector:"" };
  try{
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
    const d = await r.json();
    const a = d.address || {};
    meta.city = a.city || a.town || a.village || a.municipality || meta.city;
    meta.judet = a.county || a.state || "";

    meta.sector = a.city_district || a.suburb || a.quarter || a.district || "";
    const secN = extractSectorNumber(meta.sector);
    if(secN) meta.sector = "Sector " + secN;
  }catch(e){}
  return meta;
}

/* ------------------ 13) PERPLEXITY AI ------------------ */
async function askPerplexity(question, contextData=null){
  const apiKey = document.getElementById('apiKey').value.trim();
  if(!apiKey){ alert('Te rog introdu cheia API Perplexity (pplx-....)'); return; }

  const responseBox = document.getElementById('aiResponse');
  responseBox.style.display = 'block';
  responseBox.innerHTML = '<i>Perplexity analizeazƒÉ datele...</i>';

  let systemPrompt = "E»ôti un expert logistic senior pentru re»õeaua easybox. Scopul este sƒÉ analizezi oportunitatea de expansiune/optimizare. RƒÉspunde √Æn limba rom√¢nƒÉ, concis »ôi bazat strict pe date.";

  if(contextData){
    systemPrompt += `\nDATE REALE PENTRU LOCA»öIE (${contextData.city}):` +
      `\n- Popula»õie estimatƒÉ: ${contextData.pop}` +
      `\n- Volum AWB (dacƒÉ existƒÉ): ${contextData.awb}` +
      `\n- Lockere existente √Æn 500m: ${JSON.stringify(contextData.neighbors)}` +
      `\n- Ancore comerciale: ${contextData.anchors.join(', ')}`;

    if(contextData.kpis){
      systemPrompt +=
        `\n- Monitorizare lockere instalate (localitate):` +
        `\n  ‚Ä¢ Lockere √Æn localitate: ${contextData.kpis.cityLockerCount}` +
        `\n  ‚Ä¢ Instalate √Æn ultimul an: ${contextData.kpis.installedLastYearCount}` +
        `\n  ‚Ä¢ √éncƒÉrcare medie (instalate √Æn ultimul an): ${contextData.kpis.avgLoadInstalledLastYear.toFixed(1)}%` +
        `\nINSTRUC»öIUNE DECIZIE:` +
        `\n- DacƒÉ existƒÉ lockere instalate √Æn ultimul an »ôi √ÆncƒÉrcarea medie a acestora este >45%, marcheazƒÉ acest aspect ca POZITIV »ôi fii mai √Ænclinat spre recomandare de extindere (dacƒÉ nu existƒÉ alte riscuri majore).` +
        `\n- DacƒÉ nu existƒÉ instalƒÉri √Æn ultimul an sau √ÆncƒÉrcarea medie este <=45%, marcheazƒÉ acest aspect ca NEGATIV »ôi fii mai conservator (optimizare √Ænainte de extindere).`;
    }
  }

  const messages = [
    { role:'system', content: systemPrompt },
    { role:'user', content: question }
  ];

  try{
    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method:'POST',
      headers:{
        'Authorization': 'Bearer ' + apiKey,
        'Content-Type':'application/json'
      },
      body: JSON.stringify({ model:'sonar-pro', messages })
    });

    const json = await response.json();
    if(json.error) throw new Error(json.error.message);
    const rawText = json.choices?.[0]?.message?.content ?? '(fƒÉrƒÉ rƒÉspuns)';
    responseBox.innerHTML = marked.parse(rawText);

    const cleanText = rawText.replace(/\n/g,' ').split('.').slice(0,2).join('. ') + '.';
    speak(cleanText);
  }catch(e){
    console.error(e);
    responseBox.innerText = 'Eroare API Perplexity: ' + e.message;
    speak('A apƒÉrut o eroare la conectarea cu Perplexity.');
  }
}

/* ------------------ 14) VOICE + INPUT ------------------ */
const synth = window.speechSynthesis;
let recognition=null;
let isListening=false;

function speak(text){
  try{
    if(synth.speaking) synth.cancel();
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang='ro-RO';
    synth.speak(utter);
  }catch(e){}
  document.getElementById('aiFeedback').innerText = text;
}

function toggleVoice(){
  if(!('webkitSpeechRecognition' in window)){ alert('NecesitƒÉ Chrome/Edge.'); return; }
  if(isListening){ recognition.stop(); return; }

  recognition = new webkitSpeechRecognition();
  recognition.lang='ro-RO';
  recognition.onstart = () => { isListening=true; document.getElementById('micBtn').classList.add('active'); };
  recognition.onend = () => { isListening=false; document.getElementById('micBtn').classList.remove('active'); };
  recognition.onresult = e => {
    const q = e.results[0][0].transcript;
    document.getElementById('searchInput').value = q;
    handleInput({ key:'Enter' }, true);
  };
  recognition.start();
}

function handleInput(e, fromVoice=false){
  if(e.key !== 'Enter' && !fromVoice) return;
  const q = document.getElementById('searchInput').value.trim();
  if(!q) return;

  if(q.toLowerCase().includes('scan')){
    const city = q.replace(/scaneaza\s*orasul/gi,'').trim();
    runAutoScanWrapper(city);
  }else{
    askPerplexity(q);
  }
}

/* ------------------ 15) AUTO-SCAN ------------------ */
async function runAutoScanWrapper(city){
  if(!city || city.length<3) return;
  speak('Analizez ' + city + '...');
  document.getElementById('loadBar').style.display='block';

  try{
    const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(city));
    const d = await r.json();
    if(!d.length){ speak('Loca»õie necunoscutƒÉ.'); return; }
    const b = d[0].boundingbox;
    map.fitBounds([[b[0],b[2]],[b[1],b[3]]]);

    const centerLat = (parseFloat(b[0])+parseFloat(b[1]))/2;
    const centerLng = (parseFloat(b[2])+parseFloat(b[3]))/2;

    const context = analyzeLocalData(centerLat, centerLng, city);
    askPerplexity('Raport de oportunitate pentru ' + city + '?', context);
  }catch(e){
    console.error(e);
  }finally{
    document.getElementById('loadBar').style.display='none';
  }
}
function startAutoScanWrapper(){
  const city = prompt('Introdu ora»ôul:');
  if(city) runAutoScanWrapper(city);
}

/* ------------------ 16) ADD MODE + CLICK HANDLER ------------------ */
function toggleAddMode(){
  addMode = !addMode;
  const btn = document.getElementById('addModeBtn');
  if(addMode){
    btn.innerText = 'STOP ANALIZƒÇ';
    btn.style.borderColor = '#ff3333';
    btn.style.color = '#ff3333';
    speak('Mod analizƒÉ punctualƒÉ activ.');
  }else{
    btn.innerText = 'ANALIZƒÇ PUNCTUALƒÇ';
    btn.style.borderColor = '#00ff88';
    btn.style.color = '#00ff88';
    layers['Simulare'].clearLayers();
    speak('Mod analizƒÉ punctualƒÉ oprit.');
  }
}

map.on('click', async e => {
  if(!addMode) return;

  const lat = e.latlng.lat;
  const lng = e.latlng.lng;

  const meta = await reverseMeta(lat, lng);
  simulatePoint(lat, lng, meta);

  const context = analyzeLocalData(lat, lng, meta.city);
  askPerplexity(`AnalizeazƒÉ poten»õialul unui locker aici: ${lat}, ${lng}`, context);
});

/* ------------------ 17) RESET ------------------ */
function resetAll(){
  Object.values(layers).forEach(l => l.clearLayers());
  document.getElementById('aiResponse').style.display = 'none';
  speak('Resetat.');
}
</script>
</body>
</html>
