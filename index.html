<!DOCTYPE html>
<html lang="ro">
<head>
  <script src="./config.js"></script>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QUEST DETECTIVE - EXPANSIUNE</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#222;
      --panel:rgba(18,22,33,.98);
      --panel2:#1a1e29;
      --border:#333;
      --text:#e0e0e0;
      --muted:#888;
      --accent:#00ff88;
      --danger:#ff3333;
      --pink:#ff00cc;
    }
    body{font-family:Inter,sans-serif;margin:0;padding:0;background:var(--bg);color:var(--text);overflow:hidden;font-size:14px;}
    #map{height:100vh;width:100%;position:relative;z-index:1;}

    .quest-panel{
      position:absolute;top:15px;left:15px;
      background:var(--panel);
      border:1px solid var(--border);
      width:390px;padding:18px;border-radius:12px;
      z-index:1000;box-shadow:0 0 30px rgba(0,0,0,.6);
      max-height:90vh;overflow-y:auto;
    }
    .quest-title{
      font-size:18px;font-weight:800;color:var(--accent);
      margin-bottom:12px;text-transform:uppercase;
      border-bottom:2px solid var(--accent);
      padding-bottom:10px;display:flex;justify-content:space-between;align-items:center;
      letter-spacing:.3px;
    }
    .quest-label{
      font-size:11px;font-weight:700;color:var(--muted);
      text-transform:uppercase;margin-bottom:6px;display:block;
    }
    .quest-input-group{
      margin-bottom:12px;background:var(--panel2);
      padding:10px;border-radius:10px;border:1px solid var(--border);
    }
    input[type="file"]{width:100%;font-size:11px;color:#ccc;border:none;background:transparent;}
    .api-input{
      width:100%;padding:8px;background:#000;border:1px solid var(--accent);
      color:var(--accent);font-family:monospace;border-radius:6px;box-sizing:border-box;font-size:11px;
    }
    .quest-search{
      width:100%;padding:10px;background:#111;border:1px solid #444;color:#fff;border-radius:8px;box-sizing:border-box;
    }
    .quest-search:focus{outline:none;border-color:var(--accent);}
    .quest-btn{
      width:100%;padding:10px;margin-top:6px;background:#111;border:1px solid var(--accent);
      color:var(--accent);font-weight:800;cursor:pointer;text-transform:uppercase;transition:.2s;border-radius:10px;
    }
    .quest-btn:hover{background:var(--accent);color:#000;}
    .btn-scan{border-color:var(--pink);color:var(--pink);}
    .btn-scan:hover{background:var(--pink);color:#fff;}
    .mic-btn{
      background:transparent;border:1px solid #444;color:#aaa;width:30px;height:30px;border-radius:50%;
      cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;
    }
    .mic-btn.active{border-color:var(--accent);color:var(--accent);box-shadow:0 0 10px rgba(0,255,136,.4);animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}

    #aiFeedback{font-size:11px;color:#aaa;margin-top:6px;min-height:15px;text-align:center;}
    .ai-response-box{
      background:rgba(0,255,136,.05);
      border:1px solid var(--accent);
      padding:10px;margin-top:10px;border-radius:10px;
      font-size:12px;line-height:1.45;color:#fff;display:none;
    }
    .ai-response-box p, .ai-response-box li{margin:.35em 0;}
    .ai-response-box ul{padding-left:18px;margin:.35em 0;}
    .ai-response-box h1,.ai-response-box h2,.ai-response-box h3{font-size:13px;margin:.4em 0;color:var(--accent);}

    .stats-container{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;}
    .stat-box{background:#111;border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center;}
    .stat-val{font-size:16px;font-weight:800;color:#fff;}
    .stat-name{font-size:9px;color:#666;text-transform:uppercase;}

    .loading-bar{height:3px;background:#333;width:100%;display:none;margin-top:6px;border-radius:3px;overflow:hidden;}
    .loading-fill{height:100%;background:var(--accent);width:0;transition:width .3s;}

    .leaflet-popup-content-wrapper{
      background:rgba(18,22,33,.98);color:#eee;border:1px solid #444;border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.8);
    }
    .leaflet-popup-content{width:320px !important;margin:14px;}
    .leaflet-popup-tip{background:#1a1e29;}
    .popup-header{
      font-weight:900;color:var(--accent);font-size:14px;text-align:center;
      margin-bottom:10px;border-bottom:1px solid #444;padding-bottom:8px;
    }
    .popup-row{
      display:flex;justify-content:space-between;gap:10px;align-items:flex-start;
      font-size:12px;margin-bottom:6px;border-bottom:1px dashed #333;padding-bottom:5px;
    }
    .popup-label{color:#9aa0a6;font-weight:700;min-width:150px;}
    .popup-value{font-weight:700;color:#fff;text-align:right;flex:1;word-break:break-word;}
    ::-webkit-scrollbar{width:6px;}
    ::-webkit-scrollbar-track{background:#111;}
    ::-webkit-scrollbar-thumb{background:#333;border-radius:3px;}

    /* Layer control - sƒÉ arate ok pe dark */
    .leaflet-control-layers{
      background:rgba(18,22,33,.92);
      color:#fff;
      border:1px solid #333;
      border-radius:10px;
      box-shadow:0 10px 30px rgba(0,0,0,.6);
    }
    .leaflet-control-layers label{color:#ddd;}
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="quest-panel">
    <div class="quest-title">
      QUEST DETECTIVE
      <button class="mic-btn" id="micBtn" onclick="toggleVoice()" title="Microfon">üéô</button>
    </div>

    <div class="quest-input-group" style="border-color:var(--accent);">
      <span class="quest-label" style="color:var(--accent);">PERPLEXITY API KEY</span>
      <input type="password" id="apiKey" class="api-input" placeholder="pplx-xxxxxxxxxxxxxxxxxxxx"/>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">1. LOCKERE (CSV)</span>
      <input type="file" onchange="handleFileUpload(this,'lockers')"/>
      <div id="statusLockers" style="font-size:10px;color:#555;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">2. VOLUME AWB (CSV)</span>
      <input type="file" onchange="handleFileUpload(this,'awb')"/>
      <div id="statusAWB" style="font-size:10px;color:#555;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">3. POPULA»öIE (CSV)</span>
      <input type="file" onchange="handleFileUpload(this,'pop')"/>
      <div id="statusPop" style="font-size:10px;color:#555;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">CƒÇUTARE LOCKER / ADRESƒÇ</span>
      <input type="text" id="lockerSearch" class="quest-search" placeholder="Ex: Jolie Ville / Muncii 23 / nume locker" onkeyup="searchLockerUI(event)"/>
      <div id="lockerSearchStatus" style="font-size:10px;color:#555;margin-top:6px;"></div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">ASISTENT INTELIGENT</span>
      <input type="text" id="searchInput" class="quest-search" placeholder="Ex: AnalizeazƒÉ Baicului..." onkeyup="handleInput(event)"/>
      <div id="aiFeedback">Sistem gata.</div>
      <div id="aiResponse" class="ai-response-box"></div>
    </div>

    <button onclick="startAutoScan()" class="quest-btn btn-scan">AUTO-SCAN ZONƒÇ</button>
    <button onclick="toggleAddMode()" id="addModeBtn" class="quest-btn">ANALIZƒÇ PUNCTUALƒÇ</button>
    <button onclick="resetAll()" class="quest-btn" style="border-color:var(--danger);color:var(--danger);">RESET</button>

    <div class="stats-container">
      <div class="stat-box"><div class="stat-val" id="totalVal">0</div><div class="stat-name">Lockere</div></div>
      <div class="stat-box"><div class="stat-val" style="color:#ff0033;" id="criticVal">0</div><div class="stat-name">Critic U</div></div>
      <div class="stat-box"><div class="stat-val" style="color:#ffae00;" id="warnVal">0</div><div class="stat-name">Aten»õie</div></div>
      <div class="stat-box"><div class="stat-val" style="color:var(--accent);" id="okVal">0</div><div class="stat-name">Standard</div></div>
    </div>

    <div class="loading-bar" id="loadBar"><div class="loading-fill" id="loadFill"></div></div>
  </div>

<script>
/* ===========================
   1) HARTƒÇ + BASEMAPS (Light/Satelit)
=========================== */
const baseLight = L.tileLayer(
  'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
  { attribution:'CARTO' }
);

// ESRI World Imagery (satelit)
const baseSat = L.tileLayer(
  'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
  { attribution:'Esri' }
);

const map = L.map('map', { zoomControl:false, layers:[baseLight] }).setView([46.00, 25.00], 7);
L.control.zoom({ position:'topright' }).addTo(map);

/* ===========================
   2) DATA + LAYERS
=========================== */
let data = {
  lockers: [],
  awbJL: {}, awbJLM: {},
  popJL: {}
};

let detectedMonths = [];
let addMode = false;

const ANCHORS = ['kaufland','lidl','carrefour','auchan','mega','profi','mall','plaza','piata','residence','complex','gara','universitate','spital','market'];
const MONTHS = { ianuarie:0,februarie:1,martie:2,aprilie:3,mai:4,iunie:5,iulie:6,august:7,septembrie:8,octombrie:9,noiembrie:10,decembrie:11 };

const statusColors = {
  'Critic Urgent':'#d60000',
  'Critic Standard':'#e67e22',
  'Aten»õie':'#f1c40f',
  'Standard':'#27ae60'
};

/* Layere: clasificare + simulare + impact */
const layers = {
  'Critic Urgent': L.layerGroup(),
  'Critic Standard': L.layerGroup(),
  'Aten»õie': L.layerGroup(),
  'Standard': L.layerGroup(),
  'Propuneri': L.layerGroup(),
  'Impact 200m': L.layerGroup(),
  'Impact 500m': L.layerGroup()
};

// Le adƒÉugƒÉm ini»õial pe hartƒÉ
layers['Critic Urgent'].addTo(map);
layers['Critic Standard'].addTo(map);
layers['Aten»õie'].addTo(map);
layers['Standard'].addTo(map);
layers['Propuneri'].addTo(map);
layers['Impact 200m'].addTo(map);
layers['Impact 500m'].addTo(map);

/* Layer control (basemap + overlays) */
L.control.layers(
  { 'Light': baseLight, 'Satelit': baseSat },
  {
    'Critic Urgent': layers['Critic Urgent'],
    'Critic Standard': layers['Critic Standard'],
    'Aten»õie': layers['Aten»õie'],
    'Standard': layers['Standard'],
    'Propuneri': layers['Propuneri'],
    'Impact 200m': layers['Impact 200m'],
    'Impact 500m': layers['Impact 500m']
  },
  { collapsed:true }
).addTo(map);

/* Search index pentru lockere */
let lockerMarkers = []; // [{ marker, locker }]

/* ===========================
   3) UTILS
=========================== */
function splitCSV(str){
  const res = [];
  let curr = '';
  let inQt = false;
  for(let i=0;i<str.length;i++){
    const c = str[i];
    if(c === '"'){ inQt = !inQt; continue; }
    if(c === ',' && !inQt){ res.push(curr.trim()); curr = ''; continue; }
    curr += c;
  }
  res.push(curr.trim());
  return res;
}

function norm(s){
  return s ? String(s).toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9 ]/g,' ')
    .replace(/\s+/g,' ')
    .trim() : '';
}

function parseIntSafe(x){
  if(x === null || x === undefined) return NaN;
  const t = String(x).replace(/"/g,'').trim().replace(/,/g,'').replace(/\./g,'');
  const n = parseInt(t, 10);
  return isNaN(n) ? NaN : n;
}

function parseLoadPercent(raw){
  if(raw === null || raw === undefined) return NaN;
  let s = String(raw).replace(/"/g,'').trim();
  if(!s) return NaN;

  s = s.replace('%','').trim();
  s = s.replace(/\s+/g,'');
  if(s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
  if(s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');

  const v = parseFloat(s);
  if(isNaN(v)) return NaN;

  if(v >= 0 && v <= 1.5) return v * 100;
  if(v > 1.5 && v <= 250) return v;
  return NaN;
}

function canonJudet(rawJudet, rawLocalitate=''){
  const j = norm(rawJudet);
  const loc = norm(rawLocalitate);
  const looksLikeBuc = j.includes('bucuresti') || j.includes('bucharest') || loc.includes('sector ');
  const looksLikeIlf = j.includes('ilfov');
  if(looksLikeBuc || looksLikeIlf) return 'bucuresti ilfov';
  return j;
}

function makeJLKey(judetRaw, localitateRaw){
  const j = canonJudet(judetRaw, localitateRaw);
  const l = norm(localitateRaw);
  if(!j || !l) return '';
  return `${j}||${l}`;
}

function getDist(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const a = Math.sin((lat2-lat1)*Math.PI/360)**2 +
            Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
            Math.sin((lon2-lon1)*Math.PI/360)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function ymdToDate(ymd){
  // acceptƒÉ '2021-06-23' sau cu timp
  if(!ymd) return null;
  const s = String(ymd).trim().slice(0,10);
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
}

function monthsAgo(d){
  if(!d) return Infinity;
  const now = new Date();
  const months = (now.getFullYear()-d.getFullYear())*12 + (now.getMonth()-d.getMonth());
  return months;
}

/* ===========================
   4) UPLOAD HANDLER
=========================== */
function handleFileUpload(input, type){
  const file = input.files[0];
  if(!file) return;

  const r = new FileReader();
  r.onload = e => {
    const t = e.target.result;
    if(type === 'lockers') processLockers(t);
    if(type === 'awb') processAWB(t);
    if(type === 'pop') processPop(t);

    const el = document.getElementById('status' + type.charAt(0).toUpperCase() + type.slice(1));
    if(el) el.innerText = '√éncƒÉrcat';
    speak('Fi»ôierul ' + type + ' a fost procesat.');
  };
  r.readAsText(file);
}

/* ===========================
   5) LOCKERS CSV
=========================== */
function processLockers(csv){
  Object.values(layers).forEach(g => g.clearLayers());
  lockerMarkers = [];
  data.lockers = [];

  const stats = {'Critic Urgent':0,'Critic Standard':0,'Aten»õie':0,'Standard':0};

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2) return;

  const h = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());

  detectedMonths = [];
  h.forEach((col, idx) => {
    const m = col.match(/([a-zA-Z]+)\s+(\d{4})/);
    if(m && !col.toLowerCase().includes('inactiv')){
      const mon = m[1].toLowerCase();
      const yr = parseInt(m[2],10);
      if(MONTHS.hasOwnProperty(mon)){
        detectedMonths.push({ name: col, idx, val: yr*12 + MONTHS[mon] });
      }
    }
  });
  detectedMonths.sort((a,b)=>a.val-b.val);

  const idxNov25 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2025') && !x.toLowerCase().includes('inactiv'));
  const idxNov24 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2024') && !x.toLowerCase().includes('inactiv'));

  const idx = {
    nume: h.indexOf('Locker Nume'),
    lat: h.indexOf('Latitudine'),
    lng: h.indexOf('Longitudine'),
    install: h.indexOf('Data instalare'),
    cap: h.indexOf('Capacitate locker'),
    addr: h.indexOf('Adresa'),
    model: h.indexOf('Model'),
    city: h.indexOf('Locker Oras'),
    inactiv: h.findIndex(x => x.toLowerCase().includes('inactiv'))
  };

  const getVal = (row,i) => i>-1 ? (row[i] ?? '').replace(/"/g,'').trim() : '';

  lines.slice(1).forEach(l => {
    const row = splitCSV(l);
    if(row.length < h.length) return;

    const lat = parseFloat(getVal(row, idx.lat));
    const lng = parseFloat(getVal(row, idx.lng));
    if(isNaN(lat) || isNaN(lng)) return;

    // Istoric + luni valide
    let historyValues = [];
    let monthsWithData = 0;

    detectedMonths.forEach(m => {
      const p = parseLoadPercent(getVal(row, m.idx));
      if(!isNaN(p)){
        historyValues.push(p);
        monthsWithData++;
      }
    });

    let avgHist = 0;
    if(historyValues.length){
      avgHist = historyValues.reduce((a,b)=>a+b,0) / historyValues.length;
    }

    // Load nov
    let loadNov25 = 0, loadNov24 = 0;
    if(idxNov25 > -1){
      const p = parseLoadPercent(getVal(row, idxNov25));
      loadNov25 = isNaN(p) ? 0 : p;
    }
    if(idxNov24 > -1){
      const p = parseLoadPercent(getVal(row, idxNov24));
      loadNov24 = isNaN(p) ? 0 : p;
    }

    let trendStr = 'Stabil';
    if(loadNov25 > loadNov24 + 5) trendStr = 'Peste medie';
    else if(loadNov25 < loadNov24 - 5) trendStr = 'Sub medie';

    const daysOff = parseIntSafe(getVal(row, idx.inactiv)) || 0;
    const cleanInst = (getVal(row, idx.install) || '').split(' ')[0];
    const installDate = ymdToDate(cleanInst);
    const installMonthsAgo = monthsAgo(installDate);

    let status = 'Standard';
    if(loadNov25 >= 95 || daysOff > 5) status = 'Critic Urgent';
    else if(loadNov25 >= 85) status = 'Critic Standard';
    else if(loadNov25 >= 75) status = 'Aten»õie';

    stats[status]++;

    const locker = {
      nume: getVal(row, idx.nume),
      lat, lng,
      loadNov25, loadNov24,
      avgHist,
      trend: trendStr,
      monthsWithData,
      install: cleanInst,
      installMonthsAgo,
      cap: getVal(row, idx.cap),
      model: getVal(row, idx.model),
      addr: getVal(row, idx.addr),
      city: getVal(row, idx.city),
      daysOff
    };

    data.lockers.push(locker);

    const marker = L.circleMarker([lat,lng], {
      radius: 7,
      fillColor: statusColors[status],
      color: '#000',
      weight: 1,
      opacity: 1,
      fillOpacity: 0.85
    });

    const trendIcon = locker.trend === 'Peste medie' ? 'üìà' : (locker.trend === 'Sub medie' ? 'üìâ' : '‚û°Ô∏è');
    const monthsText = `${locker.monthsWithData || 0}/12`;

    const popupContent = `
      <div class="popup-header">${locker.nume || '-'}</div>

      <div class="popup-row"><span class="popup-label">üìç Loca»õie:</span><span class="popup-value">${locker.city || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">üì¨ AdresƒÉ:</span><span class="popup-value">${locker.addr || '-'}</span></div>

      <div class="popup-row"><span class="popup-label">üìä √éncƒÉrcare Nov 2025:</span><span class="popup-value">${(locker.loadNov25 || 0).toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">‚èÆÔ∏è Nov 2024:</span><span class="popup-value">${(locker.loadNov24 || 0).toFixed(1)}%</span></div>

      <div class="popup-row"><span class="popup-label">üìà Trend:</span><span class="popup-value">${trendIcon} ${locker.trend || 'Stabil'}</span></div>
      <div class="popup-row"><span class="popup-label">‚öñÔ∏è Medie IstoricƒÉ:</span><span class="popup-value">${(locker.avgHist || 0).toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">üóìÔ∏è Luni ultim an:</span><span class="popup-value">${monthsText}</span></div>

      <div class="popup-row"><span class="popup-label">üì¶ Capacitate:</span><span class="popup-value">${locker.cap || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">‚è±Ô∏è Inactivare:</span><span class="popup-value">${locker.daysOff || 0} zile</span></div>
      <div class="popup-row"><span class="popup-label">üìÖ Instalare:</span><span class="popup-value">${locker.install || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">üîß Model:</span><span class="popup-value">${locker.model || '-'}</span></div>
    `;

    marker.bindPopup(popupContent);
    layers[status].addLayer(marker);
    lockerMarkers.push({ marker, locker });
  });

  document.getElementById('totalVal').innerText = data.lockers.length;
  document.getElementById('criticVal').innerText = stats['Critic Urgent'];
  document.getElementById('warnVal').innerText = stats['Aten»õie'];
  document.getElementById('okVal').innerText = stats['Standard'];
  document.getElementById('statusLockers').innerText = `Actualizat: ${data.lockers.length} unitƒÉ»õi`;
}

/* ===========================
   6) AWB CSV (jude»õ + localitate)
=========================== */
function processAWB(csv){
  data.awbJL = {};
  data.awbJLM = {};

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){ document.getElementById('statusAWB').innerText = 'AWB: fi»ôier gol'; return; }

  const header = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const hNorm = header.map(norm);

  const idxMonth = hNorm.findIndex(x => x === 'month' || x.includes('month'));
  const idxJudet = hNorm.findIndex(x => x.includes('judet') && x.includes('destinatar'));
  const idxLoc   = hNorm.findIndex(x => x.includes('localitate') && x.includes('destinatar'));
  const idxTot   = hNorm.findIndex(x => x.includes('nr') && x.includes('total') && x.includes('awb'));

  if(idxJudet < 0 || idxLoc < 0 || idxTot < 0){
    document.getElementById('statusAWB').innerText = 'AWB: header neidentificat';
    return;
  }

  let ok = 0;
  for(const l of lines.slice(1)){
    const row = splitCSV(l);

    const monthRaw = idxMonth >= 0 ? (row[idxMonth] ?? '') : '';
    const judetRaw = (row[idxJudet] ?? '');
    const locRaw   = (row[idxLoc] ?? '');
    const totRaw   = (row[idxTot] ?? '');

    const month = String(monthRaw).replace(/"/g,'').trim();
    const judet = String(judetRaw).replace(/"/g,'').trim();
    const loc   = String(locRaw).replace(/"/g,'').trim();
    if(!judet || !loc) continue;

    const awb = parseIntSafe(totRaw);
    if(isNaN(awb) || awb < 0) continue;

    const jlKey = makeJLKey(judet, loc);
    if(!jlKey) continue;

    data.awbJL[jlKey] = (data.awbJL[jlKey] || 0) + awb;

    if(month){
      const mKey = norm(month);
      const jlmKey = `${mKey}||${jlKey}`;
      data.awbJLM[jlmKey] = (data.awbJLM[jlmKey] || 0) + awb;
    }
    ok++;
  }

  document.getElementById('statusAWB').innerText = `AWB OK: ${ok} r√¢nduri`;
}

/* ===========================
   7) POPULA»öIE CSV (jude»õ + localitate)
=========================== */
function processPop(csv){
  data.popJL = {};

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){ document.getElementById('statusPop').innerText = 'POP: fi»ôier gol'; return; }

  const first = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const fNorm = first.map(norm);

  const hasHeader = fNorm.includes('judet') && (fNorm.includes('localitate') || fNorm.includes('localitatea')) && fNorm.join(' ').includes('pop');

  let ok = 0;

  if(hasHeader){
    const idxJ = fNorm.findIndex(x => x === 'judet' || x.includes('judet'));
    const idxL = fNorm.findIndex(x => x === 'localitate' || x.includes('localit'));
    const idxP = fNorm.findIndex(x => x.includes('pop'));

    for(const l of lines.slice(1)){
      const row = splitCSV(l);
      const judet = (row[idxJ] ?? '').replace(/"/g,'').trim();
      const loc   = (row[idxL] ?? '').replace(/"/g,'').trim();
      const pop   = parseIntSafe(row[idxP] ?? '');
      if(!judet || !loc || isNaN(pop)) continue;

      const key = makeJLKey(judet, loc);
      if(!key) continue;

      data.popJL[key] = Math.max(data.popJL[key] || 0, pop);
      ok++;
    }
  } else {
    for(const l of lines.slice(1)){
      const line = l.replace(/"/g,'').trim();
      if(!line) continue;

      const parts = line.split(/\s+/);
      if(parts.length < 3) continue;

      const pop = parseIntSafe(parts[parts.length - 1]);
      if(isNaN(pop)) continue;

      const judet = parts[0];
      const loc = parts.slice(1, parts.length - 1).join(' ');
      const key = makeJLKey(judet, loc);
      if(!key) continue;

      data.popJL[key] = Math.max(data.popJL[key] || 0, pop);
      ok++;
    }
  }

  document.getElementById('statusPop').innerText = `POP OK: ${ok} r√¢nduri`;
}

/* ===========================
   8) LOOKUPS
=========================== */
function getAwbFor(judetName, localitateName){
  const key = makeJLKey(judetName, localitateName);
  return key && data.awbJL[key] ? data.awbJL[key] : 0;
}
function getPopFor(judetName, localitateName){
  const key = makeJLKey(judetName, localitateName);
  return key && data.popJL[key] ? data.popJL[key] : 0;
}

/* ===========================
   9) ZONE METRICS (din lockere)
=========================== */
function zoneMetrics(lat, lng){
  const within200 = [];
  const within500 = [];
  const within1500 = [];

  data.lockers.forEach(l => {
    const d = getDist(lat, lng, l.lat, l.lng);
    if(d <= 200) within200.push({ locker:l, dist:d });
    if(d <= 500) within500.push({ locker:l, dist:d });
    if(d <= 1500) within1500.push({ locker:l, dist:d });
  });

  function summarize(list){
    if(!list.length) return { count:0, avgLoad:0, avgTrendDelta:0, installs12:0, top:[] };

    // avg load (Nov25)
    const loads = list.map(x=>x.locker.loadNov25).filter(v=>typeof v==='number' && v>0);
    const avgLoad = loads.length ? loads.reduce((a,b)=>a+b,0)/loads.length : 0;

    // trend delta (Nov25 - Nov24)
    const deltas = list.map(x => (x.locker.loadNov25||0) - (x.locker.loadNov24||0));
    const avgTrendDelta = deltas.length ? deltas.reduce((a,b)=>a+b,0)/deltas.length : 0;

    // instalƒÉri √Æn ultimele 12 luni
    const installs12 = list.filter(x => (x.locker.installMonthsAgo||Infinity) <= 12).length;

    // top 8 dupƒÉ load
    const top = list
      .slice()
      .sort((a,b)=>(b.locker.loadNov25||0)-(a.locker.loadNov25||0))
      .slice(0,8)
      .map(x=>({
        name:x.locker.nume,
        city:x.locker.city,
        load: +(x.locker.loadNov25||0).toFixed(1),
        off:x.locker.daysOff||0,
        dist:x.dist
      }));

    return { count:list.length, avgLoad:+avgLoad.toFixed(1), avgTrendDelta:+avgTrendDelta.toFixed(1), installs12, top };
  }

  return {
    r200: summarize(within200),
    r500: summarize(within500),
    r1500: summarize(within1500)
  };
}

function analyzeLocalData(lat, lng, cityName, judetName){
  const pop = judetName ? getPopFor(judetName, cityName) : 0;
  const awb = judetName ? getAwbFor(judetName, cityName) : 0;

  const metrics = zoneMetrics(lat, lng);

  const anchors = [];
  // Ancore din top 1500 (proxy)
  (metrics.r1500.top || []).forEach(x=>{
    const n = (x.name||'').toLowerCase();
    ANCHORS.forEach(tag => { if(n.includes(tag) && !anchors.includes(tag)) anchors.push(tag); });
  });

  return {
    pop, awb,
    city: cityName, judet: judetName || '',
    metrics,
    anchors
  };
}

/* ===========================
   10) IMPACT CIRCLES (200/500)
=========================== */
function drawImpactCircles(latlng){
  layers['Impact 200m'].clearLayers();
  layers['Impact 500m'].clearLayers();

  const c200 = L.circle(latlng, {
    radius: 200,
    color: '#00ff88',
    weight: 2,
    fillColor: '#00ff88',
    fillOpacity: 0.08
  });

  const c500 = L.circle(latlng, {
    radius: 500,
    color: '#ff00cc',
    weight: 2,
    fillColor: '#ff00cc',
    fillOpacity: 0.06
  });

  layers['Impact 200m'].addLayer(c200);
  layers['Impact 500m'].addLayer(c500);
}

/* ===========================
   11) CƒÇUTARE LOCKER / ADRESƒÇ
=========================== */
function searchLockers(query){
  const q = norm(query);
  if(!q) return [];
  const scored = lockerMarkers.map(x => {
    const name = norm(x.locker.nume || '');
    const addr = norm(x.locker.addr || '');
    const city = norm(x.locker.city || '');
    let score = 0;
    if(name.includes(q)) score += 3;
    if(addr.includes(q)) score += 2;
    if(city.includes(q)) score += 1;
    return { ...x, score };
  }).filter(x => x.score > 0);

  scored.sort((a,b)=>b.score-a.score);
  return scored.slice(0, 10);
}

function focusLocker(result){
  const { marker } = result;
  map.setView(marker.getLatLng(), 17, { animate:true });
  marker.openPopup();
}

function searchLockerUI(e){
  if(e.key !== 'Enter') return;

  const q = document.getElementById('lockerSearch').value;
  const hits = searchLockers(q);
  const st = document.getElementById('lockerSearchStatus');

  if(!hits.length){ st.innerText = 'Niciun rezultat.'; return; }

  if(!searchLockerUI._idx || searchLockerUI._lastQ !== norm(q)){
    searchLockerUI._idx = 0;
    searchLockerUI._lastQ = norm(q);
  } else {
    searchLockerUI._idx = (searchLockerUI._idx + 1) % hits.length;
  }

  st.innerText = `GƒÉsite ${hits.length}. Rezultat ${searchLockerUI._idx+1}/${hits.length}. (Enter pentru urmƒÉtorul)`;
  focusLocker(hits[searchLockerUI._idx]);
}

/* ===========================
   12) PERPLEXITY API - PROMPT ‚ÄúCAPACITATE‚Äù
=========================== */
async function askPerplexity(question, contextData=null){
  const apiKey = document.getElementById('apiKey').value.trim();
  if(!apiKey){ alert('Te rog introdu cheia API Perplexity (pplx-....)'); return; }

  const responseBox = document.getElementById('aiResponse');
  responseBox.style.display = 'block';
  responseBox.innerHTML = '<i>Perplexity analizeazƒÉ datele...</i>';

  // Prompt: zonƒÉ aglomeratƒÉ => nevoie capacitate, trend ascendent => instalare nouƒÉ recomandatƒÉ
  let systemPrompt =
`E»ôti un expert logistic senior pentru re»õeaua easybox.
Obiectiv: decizie opera»õionalƒÉ pentru CAPACITATE (upsize / locker nou / relocare) bazatƒÉ strict pe datele furnizate.

Reguli de interpretare:
- "ZonƒÉ aglomeratƒÉ" = √ÆncƒÉrcare medie ridicatƒÉ »ôi/sau lockere apropiate √Æn stare criticƒÉ; rezultatul trebuie sƒÉ recomande CAPACITATE SUPLIMENTARƒÇ.
- DacƒÉ trendul zonei este ascendent (delta medie pozitivƒÉ Nov2025 vs Nov2024 sau multe lockere √Æn "Peste medie"), atunci recomandƒÉ instalarea unui locker nou; explicƒÉ de ce zona va deveni congestionatƒÉ √Æn scurt timp.
- Folose»ôte c√¢t mai mult din datele lockere: √ÆncƒÉrcare medie pe raze (200/500/1500m), trend delta mediu, top lockere cu √ÆncƒÉrcare mare, numƒÉr instalƒÉri √Æn ultimele 12 luni (proxy de expansiune), inactivƒÉri.
- RƒÉspunde √Æn limba rom√¢nƒÉ, structurat √Æn 4 sec»õiuni scurte:
1) Diagnostic zonƒÉ (200m/500m/1500m)
2) Riscuri (congestie, inactivƒÉri, lipsƒÉ capacitate)
3) Recomandare (locker nou / upsize / optimizare) + unde (raza recomandatƒÉ)
4) Lockere "hotspots" (max 5, cu distan»õƒÉ »ôi √ÆncƒÉrcare)
FƒÉrƒÉ introduceri. FƒÉrƒÉ generalitƒÉ»õi.`;

  if(contextData){
    const m = contextData.metrics || {};
    systemPrompt +=
`\n\nDATE REALE PENTRU LOCA»öIA: ${contextData.city} (${contextData.judet})
- Popula»õie (localitate): ${contextData.pop}
- Volum AWB (localitate): ${contextData.awb}
- Ancore detectate: ${(contextData.anchors||[]).join(', ')}

METRICI DIN LOCKERE:
- 200m: lockere=${m.r200?.count||0}, avgLoadNov25=${m.r200?.avgLoad||0}%, avgDelta=${m.r200?.avgTrendDelta||0}, instalƒÉri12L=${m.r200?.installs12||0}
- 500m: lockere=${m.r500?.count||0}, avgLoadNov25=${m.r500?.avgLoad||0}%, avgDelta=${m.r500?.avgTrendDelta||0}, instalƒÉri12L=${m.r500?.installs12||0}
- 1500m: lockere=${m.r1500?.count||0}, avgLoadNov25=${m.r1500?.avgLoad||0}%, avgDelta=${m.r1500?.avgTrendDelta||0}, instalƒÉri12L=${m.r1500?.installs12||0}

TOP lockere (1500m, dupƒÉ √ÆncƒÉrcare): ${JSON.stringify(m.r1500?.top||[])}`
  }

  const messages = [
    { role:'system', content: systemPrompt },
    { role:'user', content: question }
  ];

  try{
    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method:'POST',
      headers:{ 'Authorization':'Bearer ' + apiKey, 'Content-Type':'application/json' },
      body: JSON.stringify({ model:'sonar-pro', messages })
    });

    const json = await response.json();
    if(json.error) throw new Error(json.error.message);

    const rawText = json.choices[0].message.content;
    responseBox.innerHTML = marked.parse(rawText);

    const cleanText = rawText.replace(/\n/g,' ').split('.').slice(0,2).join('. ');
    speak(cleanText);
  } catch(e){
    console.error(e);
    responseBox.innerText = 'Eroare API Perplexity: ' + e.message;
    speak('A apƒÉrut o eroare la conectarea cu Perplexity.');
  }
}

/* ===========================
   13) VOICE
=========================== */
const synth = window.speechSynthesis;
let recognition = null;
let isListening = false;

function speak(text){
  if(!text) return;
  if(synth.speaking) synth.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ro-RO';
  synth.speak(utter);
  document.getElementById('aiFeedback').innerText = text;
}

function toggleVoice(){
  if(!('webkitSpeechRecognition' in window)){
    alert('NecesitƒÉ Chrome/Edge.');
    return;
  }
  if(isListening){ recognition.stop(); return; }

  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ro-RO';
  recognition.onstart = () => { isListening=true; document.getElementById('micBtn').classList.add('active'); };
  recognition.onend = () => { isListening=false; document.getElementById('micBtn').classList.remove('active'); };
  recognition.onresult = e => {
    const q = e.results[0][0].transcript;
    document.getElementById('searchInput').value = q;
    handleInput({ key:'Enter', target:{ value:q } }, true);
  };
  recognition.start();
}

function handleInput(e, fromVoice=false){
  if(e.key !== 'Enter' && !fromVoice) return;
  const q = document.getElementById('searchInput').value.trim();
  if(!q) return;

  if(q.toLowerCase().includes('scan')){
    const city = q.replace(/scaneaza|scaneazƒÉ|orasul|ora»ôul/gi,'').trim();
    startAutoScan(city);
  } else {
    askPerplexity(q);
  }
}

/* ===========================
   14) AUTO-SCAN / SIMULARE + CERCURI IMPACT
=========================== */
async function startAutoScan(cityFromParam=null){
  let city = cityFromParam;
  if(!city){
    city = prompt('Introdu localitatea / zona pentru scan:');
    if(!city) return;
  }

  speak('Analizez ' + city + '...');
  const loadBar = document.getElementById('loadBar');
  const loadFill = document.getElementById('loadFill');
  loadBar.style.display = 'block';
  loadFill.style.width = '25%';

  try{
    const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=' + encodeURIComponent(city));
    const d = await r.json();
    if(!d.length){
      speak('Loca»õie necunoscutƒÉ.');
      loadBar.style.display = 'none';
      return;
    }

    loadFill.style.width = '55%';

    const b = d[0].boundingbox;
    map.fitBounds([[b[0], b[2]], [b[1], b[3]]]);

    const centerLat = (parseFloat(b[0]) + parseFloat(b[1])) / 2;
    const centerLng = (parseFloat(b[2]) + parseFloat(b[3])) / 2;
    const center = L.latLng(centerLat, centerLng);

    // impact circles la simulare
    drawImpactCircles(center);

    // marker simulare
    layers['Propuneri'].addLayer(
      L.circleMarker(center, { radius: 10, color:'#fff', fillColor:'#ff00cc', fillOpacity:1 })
    );

    // Reverse pentru jude»õ + localitate ‚ÄúrealƒÉ‚Äù
    const rr = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=' + centerLat + '&lon=' + centerLng);
    const rd = await rr.json();
    const addr = rd.address || {};
    const locName = addr.city || addr.town || addr.village || city;
    const judName = addr.county || addr.state || addr.region || '';

    loadFill.style.width = '85%';

    const context = analyzeLocalData(centerLat, centerLng, locName, judName);
    await askPerplexity('Raport de oportunitate pentru zona simulatƒÉ: ' + locName + '?', context);

    loadFill.style.width = '100%';
    setTimeout(()=>{ loadBar.style.display='none'; loadFill.style.width='0%'; }, 300);
  } catch(e){
    console.error(e);
    loadBar.style.display = 'none';
  }
}

/* ===========================
   15) ANALIZƒÇ PUNCTUALƒÇ (CLICK) + CERCURI
=========================== */
function toggleAddMode(){
  addMode = !addMode;
  const btn = document.getElementById('addModeBtn');
  if(addMode){
    btn.innerText = 'STOP ANALIZƒÇ';
    btn.style.borderColor = '#ff3333';
    btn.style.color = '#ff3333';
  } else {
    btn.innerText = 'ANALIZƒÇ PUNCTUALƒÇ';
    btn.style.borderColor = '#00ff88';
    btn.style.color = '#00ff88';
  }
}

map.on('click', async e => {
  if(!addMode) return;

  drawImpactCircles(e.latlng);

  let city = 'Loca»õie';
  let judet = '';

  try{
    const r = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=' + e.latlng.lat + '&lon=' + e.latlng.lng);
    const d = await r.json();
    const a = d.address || {};

    city = a.city || a.town || a.village || a.suburb || a.neighbourhood || city;
    judet = a.county || a.state || a.region || '';
    if(norm(city).includes('sector')) city = 'Bucuresti';
  } catch(err){}

  layers['Propuneri'].addLayer(
    L.circleMarker(e.latlng, { radius: 10, color:'#fff', fillColor:'#ff00cc', fillOpacity:1 })
  );

  const context = analyzeLocalData(e.latlng.lat, e.latlng.lng, city, judet);
  askPerplexity('AnalizeazƒÉ poten»õialul unui locker aici (' + city + ', ' + judet + '): ' + e.latlng.lat + ', ' + e.latlng.lng, context);
});

/* ===========================
   16) RESET
=========================== */
function resetAll(){
  Object.values(layers).forEach(l => l.clearLayers());
  data.lockers = [];
  data.awbJL = {};
  data.awbJLM = {};
  data.popJL = {};
  detectedMonths = [];
  lockerMarkers = [];

  document.getElementById('aiResponse').style.display = 'none';
  document.getElementById('statusLockers').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('statusAWB').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('statusPop').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('lockerSearchStatus').innerText = '';

  document.getElementById('totalVal').innerText = '0';
  document.getElementById('criticVal').innerText = '0';
  document.getElementById('warnVal').innerText = '0';
  document.getElementById('okVal').innerText = '0';

  speak('Resetat.');
}
</script>
</body>
</html>
