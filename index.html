<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>QUEST DETECTIVE - EXPANSIUNE</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --bg:#222; --panel:rgba(18,22,33,.98); --panel2:#1a1e29;
      --border:#333; --text:#e0e0e0; --muted:#888;
      --accent:#00ff88; --danger:#ff3333; --pink:#ff00cc;
    }
    body{font-family:Inter,system-ui,sans-serif;margin:0;padding:0;background:var(--bg);color:var(--text);overflow:hidden;font-size:14px;}
    #map{height:100vh;width:100%;position:relative;z-index:1;}
    .quest-panel{
      position:absolute;top:15px;left:15px;background:var(--panel);border:1px solid var(--border);
      width:390px;padding:18px;border-radius:12px;z-index:1000;box-shadow:0 0 30px rgba(0,0,0,.6);
      max-height:90vh;overflow-y:auto;
    }
    .quest-title{
      font-size:18px;font-weight:800;color:var(--accent);margin-bottom:12px;text-transform:uppercase;
      border-bottom:2px solid var(--accent);padding-bottom:10px;display:flex;justify-content:space-between;align-items:center;
      letter-spacing:.3px;gap:10px;
    }
    .quest-title span{flex:1}
    .quest-label{font-size:11px;font-weight:700;color:var(--muted);text-transform:uppercase;margin-bottom:6px;display:block;}
    .quest-input-group{margin-bottom:12px;background:var(--panel2);padding:10px;border-radius:10px;border:1px solid var(--border);}
    input[type="file"]{width:100%;font-size:11px;color:#ccc;border:none;background:transparent;}
    .quest-search{width:100%;padding:10px;background:#111;border:1px solid #444;color:#fff;border-radius:8px;box-sizing:border-box;}
    .quest-search:focus{outline:none;border-color:var(--accent);}
    .quest-btn{
      width:100%;padding:10px;margin-top:6px;background:#111;border:1px solid var(--accent);color:var(--accent);
      font-weight:800;cursor:pointer;text-transform:uppercase;transition:.2s;border-radius:10px;
    }
    .quest-btn:hover{background:var(--accent);color:#000;}
    .btn-scan{border-color:var(--pink);color:var(--pink);}
    .btn-scan:hover{background:var(--pink);color:#fff;}
    .mic-btn{
      background:transparent;border:1px solid #444;color:#aaa;width:30px;height:30px;border-radius:50%;
      cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s;flex:0 0 auto;
    }
    .mic-btn.active{border-color:var(--accent);color:var(--accent);box-shadow:0 0 10px rgba(0,255,136,.4);animation:pulse 1.5s infinite;}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.08)}100%{transform:scale(1)}}
    #aiFeedback{font-size:11px;color:#aaa;margin-top:6px;min-height:15px;text-align:center;}
    .ai-response-box{
      background:rgba(0,255,136,.05);border:1px solid var(--accent);padding:10px;margin-top:10px;border-radius:10px;
      font-size:12px;line-height:1.45;color:#fff;display:none;
    }
    .stats-container{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:12px;}
    .stat-box{background:#111;border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center;}
    .stat-val{font-size:16px;font-weight:800;color:#fff;}
    .stat-name{font-size:9px;color:#666;text-transform:uppercase;}
    .loading-bar{height:3px;background:#333;width:100%;display:none;margin-top:6px;border-radius:3px;overflow:hidden;}
    .loading-fill{height:100%;background:var(--accent);width:0;transition:width .3s;}

    .leaflet-popup-content-wrapper{
      background:rgba(18,22,33,.98);color:#eee;border:1px solid #444;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.8);
    }
    .leaflet-popup-content{width:320px !important;margin:14px;}
    .leaflet-popup-tip{background:#1a1e29;}
    .popup-header{font-weight:900;color:var(--accent);font-size:14px;text-align:center;margin-bottom:10px;border-bottom:1px solid #444;padding-bottom:8px;}
    .popup-row{display:flex;justify-content:space-between;gap:10px;align-items:flex-start;font-size:12px;margin-bottom:6px;border-bottom:1px dashed #333;padding-bottom:5px;}
    .popup-label{color:#9aa0a6;font-weight:700;min-width:150px;}
    .popup-value{font-weight:700;color:#fff;text-align:right;flex:1;word-break:break-word;}

    ::-webkit-scrollbar{width:6px;}
    ::-webkit-scrollbar-track{background:#111;}
    ::-webkit-scrollbar-thumb{background:#333;border-radius:3px;}

    .leaflet-control-layers{
      background:rgba(18,22,33,.92);color:#fff;border:1px solid #333;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.6);
    }
    .leaflet-control-layers label{color:#ddd;}

    /* =======================
       MOBILE RESPONSIVE (bottom sheet)
    ======================= */
    @media (max-width: 720px){
      body{ font-size:13px; }

      .quest-panel{
        left: 10px;
        right: 10px;
        top: auto;
        bottom: 10px;

        width: auto;
        max-height: 48vh;

        padding: 12px;
        border-radius: 14px;

        backdrop-filter: blur(6px);
      }

      .quest-title{
        font-size: 15px;
        margin-bottom: 8px;
        padding-bottom: 8px;
      }

      .quest-input-group{ padding: 8px; margin-bottom: 10px; }
      .quest-btn{ padding: 10px; font-size: 12px; }
      .quest-search{ padding: 10px; font-size: 14px; }

      .stats-container{ grid-template-columns: 1fr 1fr; gap: 6px; }
      .stat-val{ font-size: 14px; }

      .leaflet-popup-content{ width: 240px !important; margin: 12px; }
      .popup-label{ min-width: 110px; }

      .leaflet-control-zoom a{
        width: 38px;
        height: 38px;
        line-height: 38px;
      }
    }

    .quest-panel.collapsed{
      max-height: 56px !important;
      overflow: hidden !important;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div class="quest-panel">
    <div class="quest-title">
      <span>QUEST DETECTIVE üéô</span>
      <button id="micBtn" class="mic-btn" onclick="toggleVoice()">üé§</button>
      <button class="mic-btn" id="panelToggleBtn" onclick="togglePanel()" title="Ascunde/AratƒÉ">‚ñ¥</button>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">PERPLEXITY API KEY</span>
      <div style="font-size:12px;color:#aaa;margin-bottom:6px;">Cheia este cititƒÉ automat din <code>config.js</code>.</div>
      <div id="keyStatus" style="font-size:12px;color:#ccc;">Verificare cheie...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">1. LOCKERE (CSV)</span>
      <input type="file" name="lockersFile" onchange="handleFileUpload(this,'lockers')">
      <div id="statusLockers" style="font-size:12px;color:#aaa;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">2. VOLUME AWB (CSV)</span>
      <input type="file" name="awbFile" onchange="handleFileUpload(this,'awb')">
      <div id="statusAWB" style="font-size:12px;color:#aaa;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">3. POPULA»öIE (CSV)</span>
      <input type="file" name="popFile" onchange="handleFileUpload(this,'pop')">
      <div id="statusPop" style="font-size:12px;color:#aaa;margin-top:6px;">A»ôteptare fi»ôier...</div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">CƒÇUTARE LOCKER / ADRESƒÇ</span>
      <input type="text" id="lockerSearch" class="quest-search" placeholder="Ex: Jolie Ville / Muncii 23 / nume locker" onkeyup="searchLockerUI(event)">
      <div id="lockerSearchStatus" style="font-size:11px;color:#888;margin-top:6px;"></div>
    </div>

    <div class="quest-input-group">
      <span class="quest-label">ASISTENT INTELIGENT</span>
      <input type="text" id="searchInput" class="quest-search" placeholder="Ex: AnalizeazƒÉ Baicului..." onkeyup="handleInput(event)">
      <div id="aiFeedback">Sistem gata.</div>

      <div class="loading-bar" id="loadBar"><div class="loading-fill" id="loadFill"></div></div>

      <button class="quest-btn btn-scan" onclick="startAutoScan()">AUTO-SCAN ZONƒÇ</button>
      <button class="quest-btn" id="addModeBtn" onclick="toggleAddMode()">ANALIZƒÇ PUNCTUALƒÇ</button>
      <button class="quest-btn" onclick="resetAll()" style="border-color:#444;color:#aaa;">RESET</button>

      <button onclick="exportLastReport()" id="exportBtn" class="quest-btn" style="display:none;border-color:var(--accent);color:var(--accent);">
        EXPORT RAPORT (TXT)
      </button>

      <div class="stats-container">
        <div class="stat-box"><div class="stat-val" id="totalVal">0</div><div class="stat-name">Lockere</div></div>
        <div class="stat-box"><div class="stat-val" id="criticVal">0</div><div class="stat-name">Critic U</div></div>
        <div class="stat-box"><div class="stat-val" id="warnVal">0</div><div class="stat-name">Aten»õie</div></div>
        <div class="stat-box"><div class="stat-val" id="okVal">0</div><div class="stat-name">Standard</div></div>
      </div>

      <div class="ai-response-box" id="aiResponse"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <script src="./config.js"></script>

  <script>
/* =========================== 0) CONFIG CHECK =========================== */
(function(){
  const el = document.getElementById('keyStatus');
  const k = (window.PPLX_API_KEY || '').trim();
  if(!el) return;
  if(k && k.startsWith('pplx-')) el.innerText = 'Cheie detectatƒÉ (config.js).';
  else el.innerText = 'Cheie lipsƒÉ/invalidƒÉ √Æn config.js.';
})();

/* =========================== 1) HARTƒÇ + BASEMAPS =========================== */
const baseLight = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png', { attribution:'CARTO' });
const baseSat   = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution:'Esri' });
const map = L.map('map', { zoomControl:false, layers:[baseLight] }).setView([46.00, 25.00], 7);
L.control.zoom({ position:'topright' }).addTo(map);

/* =========================== 2) DATA + LAYERS =========================== */
let data = { lockers: [], awbJL: {}, awbJLM: {}, popJL: {} };
let detectedMonths = [];
let addMode = false;

const ANCHORS = ['kaufland','lidl','carrefour','auchan','mega','profi','mall','plaza','piata','residence','complex','gara','universitate','spital','market'];
const MONTHS = { ianuarie:0,februarie:1,martie:2,aprilie:3,mai:4,iunie:5,iulie:6,august:7,septembrie:8,octombrie:9,noiembrie:10,decembrie:11 };

const statusColors = {
  'Critic Urgent':'#d60000',
  'Critic Standard':'#e67e22',
  'Aten»õie':'#f1c40f',
  'Standard':'#27ae60'
};

const layers = {
  'Critic Urgent': L.layerGroup(),
  'Critic Standard': L.layerGroup(),
  'Aten»õie': L.layerGroup(),
  'Standard': L.layerGroup(),
  'Propuneri': L.layerGroup(),
  'Impact 200m': L.layerGroup(),
  'Impact 500m': L.layerGroup()
};

layers['Critic Urgent'].addTo(map);
layers['Critic Standard'].addTo(map);
layers['Aten»õie'].addTo(map);
layers['Standard'].addTo(map);
layers['Propuneri'].addTo(map);
layers['Impact 200m'].addTo(map);
layers['Impact 500m'].addTo(map);

L.control.layers(
  { 'Light': baseLight, 'Satelit': baseSat },
  {
    'Critic Urgent': layers['Critic Urgent'],
    'Critic Standard': layers['Critic Standard'],
    'Aten»õie': layers['Aten»õie'],
    'Standard': layers['Standard'],
    'Propuneri': layers['Propuneri'],
    'Impact 200m': layers['Impact 200m'],
    'Impact 500m': layers['Impact 500m']
  },
  { collapsed:true }
).addTo(map);

let lockerMarkers = [];

/* =========================== 3) UTILS =========================== */
function splitCSV(line){
  const s = String(line || '');
  const comma = (s.match(/,/g) || []).length;
  const semi = (s.match(/;/g) || []).length;
  const sep = semi > comma ? ';' : ',';
  const res = [];
  let curr = '';
  let inQt = false;
  for(let i=0;i<s.length;i++){
    const c = s[i];
    if(c === '"'){ inQt = !inQt; continue; }
    if(c === sep && !inQt){ res.push(curr.trim()); curr=''; continue; }
    curr += c;
  }
  res.push(curr.trim());
  return res;
}

function norm(s){
  return s ? String(s).toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z0-9 ]/g,' ')
    .replace(/\s+/g,' ')
    .trim() : '';
}

function parseIntSafe(x){
  if(x === null || x === undefined) return NaN;
  const t = String(x).replace(/"/g,'').trim().replace(/,/g,'').replace(/\./g,'');
  const n = parseInt(t, 10);
  return isNaN(n) ? NaN : n;
}

function parseLoadPercent(raw){
  if(raw === null || raw === undefined) return NaN;
  let s = String(raw).replace(/"/g,'').trim();
  if(!s) return NaN;
  s = s.replace('%','').trim();
  s = s.replace(/\s+/g,'');
  if(s.includes(',') && !s.includes('.')) s = s.replace(',', '.');
  if(s.includes(',') && s.includes('.')) s = s.replace(/,/g,'');
  const v = parseFloat(s);
  if(isNaN(v)) return NaN;
  if(v >= 0 && v <= 1.5) return v * 100;
  if(v > 1.5 && v <= 250) return v;
  return NaN;
}

function canonJudet(rawJudet, rawLocalitate=''){
  const j = norm(rawJudet);
  const loc = norm(rawLocalitate);
  const looksLikeBuc = j.includes('bucuresti') || j.includes('bucharest') || loc.includes('sector ');
  const looksLikeIlf = j.includes('ilfov');
  if(looksLikeBuc || looksLikeIlf) return 'bucuresti ilfov';
  return j;
}

function makeJLKey(judetRaw, localitateRaw){
  const j = canonJudet(judetRaw, localitateRaw);
  const l = norm(localitateRaw);
  if(!j || !l) return '';
  return `${j}||${l}`;
}

function getDist(lat1, lon1, lat2, lon2){
  const R = 6371e3;
  const a =
    Math.sin((lat2-lat1)*Math.PI/360)**2 +
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) *
    Math.sin((lon2-lon1)*Math.PI/360)**2;
  return Math.round(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

function ymdToDate(ymd){
  if(!ymd) return null;
  const s = String(ymd).trim().slice(0,10);
  const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
  if(!m) return null;
  return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
}

function monthsAgo(d){
  if(!d) return Infinity;
  const now = new Date();
  return (now.getFullYear()-d.getFullYear())*12 + (now.getMonth()-d.getMonth());
}

/* =========================== Panel Toggle =========================== */
function togglePanel(){
  const panel = document.querySelector('.quest-panel');
  const btn = document.getElementById('panelToggleBtn');
  if(!panel || !btn) return;
  panel.classList.toggle('collapsed');
  btn.textContent = panel.classList.contains('collapsed') ? '‚ñæ' : '‚ñ¥';
}
window.addEventListener('load', () => {
  if(window.innerWidth <= 720){
    const panel = document.querySelector('.quest-panel');
    const btn = document.getElementById('panelToggleBtn');
    if(panel && btn){
      panel.classList.add('collapsed');
      btn.textContent = '‚ñæ';
    }
  }
});

/* =========================== 3.5) NATIONAL + LOCAL AWB/POP =========================== */
function getNationalStats(){
  const totalLockers = (data.lockers || []).length;
  const awbKeys = Object.keys(data.awbJL || {});
  const popKeys = Object.keys(data.popJL || {});
  const totalAwb = awbKeys.reduce((s,k)=>s+(data.awbJL[k]||0),0);
  const totalPop = popKeys.reduce((s,k)=>s+(data.popJL[k]||0),0);
  return { totalLockers, awb_records: awbKeys.length, pop_records: popKeys.length, totalAwb, totalPop };
}
function getLocalAwbPop(cityName, judetName){
  const key = makeJLKey(judetName || '', cityName || '');
  const awb = (data.awbJL && key) ? (data.awbJL[key] || 0) : 0;
  const pop = (data.popJL && key) ? (data.popJL[key] || 0) : 0;
  return { key, awb, pop };
}

/* =========================== 3.6) CONTEXT PENTRU AI (LOCKERS) =========================== */
function buildLockersContextForAI(options = {}){
  const lockers = Array.isArray(data.lockers) ? data.lockers : [];
  const topN = Math.max(10, Math.min(120, options.topN ?? 80));
  if(!lockers.length){
    return { ok:false, note:'NU existƒÉ lockere √ÆncƒÉrcate (data.lockers este gol). A»ôteaptƒÉ autoload-ul sau √ÆncarcƒÉ manual fi»ôierul Lockere.' };
  }
  const total = lockers.length;
  const avgAll = +(lockers.reduce((s,l)=>s+(l.loadNov25||0),0) / Math.max(1,total)).toFixed(1);
  const criticUrgent = lockers.filter(l => (l.loadNov25||0) >= 95 || (l.daysOff||0) > 5).length;
  const criticStandard = lockers.filter(l => (l.loadNov25||0) >= 85 && (l.loadNov25||0) < 95 && (l.daysOff||0) <= 5).length;
  const atentie = lockers.filter(l => (l.loadNov25||0) >= 75 && (l.loadNov25||0) < 85).length;

  const top = lockers.slice()
    .sort((a,b)=>(b.loadNov25||0)-(a.loadNov25||0))
    .slice(0, topN)
    .map(l => ({
      nume: l.nume || '',
      oras: l.city || '',
      adresa: l.addr || '',
      lat: l.lat, lng: l.lng,
      loadNov25: +(l.loadNov25||0).toFixed(1),
      loadNov24: +(l.loadNov24||0).toFixed(1),
      avgHist: +(l.avgHist||0).toFixed(1),
      trend: l.trend || 'Stabil',
      daysOff: l.daysOff || 0,
      install: l.install || '',
      installMonthsAgo: l.installMonthsAgo,
      cap: l.cap || '',
      model: l.model || ''
    }));

  return {
    ok:true,
    summary: { totalLockers: total, avgLoadNov25: avgAll, criticUrgent, criticStandard, atentie },
    topLockers: top
  };
}

/* =========================== RAPORT + EXPORT TXT =========================== */
let LAST_REPORT_TXT = '';
let LAST_REPORT_NAME = 'raport_easybox.txt';

function formatReportTxt(r){
  const lines = [];
  lines.push('BREAKDOWN DENSITATE REALƒÇ:');
  lines.push(`üéØ Scor final: ${Number(r.score_final ?? 0).toFixed(1)}/100`);
  lines.push(`üì¶ Factor locker-e (60%): ${Number(r.factor_lockere ?? 0).toFixed(1)}/100`);
  lines.push(`üë• Factor popula»õie (40%): ${Number(r.factor_populatie ?? 0).toFixed(1)}/100`);
  if(r.zona) lines.push(`üìç ZonƒÉ: ${r.zona}`);

  lines.push(`üè™ Locker-e √Æn 500m: ${r.lockere_500m ?? 0} (√ÆncƒÉrcare medie ${(Number(r.avg_load_500m ?? 0)).toFixed(1)}%)`);
  if(r.max_load_500m !== null && r.max_load_500m !== undefined) lines.push(`üîù Max load (500m): ${Number(r.max_load_500m).toFixed(1)}%`);
  if(r.over95_500m !== null && r.over95_500m !== undefined) lines.push(`üö® Lockere ‚â•95% (500m): ${r.over95_500m}`);

  if(r.recomandare_text) lines.push(`üåü ${String(r.recomandare_text).toUpperCase()}`);

  lines.push(`ü§ñ Scor AI: ${Math.round(r.scor_ai ?? 0)}/100`);
  if(r.utilizare_estimata_pct !== null && r.utilizare_estimata_pct !== undefined) lines.push(`üìä Utilizare estimatƒÉ: ${r.utilizare_estimata_pct}%`);
  if(r.trend_zona_500m) lines.push(`üìà Trend ZonƒÉ (500m): ${r.trend_zona_500m}`);
  if(r.avg_load_istoric_500m !== null && r.avg_load_istoric_500m !== undefined) lines.push(`‚öñÔ∏è √éncƒÉrcare Medie IstoricƒÉ ZonƒÉ: ${Number(r.avg_load_istoric_500m).toFixed(1)}%`);
  if(r.instalari_ultimul_an_500m !== null && r.instalari_ultimul_an_500m !== undefined) lines.push(`üÜï InstalƒÉri √Æn ultimul an (500m): ${r.instalari_ultimul_an_500m}`);
  if(typeof r.cerere_indusa_probabila === 'boolean') lines.push(`üì¶ Cerere indusƒÉ probabilƒÉ: ${r.cerere_indusa_probabila ? 'DA' : 'NU'}`);

  if(r.degrevare_text) lines.push(`üöÄ ${r.degrevare_text}`);

  lines.push(`üöÄ LOCKER-E DEGREVATE (Raza ${r.degrevare_raza_m || 500}m):`);
  const list = Array.isArray(r.lockere_degrevate) ? r.lockere_degrevate : [];
  const show = list.slice(0, 6);
  for(const x of show){
    lines.push(`‚Ä¢ ${x.nume || '-'} (${x.dist_m ?? '-'}m): ${x.before_pct ?? '-'}% ‚Üí ${x.after_pct ?? '-'}% (${x.delta_pct ?? '-'}%)`);
  }
  if(list.length > show.length) lines.push(`... »ôi √ÆncƒÉ ${list.length - show.length} locker-e`);
  if(r.note) lines.push(`NOTE: ${r.note}`);
  return lines.join('\n');
}

function renderReportToHtml(r){
  const txt = formatReportTxt(r);
  const safe = txt.replace(/</g,'&lt;').replace(/>/g,'&gt;');
  return `<pre style="white-space:pre-wrap;margin:0;font-family:Inter,system-ui;font-size:12px;line-height:1.35;">${safe}</pre>`;
}

function exportLastReport(){
  if(!LAST_REPORT_TXT) return;
  const blob = new Blob([LAST_REPORT_TXT], { type:'text/plain;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = LAST_REPORT_NAME || 'raport_easybox.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===========================
   IMPACT strict 200m / 500m (ordonat, filtrat >=10m)
=========================== */
function getImpactLists(lat, lng){
  const list200 = [];
  const list500 = [];
  for(const l of (data.lockers || [])){
    const d = getDist(lat, lng, l.lat, l.lng);
    if(d <= 200) list200.push({ locker:l, dist:d });
    if(d <= 500) list500.push({ locker:l, dist:d });
  }
  list200.sort((a,b)=>a.dist-b.dist);
  list500.sort((a,b)=>a.dist-b.dist);
  const min10 = arr => arr.filter(x => x.dist >= 10);
  return { r200: min10(list200), r500: min10(list500) };
}

/* ===========================
   DEGREVARE deterministicƒÉ (√ÆncƒÉrcare √ó proximitate)
=========================== */
function computeDecongestion(contextData){
  const r200 = contextData?.impact200?.rows || [];
  const r500 = contextData?.impact500?.rows || [];
  function calc(arr, radius, maxPp){
    const p = 2;
    const items = arr.map(x => {
      const dist = Math.max(10, x.dist || radius);
      const z = Math.max(0, 1 - (dist / radius));
      const distFactor = Math.pow(z, p);
      const loadFactor = Math.max(0, (x.loadNov25 || 0) - 70);
      const w = loadFactor * distFactor;
      return { ...x, w };
    });
    const W = items.reduce((s,i)=>s+i.w,0) || 1;
    const out = items.map(i => {
      const delta = -(maxPp * (i.w / W));
      const after = Math.max(0, (i.loadNov25 || 0) + delta);
      return { nume: i.name, dist_m: i.dist, before_pct: +(i.loadNov25||0).toFixed(1), after_pct: +after.toFixed(1), delta_pct: +delta.toFixed(1) };
    });
    out.sort((a,b)=>a.dist_m-b.dist_m);
    return out.slice(0, 6);
  }
  return { list200: calc(r200, 200, 12), list500: calc(r500, 500, 6) };
}
function selectDecongestionList(contextData){
  const c200 = contextData?.impact200?.count || 0;
  const chosenRadius = (c200 >= 2) ? 200 : 500;
  const decong = computeDecongestion(contextData);
  const chosenList = (chosenRadius === 200) ? decong.list200 : decong.list500;
  return { chosenRadius, chosenList };
}

/* =========================== 4) UPLOAD HANDLER =========================== */
function handleFileUpload(input, type){
  const file = input.files[0];
  if(!file) return;
  const r = new FileReader();
  r.onload = e => {
    const t = e.target.result;
    if(type === 'lockers') processLockers(t);
    if(type === 'awb') processAWB(t);
    if(type === 'pop') processPop(t);
    speak('Fi»ôierul ' + type + ' a fost procesat.');
  };
  r.readAsText(file);
}

/* =========================== 5) LOCKERS CSV =========================== */
function processLockers(csv){
  Object.values(layers).forEach(g => g.clearLayers());
  lockerMarkers = [];
  data.lockers = [];

  const stats = {'Critic Urgent':0,'Critic Standard':0,'Aten»õie':0,'Standard':0};

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2) return;

  const h = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  detectedMonths = [];

  h.forEach((col, idx) => {
    const m = col.match(/([a-zA-Z]+)\s+(\d{4})/);
    if(m && !col.toLowerCase().includes('inactiv')){
      const mon = m[1].toLowerCase();
      const yr = parseInt(m[2],10);
      if(MONTHS.hasOwnProperty(mon)){
        detectedMonths.push({ name: col, idx, val: yr*12 + MONTHS[mon] });
      }
    }
  });
  detectedMonths.sort((a,b)=>a.val-b.val);

  const idxNov25 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2025') && !x.toLowerCase().includes('inactiv'));
  const idxNov24 = h.findIndex(x => x.toLowerCase().includes('noiembrie 2024') && !x.toLowerCase().includes('inactiv'));

  const idx = {
    nume: h.indexOf('Locker Nume'),
    lat: h.indexOf('Latitudine'),
    lng: h.indexOf('Longitudine'),
    install: h.indexOf('Data instalare'),
    cap: h.indexOf('Capacitate locker'),
    addr: h.indexOf('Adresa'),
    model: h.indexOf('Model'),
    city: h.indexOf('Locker Oras'),
    inactiv: h.findIndex(x => x.toLowerCase().includes('inactiv'))
  };

  const getVal = (row,i) => i>-1 ? (row[i] ?? '').replace(/"/g,'').trim() : '';

  lines.slice(1).forEach(l => {
    const row = splitCSV(l);
    if(row.length < h.length) return;

    const lat = parseFloat(getVal(row, idx.lat));
    const lng = parseFloat(getVal(row, idx.lng));
    if(isNaN(lat) || isNaN(lng)) return;

    let historyValues = [];
    let monthsWithData = 0;
    detectedMonths.forEach(m => {
      const p = parseLoadPercent(getVal(row, m.idx));
      if(!isNaN(p)){ historyValues.push(p); monthsWithData++; }
    });
    let avgHist = historyValues.length ? historyValues.reduce((a,b)=>a+b,0) / historyValues.length : 0;

    let loadNov25 = 0, loadNov24 = 0;
    if(idxNov25 > -1){
      const p = parseLoadPercent(getVal(row, idxNov25));
      loadNov25 = isNaN(p) ? 0 : p;
    }
    if(idxNov24 > -1){
      const p = parseLoadPercent(getVal(row, idxNov24));
      loadNov24 = isNaN(p) ? 0 : p;
    }

    let trendStr = 'Stabil';
    if(loadNov25 > loadNov24 + 5) trendStr = 'Peste medie';
    else if(loadNov25 < loadNov24 - 5) trendStr = 'Sub medie';

    const daysOff = parseIntSafe(getVal(row, idx.inactiv)) || 0;

    const cleanInst = (getVal(row, idx.install) || '').split(' ')[0];
    const installDate = ymdToDate(cleanInst);
    const installMonthsAgo = monthsAgo(installDate);

    let status = 'Standard';
    if(loadNov25 >= 95 || daysOff > 5) status = 'Critic Urgent';
    else if(loadNov25 >= 85) status = 'Critic Standard';
    else if(loadNov25 >= 75) status = 'Aten»õie';

    stats[status]++;

    const locker = {
      nume: getVal(row, idx.nume),
      lat, lng,
      loadNov25, loadNov24,
      avgHist,
      trend: trendStr,
      monthsWithData,
      install: cleanInst,
      installMonthsAgo,
      cap: getVal(row, idx.cap),
      model: getVal(row, idx.model),
      addr: getVal(row, idx.addr),
      city: getVal(row, idx.city),
      daysOff
    };
    data.lockers.push(locker);

    const marker = L.circleMarker([lat,lng], { radius: 7, fillColor: statusColors[status], color: '#000', weight: 1, opacity: 1, fillOpacity: 0.85 });

    const trendIcon = locker.trend === 'Peste medie' ? 'üìà' : (locker.trend === 'Sub medie' ? 'üìâ' : '‚û°Ô∏è');
    const monthsText = `${locker.monthsWithData || 0}/12`;

    const popupContent = `
      <div class="popup-header">${locker.nume || '-'}</div>
      <div class="popup-row"><span class="popup-label">üìç Loca»õie:</span><span class="popup-value">${locker.city || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">üì¨ AdresƒÉ:</span><span class="popup-value">${locker.addr || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">üìä √éncƒÉrcare Nov 2025:</span><span class="popup-value">${(locker.loadNov25 || 0).toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">‚èÆÔ∏è Nov 2024:</span><span class="popup-value">${(locker.loadNov24 || 0).toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">üìà Trend:</span><span class="popup-value">${trendIcon} ${locker.trend || 'Stabil'}</span></div>
      <div class="popup-row"><span class="popup-label">‚öñÔ∏è Medie IstoricƒÉ:</span><span class="popup-value">${(locker.avgHist || 0).toFixed(1)}%</span></div>
      <div class="popup-row"><span class="popup-label">üóìÔ∏è Luni ultim an:</span><span class="popup-value">${monthsText}</span></div>
      <div class="popup-row"><span class="popup-label">üì¶ Capacitate:</span><span class="popup-value">${locker.cap || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">‚è±Ô∏è Inactivare:</span><span class="popup-value">${locker.daysOff || 0} zile</span></div>
      <div class="popup-row"><span class="popup-label">üìÖ Instalare:</span><span class="popup-value">${locker.install || '-'}</span></div>
      <div class="popup-row"><span class="popup-label">üîß Model:</span><span class="popup-value">${locker.model || '-'}</span></div>
    `;
    marker.bindPopup(popupContent);

    layers[status].addLayer(marker);
    lockerMarkers.push({ marker, locker });
  });

  document.getElementById('totalVal').innerText = data.lockers.length;
  document.getElementById('criticVal').innerText = stats['Critic Urgent'];
  document.getElementById('warnVal').innerText = stats['Aten»õie'];
  document.getElementById('okVal').innerText = stats['Standard'];
  document.getElementById('statusLockers').innerText = `Actualizat: ${data.lockers.length} unitƒÉ»õi`;
}

/* =========================== 6) AWB CSV =========================== */
function processAWB(csv){
  data.awbJL = {};
  data.awbJLM = {};

  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){ document.getElementById('statusAWB').innerText = 'AWB: fi»ôier gol'; return; }

  const header = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const hNorm = header.map(norm);

  const idxMonth = hNorm.findIndex(x => x === 'month' || x.includes('month'));
  const idxJudet = hNorm.findIndex(x => x.includes('judet') && x.includes('destinatar'));
  const idxLoc   = hNorm.findIndex(x => x.includes('localitate') && x.includes('destinatar'));
  const idxTot   = hNorm.findIndex(x => x.includes('nr') && x.includes('total') && x.includes('awb'));

  if(idxJudet < 0 || idxLoc < 0 || idxTot < 0){
    document.getElementById('statusAWB').innerText = 'AWB: header neidentificat';
    return;
  }

  let ok = 0;
  for(const l of lines.slice(1)){
    const row = splitCSV(l);

    const monthRaw = idxMonth >= 0 ? (row[idxMonth] ?? '') : '';
    const judetRaw = (row[idxJudet] ?? '');
    const locRaw   = (row[idxLoc] ?? '');
    const totRaw   = (row[idxTot] ?? '');

    const month = String(monthRaw).replace(/"/g,'').trim();
    const judet = String(judetRaw).replace(/"/g,'').trim();
    const loc   = String(locRaw).replace(/"/g,'').trim();
    if(!judet || !loc) continue;

    const awb = parseIntSafe(totRaw);
    if(isNaN(awb) || awb < 0) continue;

    const jlKey = makeJLKey(judet, loc);
    if(!jlKey) continue;

    data.awbJL[jlKey] = (data.awbJL[jlKey] || 0) + awb;

    if(month){
      const mKey = norm(month);
      const jlmKey = `${mKey}||${jlKey}`;
      data.awbJLM[jlmKey] = (data.awbJLM[jlmKey] || 0) + awb;
    }
    ok++;
  }

  document.getElementById('statusAWB').innerText = `AWB OK: ${ok} r√¢nduri, chei unice ${Object.keys(data.awbJL).length}`;
}

/* =========================== 7) POP CSV =========================== */
function processPop(csv){
  data.popJL = {};
  const lines = csv.split(/\r?\n/).filter(x => x.trim().length);
  if(lines.length < 2){ document.getElementById('statusPop').innerText = 'POP: fi»ôier gol'; return; }

  const first = splitCSV(lines[0]).map(x => x.replace(/"/g,'').trim());
  const fNorm = first.map(norm);

  const hasHeader =
    fNorm.includes('judet') &&
    (fNorm.includes('localitate') || fNorm.includes('localitatea')) &&
    fNorm.join(' ').includes('pop');

  let ok = 0;

  if(hasHeader){
    const idxJ = fNorm.findIndex(x => x === 'judet' || x.includes('judet'));
    const idxL = fNorm.findIndex(x => x === 'localitate' || x.includes('localit'));
    const idxP = fNorm.findIndex(x => x.includes('pop'));

    for(const l of lines.slice(1)){
      const row = splitCSV(l);
      const judet = (row[idxJ] ?? '').replace(/"/g,'').trim();
      const loc   = (row[idxL] ?? '').replace(/"/g,'').trim();
      const pop   = parseIntSafe(row[idxP] ?? '');
      if(!judet || !loc || isNaN(pop)) continue;

      const key = makeJLKey(judet, loc);
      if(!key) continue;

      data.popJL[key] = Math.max(data.popJL[key] || 0, pop);
      ok++;
    }
  } else {
    for(const l of lines.slice(1)){
      const line = l.replace(/"/g,'').trim();
      if(!line) continue;

      const parts = line.split(/\s+/);
      if(parts.length < 3) continue;

      const pop = parseIntSafe(parts[parts.length - 1]);
      if(isNaN(pop)) continue;

      const judet = parts[0];
      const loc = parts.slice(1, parts.length - 1).join(' ');

      const key = makeJLKey(judet, loc);
      if(!key) continue;

      data.popJL[key] = Math.max(data.popJL[key] || 0, pop);
      ok++;
    }
  }

  document.getElementById('statusPop').innerText = `POP OK: ${ok} r√¢nduri, chei unice ${Object.keys(data.popJL).length}`;
}

/* =========================== AUTOLOAD CSV din repo (/data) =========================== */
async function loadAllCSVs(){
  const setStatus = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; };

  try{
    setStatus('statusLockers', 'Se √ÆncarcƒÉ automat...');
    const lockersText = await (await fetch('./data/date_lockere_actualizat.csv', { cache:'no-store' })).text();
    processLockers(lockersText);
    setStatus('statusLockers', '√éncƒÉrcat automat (date_lockere_actualizat.csv)');
  } catch(e){
    console.error('Autoload lockers error:', e);
    setStatus('statusLockers', 'Eroare autoload: date_lockere_actualizat.csv');
  }

  try{
    setStatus('statusAWB', 'Se √ÆncarcƒÉ automat...');
    const awbText = await (await fetch('./data/cercuri.csv', { cache:'no-store' })).text();
    processAWB(awbText);
    setStatus('statusAWB', '√éncƒÉrcat automat (cercuri.csv)');
  } catch(e){
    console.error('Autoload awb error:', e);
    setStatus('statusAWB', 'Eroare autoload: cercuri.csv');
  }

  try{
    setStatus('statusPop', 'Se √ÆncarcƒÉ automat...');
    const popText = await (await fetch('./data/populatie_2021.csv', { cache:'no-store' })).text();
    processPop(popText);
    setStatus('statusPop', '√éncƒÉrcat automat (populatie_2021.csv)');
  } catch(e){
    console.error('Autoload pop error:', e);
    setStatus('statusPop', 'Eroare autoload: populatie_2021.csv');
  }
}
window.addEventListener('load', loadAllCSVs);

/* =========================== 10) IMPACT CIRCLES =========================== */
function drawImpactCircles(latlng){
  layers['Impact 200m'].clearLayers();
  layers['Impact 500m'].clearLayers();
  const c200 = L.circle(latlng, { radius: 200, color: '#00ff88', weight: 2, fillColor: '#00ff88', fillOpacity: 0.08 });
  const c500 = L.circle(latlng, { radius: 500, color: '#ff00cc', weight: 2, fillColor: '#ff00cc', fillOpacity: 0.06 });
  layers['Impact 200m'].addLayer(c200);
  layers['Impact 500m'].addLayer(c500);
}

/* =========================== 11) SEARCH =========================== */
function searchLockers(query){
  const q = norm(query);
  if(!q) return [];
  const scored = lockerMarkers.map(x => {
    const name = norm(x.locker.nume || '');
    const addr = norm(x.locker.addr || '');
    const city = norm(x.locker.city || '');
    let score = 0;
    if(name.includes(q)) score += 3;
    if(addr.includes(q)) score += 2;
    if(city.includes(q)) score += 1;
    return { ...x, score };
  }).filter(x => x.score > 0);

  scored.sort((a,b)=>b.score-a.score);
  return scored.slice(0, 10);
}

function focusLocker(result){
  const { marker } = result;
  map.setView(marker.getLatLng(), 17, { animate:true });
  marker.openPopup();
}

function searchLockerUI(e){
  if(e.key !== 'Enter') return;
  const q = document.getElementById('lockerSearch').value;
  const hits = searchLockers(q);
  const st = document.getElementById('lockerSearchStatus');
  if(!hits.length){ st.innerText = 'Niciun rezultat.'; return; }

  if(!searchLockerUI._idx || searchLockerUI._lastQ !== norm(q)){
    searchLockerUI._idx = 0;
    searchLockerUI._lastQ = norm(q);
  } else {
    searchLockerUI._idx = (searchLockerUI._idx + 1) % hits.length;
  }

  st.innerText = `GƒÉsite ${hits.length}. Rezultat ${searchLockerUI._idx+1}/${hits.length}. (Enter pentru urmƒÉtorul)`;
  focusLocker(hits[searchLockerUI._idx]);
}

/* ===========================
   ANALIZƒÇ PUNCTUALƒÇ - context cu impact200/impact500 + severitate
=========================== */
function analyzeLocalData(lat, lng, cityName, judetName){
  const local = getLocalAwbPop(cityName, judetName);
  const impactLists = getImpactLists(lat, lng);

  function enrichImpact(arr){
    const rows = arr.map(x => {
      const l = x.locker;
      const delta = (l.loadNov25 || 0) - (l.loadNov24 || 0);
      return {
        name: l.nume || '',
        dist: x.dist,
        loadNov25: +(l.loadNov25 || 0).toFixed(1),
        loadNov24: +(l.loadNov24 || 0).toFixed(1),
        delta: +delta.toFixed(1),
        avgHist: +(l.avgHist || 0).toFixed(1),
        monthsWithData: l.monthsWithData || 0,
        installs12: (l.installMonthsAgo || Infinity) <= 12,
        daysOff: l.daysOff || 0
      };
    });

    const count = rows.length;
    const avgLoad = count ? rows.reduce((s,r)=>s+r.loadNov25,0)/count : 0;
    const avgDelta = count ? rows.reduce((s,r)=>s+r.delta,0)/count : 0;
    const avgHist = count ? rows.reduce((s,r)=>s+r.avgHist,0)/count : 0;

    const maxLoad = count ? Math.max(...rows.map(r => r.loadNov25)) : 0;
    const over95 = rows.filter(r => r.loadNov25 >= 95).length;
    const over100 = rows.filter(r => r.loadNov25 >= 100).length;

    const pos = rows.filter(r => r.delta > 0).length;
    const neg = rows.filter(r => r.delta < 0).length;
    const installs12 = rows.filter(r => r.installs12).length;

    return {
      count,
      avgLoad: +avgLoad.toFixed(1),
      avgDelta: +avgDelta.toFixed(1),
      avgHist: +avgHist.toFixed(1),
      maxLoad: +maxLoad.toFixed(1),
      over95,
      over100,
      posDeltas: pos,
      negDeltas: neg,
      installs12,
      rows
    };
  }

  const impact200 = enrichImpact(impactLists.r200);
  const impact500 = enrichImpact(impactLists.r500);

  const anchors = [];
  (impact500.rows || []).forEach(x=>{
    const n = (x.name||'').toLowerCase();
    ANCHORS.forEach(tag => { if(n.includes(tag) && !anchors.includes(tag)) anchors.push(tag); });
  });

  return {
    city: cityName,
    judet: judetName || '',
    awbLocal: local.awb,
    popLocal: local.pop,
    keyJL: local.key,
    anchors,
    impact200,
    impact500
  };
}

/* =========================== 12) PERPLEXITY (override critic) =========================== */
async function askPerplexity(question, contextData=null){
  const apiKey = (window.PPLX_API_KEY || '').trim();
  if(!apiKey || !apiKey.startsWith('pplx-')){
    alert('Cheie Perplexity lipsƒÉ/invalidƒÉ. VerificƒÉ config.js (window.PPLX_API_KEY).');
    return;
  }

  const responseBox = document.getElementById('aiResponse');
  responseBox.style.display = 'block';
  responseBox.innerHTML = '<i>Perplexity analizeazƒÉ datele...</i>';
  document.getElementById('exportBtn').style.display = 'none';

  const ctx = buildLockersContextForAI({ topN: 80 });
  const nat = getNationalStats();

  const response_format = {
    type: "json_schema",
    json_schema: {
      schema: {
        type: "object",
        additionalProperties: false,
        properties: {
          score_final: { type: "number" },
          factor_lockere: { type: "number" },
          factor_populatie: { type: "number" },

          zona: { type: "string" },

          lockere_500m: { type: "integer" },
          avg_load_500m: { type: "number" },
          max_load_500m: { type: ["number","null"] },
          over95_500m: { type: ["integer","null"] },

          avg_load_istoric_500m: { type: ["number","null"] },
          instalari_ultimul_an_500m: { type: ["integer","null"] },
          cerere_indusa_probabila: { type: ["boolean","null"] },

          recomandare_text: { type: "string" },
          scor_ai: { type: "number" },
          utilizare_estimata_pct: { type: ["number","null"] },
          trend_zona_500m: { type: "string" },

          degrevare_text: { type: ["string","null"] },
          degrevare_raza_m: { type: ["integer","null"] },

          lockere_degrevate: {
            type: "array",
            items: {
              type: "object",
              additionalProperties: false,
              properties: {
                nume: { type: "string" },
                dist_m: { type: "integer" },
                before_pct: { type: "number" },
                after_pct: { type: "number" },
                delta_pct: { type: "number" }
              },
              required: ["nume","dist_m","before_pct","after_pct","delta_pct"]
            }
          },

          note: { type: ["string","null"] }
        },
        required: [
          "score_final","factor_lockere","factor_populatie",
          "zona","lockere_500m","avg_load_500m",
          "recomandare_text","scor_ai","trend_zona_500m",
          "lockere_degrevate"
        ]
      }
    }
  };

  let systemPrompt =
`E»ôti un expert logistic senior pentru re»õeaua easybox.
Obiectiv: RAPORT SINTETIC opera»õional.
RƒÉspunde STRICT √Æn JSON conform response_format (fƒÉrƒÉ text √Æn afara JSON).
Nu folosi browsing/web; folose»ôte doar datele primite.

DATA DICTIONARY (3 fi»ôiere):
1) LOCKERE: coordonate, instalare, capacitate, model, √ÆncƒÉrcƒÉri lunare (%), zile inactiv.
2) AWB: volum colete pe Judet+Localitate (»ôi uneori Month).
3) POP: popula»õie pe Judet+Localitate.

Reguli:
- Decizia se ia pe 500m (impact500): avgLoad, maxLoad, over95, installs12, avgHist.
- 200m = severitate localƒÉ.
- LOCKER-E DEGREVATE trebuie sƒÉ fie EXACT lista primitƒÉ (LOCKERE_DEGREVATE_AFI»òATE). Nu recalcula.

REGULƒÇ CRITICƒÇ (override):
- DacƒÉ impact500.over95>=1 SAU impact500.maxLoad>=100 SAU impact500.avgLoad>=90,
  recomandare_text NU are voie sƒÉ fie "POTEN»öIAL MODERAT" sau mai jos.
  MarcheazƒÉ zona ca URGENTƒÇ / necesitƒÉ degrevare (locker nou ajutƒÉ chiar dacƒÉ trendul e descendent).
- trend_zona_500m este informativ »ôi nu poate contrazice urgen»õa.`;

  let userPayload = question;

  userPayload += `

STARE DATASET:
- national: ${JSON.stringify(nat)}
- awbJL keys: ${Object.keys(data.awbJL||{}).length}
- popJL keys: ${Object.keys(data.popJL||{}).length}`;

  if(ctx.ok){
    userPayload += `

LOCKERE (rezumat + e»ôantion top):
REZUMAT: ${JSON.stringify(ctx.summary)}
TOP_LOCKERE_SAMPLE: ${JSON.stringify(ctx.topLockers)}`;
  } else {
    userPayload += `

LOCKERE: LIPSƒÇ
NOTƒÇ: ${ctx.note}`;
  }

  if(contextData){
    const decongPack = selectDecongestionList(contextData);

    const indus = (contextData.impact500.installs12 || 0) > 0 &&
      Math.abs((contextData.impact500.avgLoad || 0) - (contextData.impact500.avgHist || 0)) < 3 &&
      (contextData.impact500.avgDelta || 0) > 0;

    userPayload += `

CONTEXT LOCAL (din cele 3 fi»ôiere, agregat):
- zonƒÉ: ${contextData.city} (${contextData.judet})
- keyJL: ${contextData.keyJL}
- AWB local (JL): ${contextData.awbLocal}
- POP local (JL): ${contextData.popLocal}

IMPACT 500m: ${JSON.stringify({
  count: contextData.impact500.count,
  avgLoad: contextData.impact500.avgLoad,
  maxLoad: contextData.impact500.maxLoad,
  over95: contextData.impact500.over95,
  over100: contextData.impact500.over100,
  avgDelta: contextData.impact500.avgDelta,
  avgHist: contextData.impact500.avgHist,
  installs12: contextData.impact500.installs12,
  posDeltas: contextData.impact500.posDeltas,
  negDeltas: contextData.impact500.negDeltas
})}

DEGREVARE (determinist):
- regula razƒÉ: 200m dacƒÉ impact200.count>=2, altfel 500m
- RAZA_ALEASƒÇ: ${decongPack.chosenRadius}
- LOCKERE_DEGREVATE_AFI»òATE: ${JSON.stringify(decongPack.chosenList)}

HINT:
- cerere_indusa_probabila_hint: ${indus ? 'true' : 'false'}

CERIN»öE OUTPUT:
- lockere_500m = impact500.count
- avg_load_500m = impact500.avgLoad
- max_load_500m = impact500.maxLoad
- over95_500m = impact500.over95
- avg_load_istoric_500m = impact500.avgHist
- instalari_ultimul_an_500m = impact500.installs12
- trend_zona_500m: ascendent dacƒÉ avgDelta>0 sau posDeltas>negDeltas; altfel stabil/descendent
- cerere_indusa_probabila: folose»ôte hint-ul doar dacƒÉ e coerent cu datele
- degrevare_raza_m = RAZA_ALEASƒÇ
- lockere_degrevate = LOCKERE_DEGREVATE_AFI»òATE`;
  } else {
    userPayload += `
DacƒÉ nu existƒÉ contextData, returneazƒÉ JSON valid »ôi note="NecesitƒÉ click pe hartƒÉ pentru calcul impact 200/500m".`;
  }

  const messages = [
    { role:'system', content: systemPrompt },
    { role:'user', content: userPayload }
  ];

  try{
    const response = await fetch('https://api.perplexity.ai/chat/completions', {
      method:'POST',
      headers:{ 'Authorization':'Bearer ' + apiKey, 'Content-Type':'application/json' },
      body: JSON.stringify({
        model: (window.PPLX_MODEL || 'sonar-pro'),
        messages,
        response_format
      })
    });

    const json = await response.json();
    if(json.error) throw new Error(json.error.message || 'Eroare API');

    const rawText = json?.choices?.[0]?.message?.content || '';
    let obj = null;
    try{ obj = JSON.parse(rawText); }
    catch(parseErr){
      responseBox.innerHTML = marked.parse(rawText || '(FƒÉrƒÉ rƒÉspuns)');
      return;
    }

    responseBox.innerHTML = renderReportToHtml(obj);
    LAST_REPORT_TXT = formatReportTxt(obj);
    LAST_REPORT_NAME = `raport_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.txt`;
    document.getElementById('exportBtn').style.display = 'block';

    speak(`Recomandare: ${obj.recomandare_text}. Scor final ${Math.round(obj.score_final||0)} din 100.`);
  } catch(e){
    console.error(e);
    responseBox.innerText = 'Eroare API Perplexity: ' + (e.message || String(e));
    speak('A apƒÉrut o eroare la conectarea cu Perplexity.');
  }
}

/* =========================== 13) VOICE =========================== */
const synth = window.speechSynthesis;
let recognition = null;
let isListening = false;

function speak(text){
  if(!text) return;
  if(synth.speaking) synth.cancel();
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = 'ro-RO';
  synth.speak(utter);
  document.getElementById('aiFeedback').innerText = text;
}

function toggleVoice(){
  if(!('webkitSpeechRecognition' in window)){
    alert('NecesitƒÉ Chrome/Edge.');
    return;
  }
  if(isListening){ recognition.stop(); return; }
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ro-RO';

  recognition.onstart = () => { isListening=true; document.getElementById('micBtn').classList.add('active'); };
  recognition.onend = () => { isListening=false; document.getElementById('micBtn').classList.remove('active'); };

  recognition.onresult = e => {
    const q = e.results[0][0].transcript;
    document.getElementById('searchInput').value = q;
    handleInput({ key:'Enter', target:{ value:q } }, true);
  };
  recognition.start();
}

function handleInput(e, fromVoice=false){
  if(e.key !== 'Enter' && !fromVoice) return;
  const q = document.getElementById('searchInput').value.trim();
  if(!q) return;

  if(q.toLowerCase().includes('scan')){
    const city = q.replace(/scaneaza|scaneazƒÉ|orasul|ora»ôul/gi,'').trim();
    startAutoScan(city);
  } else {
    askPerplexity(q);
  }
}

/* =========================== 14) AUTO-SCAN =========================== */
async function startAutoScan(cityFromParam=null){
  let city = cityFromParam;
  if(!city){ city = prompt('Introdu localitatea / zona pentru scan:'); if(!city) return; }

  speak('Analizez ' + city + '...');
  const loadBar = document.getElementById('loadBar');
  const loadFill = document.getElementById('loadFill');
  loadBar.style.display = 'block';
  loadFill.style.width = '25%';

  try{
    const r = await fetch('https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=' + encodeURIComponent(city));
    const d = await r.json();
    if(!d.length){ speak('Loca»õie necunoscutƒÉ.'); loadBar.style.display = 'none'; return; }

    loadFill.style.width = '55%';
    const b = d[0].boundingbox;
    map.fitBounds([[b[0], b[2]],[b[1], b[3]]]);

    const centerLat = (parseFloat(b[0]) + parseFloat(b[1])) / 2;
    const centerLng = (parseFloat(b[2]) + parseFloat(b[3])) / 2;
    const center = L.latLng(centerLat, centerLng);

    drawImpactCircles(center);
    layers['Propuneri'].addLayer(L.circleMarker(center, { radius: 10, color:'#fff', fillColor:'#ff00cc', fillOpacity:1 }));

    const rr = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=' + centerLat + '&lon=' + centerLng);
    const rd = await rr.json();
    const addr = rd.address || {};
    const locName = addr.city || addr.town || addr.village || city;
    const judName = addr.county || addr.state || addr.region || '';

    loadFill.style.width = '85%';
    const context = analyzeLocalData(centerLat, centerLng, locName, judName);
    await askPerplexity('Raport de oportunitate pentru zona simulatƒÉ: ' + locName + '?', context);

    loadFill.style.width = '100%';
    setTimeout(()=>{ loadBar.style.display='none'; loadFill.style.width='0%'; }, 300);
  } catch(e){
    console.error(e);
    loadBar.style.display = 'none';
  }
}

/* =========================== 15) ANALIZƒÇ PUNCTUALƒÇ =========================== */
function toggleAddMode(){
  addMode = !addMode;
  const btn = document.getElementById('addModeBtn');

  if(addMode){
    btn.innerText = 'STOP ANALIZƒÇ';
    btn.style.borderColor = '#ff3333';
    btn.style.color = '#ff3333';
  } else {
    btn.innerText = 'ANALIZƒÇ PUNCTUALƒÇ';
    btn.style.borderColor = '#00ff88';
    btn.style.color = '#00ff88';

    layers['Impact 200m'].clearLayers();
    layers['Impact 500m'].clearLayers();
    layers['Propuneri'].clearLayers();

    document.getElementById('aiResponse').style.display = 'none';
    document.getElementById('exportBtn').style.display = 'none';
    LAST_REPORT_TXT = '';
    LAST_REPORT_NAME = 'raport_easybox.txt';
  }
}

map.on('click', async e => {
  if(!addMode) return;

  drawImpactCircles(e.latlng);

  let city = 'Loca»õie';
  let judet = '';
  try{
    const r = await fetch('https://nominatim.openstreetmap.org/reverse?format=json&addressdetails=1&lat=' + e.latlng.lat + '&lon=' + e.latlng.lng);
    const d = await r.json();
    const a = d.address || {};
    city = a.city || a.town || a.village || a.suburb || a.neighbourhood || city;
    judet = a.county || a.state || a.region || '';
    if(norm(city).includes('sector')) city = 'Bucuresti';
  } catch(err){}

  layers['Propuneri'].addLayer(L.circleMarker(e.latlng, { radius: 10, color:'#fff', fillColor:'#ff00cc', fillOpacity:1 }));

  const context = analyzeLocalData(e.latlng.lat, e.latlng.lng, city, judet);
  askPerplexity('AnalizeazƒÉ poten»õialul unui locker aici (' + city + ', ' + judet + '): ' + e.latlng.lat + ', ' + e.latlng.lng, context);
});

/* =========================== 16) RESET =========================== */
function resetAll(){
  Object.values(layers).forEach(l => l.clearLayers());
  data.lockers = [];
  data.awbJL = {};
  data.awbJLM = {};
  data.popJL = {};
  detectedMonths = [];
  lockerMarkers = [];

  document.getElementById('aiResponse').style.display = 'none';
  document.getElementById('statusLockers').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('statusAWB').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('statusPop').innerText = 'A»ôteptare fi»ôier...';
  document.getElementById('lockerSearchStatus').innerText = '';

  document.getElementById('totalVal').innerText = '0';
  document.getElementById('criticVal').innerText = '0';
  document.getElementById('warnVal').innerText = '0';
  document.getElementById('okVal').innerText = '0';

  document.getElementById('exportBtn').style.display = 'none';
  LAST_REPORT_TXT = '';
  LAST_REPORT_NAME = 'raport_easybox.txt';

  speak('Resetat.');
}
  </script>
</body>
</html>
